<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Relatório de Presença</title>
    <meta name="description" content="OlharMais - Relatório de Presença por Turma">
    <meta name="theme-color" content="#005ae2">
    
    <!-- Definições preliminares para evitar erros antes do carregamento -->
    <script>
        // Definir funções básicas para evitar erros de "is not defined"
        window.createSupabaseClient = function() { 
            console.warn("Cliente Supabase ainda não está disponível, aguarde carregamento"); 
            return null; 
        };
        window.getSupabaseCredentials = function() { return { url: '', key: '', options: {} }; };
        window._configLoading = true;
    </script>
    
    <!-- Carregamento de configurações da Lambda -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Tela de carregamento inicial
        document.write('<div id="loading-config" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #005ae2; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 20px; color: #005ae2; font-family: Arial, sans-serif;">Carregando configurações...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>');
        
        // IIFE para encapsular todas as variáveis sensíveis e não expor no escopo global
        (function() {
            // Permitir somente um único cliente Supabase
            let _supabaseClient = null;
            let _config = null;
            let _configLoaded = false;
            
            // Interceptar a execução de scripts
            document.addEventListener('DOMContentLoaded', function(e) {
                if (!_configLoaded) {
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // Função para carregar as configurações
            async function carregarConfiguracoes() {
                try {
                    const response = await fetch('https://vzen6sfiqy2f6hhazz4tcb64ka0stezf.lambda-url.us-east-1.on.aws/');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        _config = result.data;
                        
                        // Criar cliente Supabase uma única vez
                        _supabaseClient = supabase.createClient(
                            _config.SUPABASE_URL1,
                            _config.SUPABASE_KEY1,
                            {
                                db: { schema: 'public' },
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                }
                            }
                        );
                        
                        // Substituir as funções de supabase.js pelas nossas versões
                        window.createSupabaseClient = function() {
                            return _supabaseClient;
                        };
                        
                        window.getSupabaseCredentials = function() {
                            return {
                                url: _config.SUPABASE_URL1,
                                key: _config.SUPABASE_KEY1,
                                options: {
                                    db: { schema: 'public' },
                                    auth: {
                                        autoRefreshToken: true,
                                        persistSession: true,
                                        detectSessionInUrl: true
                                    }
                                }
                            };
                        };
                        
                        // Marcar como carregado e liberar a execução
                        _configLoaded = true;
                        window._configLoading = false;
                        
                        // Remover a tela de carregamento
                        document.getElementById('loading-config').style.display = 'none';
                        
                        // Disparar o evento DOMContentLoaded novamente para inicializar a página
                        setTimeout(() => {
                            document.dispatchEvent(new Event('DOMContentLoaded'));
                        }, 100);
                        
                        return true;
                    } else {
                        throw new Error('Falha ao carregar configurações');
                    }
                } catch (error) {
                    document.getElementById('loading-config').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#ff3333" viewBox="0 0 256 256">
                                <path d="M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm-12-80V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0Zm28,40a16,16,0,1,1-16-16A16,16,0,0,1,144,172Z"></path>
                            </svg>
                            <h3 style="color: #ff3333; margin-top: 10px; font-family: Arial, sans-serif;">Erro ao carregar configurações</h3>
                            <p style="margin-top: 10px; font-family: Arial, sans-serif;">Por favor, recarregue a página ou tente novamente mais tarde.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 8px 16px; background-color: #005ae2; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif;">Recarregar página</button>
                        </div>
                    `;
                    return false;
                }
            }
            
            // Inicializar imediatamente
            carregarConfiguracoes();
        })();
    </script>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon.svg">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9',
                        'logo-blue': '#005ae2'
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(180deg, #E6F0FF 0%, #FFFFFF 100%);
            min-height: 100vh;
        }
        
        .logo-olharmais {
            background: linear-gradient(90deg, #005ae2 0%, #3988ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .container {
            max-width: 992px !important;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Ajuste para o navbar mobile */
        body {
            padding-bottom: 60px;
        }
        
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }
        }

        /* Estilos específicos para impressão */
        @media print {
            @page {
                margin: 1.5cm;
                size: A4;
            }

            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-family: 'Inter', Arial, sans-serif !important;
                line-height: 1.4 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .no-print {
                display: none !important;
            }

            .container {
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .report-table {
                width: 100% !important;
                border-collapse: collapse !important;
                page-break-inside: auto !important;
                margin: 0 !important;
            }

            .report-table thead {
                display: table-header-group !important;
            }

            .report-table tfoot {
                display: table-footer-group !important;
            }

            .report-table tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }

            .report-table th,
            .report-table td {
                border: 1px solid #000 !important;
                padding: 8px 4px !important;
                font-size: 11px !important;
                line-height: 1.3 !important;
            }

            .report-table th {
                background-color: #e5e7eb !important;
                font-weight: bold !important;
                text-align: center !important;
            }

            .report-table td:first-child {
                text-align: center !important;
                font-weight: 500 !important;
            }

            .report-header {
                margin-bottom: 20px !important;
                page-break-after: avoid !important;
            }

            .report-footer {
                margin-top: 20px !important;
                page-break-before: avoid !important;
                font-size: 9px !important;
            }

            .logo-olharmais {
                background: none !important;
                color: #000 !important;
                font-size: 28px !important;
                font-weight: bold !important;
            }

            /* Quebras de página estratégicas */
            .page-break {
                page-break-before: always !important;
            }

            .avoid-break {
                page-break-inside: avoid !important;
            }
        }

        /* Estilos para tela */
        .print-only {
            display: none;
        }

        /* Animação de loading */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm py-4 no-print">
        <div class="container mx-auto px-4 flex items-center">
            <h1 class="text-2xl font-bold logo-olharmais">OlharMais</h1>
            <div class="ml-auto flex items-center gap-4">
                <button onclick="window.location.href='cameras_profi.html'" class="text-gray-600 hover:text-primary transition-colors" title="Câmeras">
                    <i class="ph ph-video-camera text-xl"></i>
                </button>
                <button onclick="window.location.href='notificacoes_profi.html'" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="ph ph-bell text-xl"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Voltar (apenas na tela) -->
        <button onclick="history.back()" class="text-primary hover:text-primary-dark mb-6 flex items-center text-sm no-print">
            <i class="ph ph-arrow-left mr-1"></i> Voltar
        </button>
        
        <!-- Cabeçalho -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Relatório de Presença por Turma</h2>
            <p class="text-gray-600">Gere relatórios detalhados por período</p>
        </div>
        
        <!-- Filtros (apenas na tela) -->
        <div class="bg-white rounded-lg shadow p-6 mb-6 no-print">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Data Início -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início</label>
                    <input type="date" id="data-inicio" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none">
                </div>
                
                <!-- Data Fim -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                    <input type="date" id="data-fim" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none">
                </div>
                
                <!-- Botões -->
                <div class="flex items-end gap-2">
                    <button id="gerar-btn" class="flex-1 h-[54px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                        <i class="ph ph-file-text"></i>
                        Gerar Relatório
                    </button>
                    <button id="imprimir-btn" class="h-[54px] bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors px-4 flex items-center justify-center" title="Imprimir">
                        <i class="ph ph-printer"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Relatório -->
        <div id="relatorio" class="bg-white rounded-lg shadow print:shadow-none print:rounded-none">
            <!-- Cabeçalho do Relatório -->
            <div class="report-header p-6 border-b border-gray-200 print:border-b-2 print:border-black">
                <div class="text-center mb-6">
                    <!-- Logo OlharMais -->
                    <div class="mb-6">
                        <h1 class="text-4xl font-bold logo-olharmais mb-2 print:text-black">OlharMais</h1>
                        <p class="text-sm text-gray-500 print:text-gray-700">Sistema de Gestão Escolar</p>
                    </div>
                    
                    <!-- Título do Relatório -->
                    <div class="bg-primary-light print:bg-gray-100 p-4 rounded-lg print:rounded-none mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">RELATÓRIO DIRETOR - COORDENADOR</h2>
                        <div class="text-gray-700 space-y-1">
                            <p><strong>ESCOLA:</strong> <span id="escola-nome" class="font-medium">-</span></p>
                            <p><strong>CIDADE:</strong> <span id="cidade-nome" class="font-medium">-</span></p>
                            <p><strong>PERÍODO:</strong> <span id="periodo-datas" class="font-medium">-</span></p>
                            <p><strong>DATA DE GERAÇÃO:</strong> <span id="data-geracao-header" class="font-medium">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tabela do Relatório -->
            <div class="overflow-x-auto print:overflow-visible">
                <table class="report-table w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50 print:bg-gray-200">
                            <th class="py-4 px-4 text-center font-bold text-gray-800 border border-gray-400 print:border-black print:text-xs">SÉRIE</th>
                            <th class="py-4 px-4 text-center font-bold text-gray-800 border border-gray-400 print:border-black print:text-xs">TURMA</th>
                            <th class="py-4 px-4 text-center font-bold text-gray-800 border border-gray-400 print:border-black print:text-xs">PERÍODO</th>
                            <th class="py-4 px-4 text-center font-bold text-gray-800 border border-gray-400 print:border-black print:text-xs">TOTAL<br/>ALUNOS</th>
                            <th class="py-4 px-4 text-center font-bold text-gray-800 border border-gray-400 print:border-black print:text-xs">ALUNOS<br/>PRESENTES</th>
                            <th class="py-4 px-4 text-center font-bold text-gray-800 border border-gray-400 print:border-black print:text-xs">PERCENTUAL<br/>PRESENÇA</th>
                        </tr>
                    </thead>
                    <tbody id="relatorio-body">
                        <!-- Dados serão inseridos via JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-primary-light print:bg-gray-300 font-bold">
                            <td colspan="3" class="py-4 px-4 text-right border border-gray-400 print:border-black print:text-xs">TOTAIS GERAIS:</td>
                            <td id="total-alunos" class="py-4 px-4 text-center border border-gray-400 print:border-black print:text-xs font-bold">0</td>
                            <td id="total-presentes" class="py-4 px-4 text-center border border-gray-400 print:border-black print:text-xs font-bold">0</td>
                            <td id="media-presenca" class="py-4 px-4 text-center border border-gray-400 print:border-black print:text-xs font-bold text-primary print:text-black">0%</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <!-- Rodapé do Relatório -->
            <div class="report-footer mt-8 p-4 border-t border-gray-300 print:border-t-2 print:border-black print:mt-6">
                <div class="text-center text-gray-600 print:text-black space-y-2">
                    <div class="flex justify-between items-center print:text-xs">
                        <div>
                            <p class="font-medium">OlharMais - Sistema de Gestão Escolar</p>
                            <p class="text-sm">Relatório de Presença por Turma</p>
                        </div>
                        <div class="text-right">
                            <p>Gerado em: <span id="data-geracao-footer" class="font-medium">-</span></p>
                            <p class="text-sm">Dados extraídos em tempo real</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-200 print:border-gray-400">
                        <div class="text-xs text-gray-500 print:text-gray-700 space-y-1">
                            <p><strong>METODOLOGIA DE CÁLCULO:</strong></p>
                            <p>• <strong>Alunos Presentes:</strong> Alunos que registraram pelo menos uma entrada/saída no período selecionado</p>
                            <p>• <strong>Percentual de Presença:</strong> (Alunos Presentes ÷ Total de Alunos) × 100</p>
                            <p>• <strong>Dados por Turma:</strong> Informações detalhadas por série, turma e período</p>
                            <p>• <strong>Fonte dos Dados:</strong> Sistema de reconhecimento facial OlharMais em tempo real</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Toast Component -->
    <div id="toast" class="fixed top-4 right-4 z-[9999] hidden no-print">
        <div class="px-4 py-2 rounded-lg shadow-lg text-white font-medium"></div>
    </div>
    
    <!-- Remover navbar do relatório - não é necessária -->
    
    <script>
        // Toast Component
        const Toast = {
            element: document.getElementById('toast'),
            timeoutId: null,
            
            show(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                clearTimeout(this.timeoutId);
                
                const inner = this.element.querySelector('div');
                inner.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                inner.textContent = message;
                
                this.element.classList.remove('hidden');
                
                this.timeoutId = setTimeout(() => {
                    this.element.classList.add('hidden');
                }, 3000);
            }
        };

        // Estado da aplicação
        let estadoApp = {
            turmasPermitidas: [],
            dadosRelatorio: [],
            filtros: {
                dataInicio: '',
                dataFim: ''
            },
            escolaInfo: null
        };

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Verificar autenticação
                const userSession = localStorage.getItem('user_session');
                if (!userSession) {
                    window.location.href = '/auth.html';
                    return;
                }

                // Configurar data atual
                const hoje = new Date();
                const inicio = new Date();
                inicio.setDate(hoje.getDate() - 30); // Últimos 30 dias por padrão
                
                document.getElementById('data-inicio').value = inicio.toISOString().split('T')[0];
                document.getElementById('data-fim').value = hoje.toISOString().split('T')[0];
                
                estadoApp.filtros.dataInicio = inicio.toISOString().split('T')[0];
                estadoApp.filtros.dataFim = hoje.toISOString().split('T')[0];

                // Configurar event listeners
                configurarEventListeners();
                
                // Carregar dados iniciais
                await carregarDadosRelatorio();
                
            } catch (error) {
                console.error('Erro ao inicializar página:', error);
                Toast.show('Erro ao carregar dados', 'error');
            }
        });

        // Configurar event listeners
        function configurarEventListeners() {
            // Filtros de data
            document.getElementById('data-inicio').addEventListener('change', (e) => {
                estadoApp.filtros.dataInicio = e.target.value;
            });

            document.getElementById('data-fim').addEventListener('change', (e) => {
                estadoApp.filtros.dataFim = e.target.value;
            });

            // Botão gerar relatório
            document.getElementById('gerar-btn').addEventListener('click', () => {
                carregarDadosRelatorio();
            });

            // Botão imprimir
            document.getElementById('imprimir-btn').addEventListener('click', () => {
                window.print();
            });
        }

        // Carregar dados do relatório
        async function carregarDadosRelatorio() {
            try {
                const gerarBtn = document.getElementById('gerar-btn');
                const btnTexto = gerarBtn.innerHTML;
                
                // Mostrar loading no botão
                gerarBtn.disabled = true;
                gerarBtn.innerHTML = '<i class="ph ph-spinner-gap animate-spin"></i> Gerando...';
                
                const supabase = createSupabaseClient();
                const { dataInicio, dataFim } = estadoApp.filtros;
                
                if (!dataInicio || !dataFim) {
                    Toast.show('Selecione o período desejado', 'warning');
                    gerarBtn.disabled = false;
                    gerarBtn.innerHTML = btnTexto;
                    return;
                }

                // Validar se a data de início não é maior que a data de fim
                if (new Date(dataInicio) > new Date(dataFim)) {
                    Toast.show('A data de início não pode ser maior que a data de fim', 'warning');
                    gerarBtn.disabled = false;
                    gerarBtn.innerHTML = btnTexto;
                    return;
                }

                // Verificar permissões do usuário
                const userSession = JSON.parse(localStorage.getItem('user_session'));
                
                // Buscar permissões do profissional
                const [
                    { data: permissoesEscola, error: errorPermissoesEscola },
                    { data: permissoesTurma, error: errorPermissoesTurma }
                ] = await Promise.all([
                    supabase.from('permissoes_escola').select('escola_id').eq('usuario_id', userSession.id),
                    supabase.from('permissoes_turma').select('turma_id').eq('usuario_id', userSession.id)
                ]);
                
                if (errorPermissoesEscola || errorPermissoesTurma) {
                    console.error('Erro ao buscar permissões:', {
                        errorPermissoesEscola, 
                        errorPermissoesTurma
                    });
                    throw new Error('Erro ao buscar permissões');
                }

                // Determinar as turmas permitidas
                let turmasPermitidas = [];
                let escolaId = null;

                // Caso 1: Permissão por escola - acesso a todas as turmas da escola
                if (permissoesEscola && permissoesEscola.length > 0) {
                    escolaId = permissoesEscola[0].escola_id; // Assumindo uma escola por profissional
                    
                    // Buscar todas as turmas da escola
                    const { data: turmas, error: turmasError } = await supabase
                        .from('turmas')
                        .select('id')
                        .eq('escola_id', escolaId);
                    
                    if (turmasError) throw turmasError;
                    turmasPermitidas = turmas.map(t => t.id);
                } 
                // Caso 2: Permissão por turma - acesso apenas às turmas específicas
                else if (permissoesTurma && permissoesTurma.length > 0) {
                    turmasPermitidas = permissoesTurma.map(p => p.turma_id);
                    
                    // Buscar a escola da primeira turma para informações
                    if (turmasPermitidas.length > 0) {
                        const { data: turmaInfo } = await supabase
                            .from('turmas')
                            .select('escola_id')
                            .eq('id', turmasPermitidas[0])
                            .single();
                        escolaId = turmaInfo?.escola_id;
                    }
                }

                if (!turmasPermitidas.length || !escolaId) {
                    Toast.show('Nenhuma turma encontrada para seu usuário', 'warning');
                    gerarBtn.disabled = false;
                    gerarBtn.innerHTML = btnTexto;
                    return;
                }

                // Buscar informações da escola
                const { data: escola, error: escolaError } = await supabase
                    .from('escolas')
                    .select('nome, cidade_id')
                    .eq('id', escolaId)
                    .single();

                if (escolaError) throw escolaError;

                // Buscar nome da cidade
                const { data: cidade, error: cidadeError } = await supabase
                    .from('cidades')
                    .select('nome')
                    .eq('id', escola.cidade_id)
                    .single();

                if (cidadeError) throw cidadeError;

                // Atualizar cabeçalho do relatório
                const dataGeracaoFormatada = new Date().toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                document.getElementById('escola-nome').textContent = escola.nome;
                document.getElementById('cidade-nome').textContent = cidade.nome;
                document.getElementById('periodo-datas').textContent = `${formatarData(dataInicio)} a ${formatarData(dataFim)}`;
                document.getElementById('data-geracao-header').textContent = dataGeracaoFormatada;
                document.getElementById('data-geracao-footer').textContent = dataGeracaoFormatada;

                // Buscar dados das turmas
                const { data: turmasInfo, error: turmasInfoError } = await supabase
                    .from('turmas')
                    .select('id, nome, periodo, serie_id')
                    .in('id', turmasPermitidas);

                if (turmasInfoError) throw turmasInfoError;

                // Buscar séries para mapear com as turmas
                const seriesIds = [...new Set(turmasInfo?.map(t => t.serie_id).filter(Boolean))];
                const { data: series, error: seriesError } = await supabase
                    .from('series')
                    .select('id, nome')
                    .in('id', seriesIds);

                if (seriesError) throw seriesError;

                // Criar mapa de séries por ID
                const seriesMap = {};
                series?.forEach(serie => {
                    seriesMap[serie.id] = serie.nome;
                });

                // Função para extrair número da série (1º Ano -> 1, 2º Ano -> 2, etc.)
                function extrairNumeroSerie(nomeSerie) {
                    if (!nomeSerie) return 999; // Colocar séries sem nome no final
                    
                    const match = nomeSerie.match(/(\d+)/);
                    return match ? parseInt(match[1]) : 999;
                }

                // Ordenar turmasInfo por série (numericamente) e depois por nome da turma
                turmasInfo.sort((a, b) => {
                    const serieA = seriesMap[a.serie_id] || '';
                    const serieB = seriesMap[b.serie_id] || '';
                    
                    const numeroA = extrairNumeroSerie(serieA);
                    const numeroB = extrairNumeroSerie(serieB);
                    
                    // Primeiro ordenar por número da série
                    if (numeroA !== numeroB) {
                        return numeroA - numeroB;
                    }
                    
                    // Se mesmo número de série, ordenar por nome da turma
                    return a.nome.localeCompare(b.nome);
                });

                console.log('DEBUG: Turmas encontradas (ordenadas por série):', turmasInfo?.map(t => `${t.id} - ${t.nome} (${t.periodo}) - Série: ${seriesMap[t.serie_id] || 'N/A'}`));

                let dadosTurmas = [];
                let totais = {
                    alunos: 0,
                    presentes: 0
                };

                // Sets para contar totais únicos globais
                let todosAlunosUnicos = new Set();
                let alunosPresentesUnicos = new Set();

                for (const turma of turmasInfo) {
                    console.log(`[${turma.nome}] Processando turma ${turma.id}`);

                    // Buscar total de alunos da turma
                    const { data: alunos, error: alunosError } = await supabase
                        .from('alunos')
                        .select('id, nome_completo')
                        .eq('turma', turma.id)
                        .is('soft_delete', null);

                    if (alunosError) {
                        console.error(`Erro ao buscar alunos da turma ${turma.id}:`, alunosError);
                        continue;
                    }

                    const totalAlunosTurma = alunos?.length || 0;

                    // Adicionar alunos ao set global (evita duplicação entre turmas)
                    alunos?.forEach(aluno => {
                        todosAlunosUnicos.add(aluno.nome_completo);
                    });

                    // Se não há alunos na turma, pular
                    if (!alunos || alunos.length === 0) {
                        console.log(`[${turma.nome}] Nenhum aluno encontrado, pulando.`);
                        continue;
                    }

                    // Buscar presença no período - NOVA ABORDAGEM: filtrar por nomes dos alunos da turma
                    console.log(`[${turma.nome}] Buscando presença de ${dataInicio} a ${dataFim}`);
                    console.log(`[${turma.nome}] DEBUG: Filtrando por ${alunos.length} alunos específicos da turma ID ${turma.id}`);
                    
                    const nomesAlunos = alunos.map(a => a.nome_completo);
                    
                    const { data: presencaTurma, error: errorPresencaTurma } = await supabase
                        .from('view_alunos_logs')
                        .select('nome_aluno, hora_check, turma_nome')
                        .in('nome_aluno', nomesAlunos)  // ← Filtrar pelos nomes dos alunos da turma
                        .gte('hora_check', dataInicio + 'T00:00:00')
                        .lte('hora_check', dataFim + 'T23:59:59');

                    if (errorPresencaTurma) {
                        console.error(`Erro ao buscar presença da turma ${turma.nome}:`, errorPresencaTurma);
                        continue;
                    }

                    console.log(`[${turma.nome}] Encontrados ${presencaTurma?.length || 0} registros de presença`);
                    if (presencaTurma && presencaTurma.length > 0) {
                        console.log(`[${turma.nome}] DEBUG: Primeiros 3 registros:`, presencaTurma.slice(0, 3));
                        const nomesSample = presencaTurma.slice(0, 10).map(log => log.nome_aluno);
                        console.log(`[${turma.nome}] DEBUG: Nomes de alunos (sample):`, nomesSample);
                    }

                    // Contar alunos únicos que tiveram presença na turma (apenas desta turma)
                    const alunosUnicosNaTurma = new Set();
                    presencaTurma?.forEach(log => {
                        alunosUnicosNaTurma.add(log.nome_aluno);
                    });
                    
                    // Adicionar ao set global separadamente (para totais gerais)
                    presencaTurma?.forEach(log => {
                        alunosPresentesUnicos.add(log.nome_aluno);
                    });
                    
                    const totalAlunosComPresenca = alunosUnicosNaTurma.size;
                    const percentualPresenca = totalAlunosTurma > 0 ? (totalAlunosComPresenca / totalAlunosTurma) * 100 : 0;

                    console.log(`[${turma.nome}] Total alunos: ${totalAlunosTurma}, Com presença: ${totalAlunosComPresenca}, Percentual: ${percentualPresenca.toFixed(1)}%`);
                    console.log(`[${turma.nome}] DEBUG: Registros brutos: ${presencaTurma?.length || 0}, Alunos únicos: ${alunosUnicosNaTurma.size}`);
                    console.log(`[${turma.nome}] DEBUG: Alunos únicos na turma:`, Array.from(alunosUnicosNaTurma));

                    // Usar a série da tabela series em vez de extrair do nome
                    const serieNome = seriesMap[turma.serie_id] || 'N/A';
                    const nomeTurma = turma.nome; // Manter o nome completo da turma

                    console.log(`[${turma.nome}] DEBUG: Série encontrada: "${serieNome}" (ID: ${turma.serie_id})`);

                    dadosTurmas.push({
                        serie: serieNome,
                        turma: nomeTurma,
                        periodo: turma.periodo || 'N/A',
                        totalAlunos: totalAlunosTurma,
                        totalPresentes: totalAlunosComPresenca,
                        percentualPresenca: percentualPresenca.toFixed(1)
                    });
                }

                // Calcular totais únicos globais
                totais.alunos = todosAlunosUnicos.size;
                totais.presentes = alunosPresentesUnicos.size;

                console.log(`TOTAIS ÚNICOS GLOBAIS: ${totais.alunos} alunos, ${totais.presentes} presentes, ${((totais.presentes / totais.alunos) * 100).toFixed(1)}%`);

                // Verificar se há dados para o relatório
                if (dadosTurmas.length === 0) {
                    // Renderizar mensagem de que não há dados
                    const tbody = document.getElementById('relatorio-body');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="py-8 text-center text-gray-500">
                                <i class="ph ph-file-x text-4xl mb-2 block"></i>
                                <p class="font-medium">Nenhum dado encontrado para o período selecionado</p>
                                <p class="text-sm">Tente selecionar um período diferente ou verifique se existem registros de presença.</p>
                            </td>
                        </tr>
                    `;
                    
                    // Zerar totais
                    document.getElementById('total-alunos').textContent = '0';
                    document.getElementById('total-presentes').textContent = '0';
                    document.getElementById('media-presenca').textContent = '0%';
                    
                    Toast.show('Nenhum dado encontrado para o período selecionado', 'warning');
                } else {
                    // Renderizar tabela
                    renderizarTabela(dadosTurmas);

                    // Atualizar totais
                    document.getElementById('total-alunos').textContent = totais.alunos;
                    document.getElementById('total-presentes').textContent = totais.presentes;
                    document.getElementById('media-presenca').textContent = 
                        totais.alunos > 0 ? 
                        ((totais.presentes / totais.alunos) * 100).toFixed(1) + '%' : 
                        '0%';

                    Toast.show('Relatório gerado com sucesso!', 'success');
                }

            } catch (error) {
                console.error('Erro ao carregar dados do relatório:', error);
                Toast.show('Erro ao gerar relatório', 'error');
            } finally {
                // Restaurar botão
                const gerarBtn = document.getElementById('gerar-btn');
                gerarBtn.disabled = false;
                gerarBtn.innerHTML = '<i class="ph ph-file-text"></i> Gerar Relatório';
            }
        }

        // Renderizar tabela do relatório
        function renderizarTabela(dados) {
            const tbody = document.getElementById('relatorio-body');
            tbody.innerHTML = '';

            dados.forEach((dado, index) => {
                const tr = document.createElement('tr');
                tr.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} print:bg-white hover:bg-blue-50 print:hover:bg-white avoid-break`;
                
                // Determinar cor do percentual
                const percentual = parseFloat(dado.percentualPresenca);
                let corPercentual = 'text-gray-600';
                if (percentual >= 90) corPercentual = 'text-green-600';
                else if (percentual >= 75) corPercentual = 'text-yellow-600';
                else if (percentual >= 50) corPercentual = 'text-orange-600';
                else corPercentual = 'text-red-600';
                
                tr.innerHTML = `
                    <td class="py-3 px-4 text-center border border-gray-400 print:border-black print:text-xs font-medium">${dado.serie}</td>
                    <td class="py-3 px-4 text-center border border-gray-400 print:border-black print:text-xs font-medium">${dado.turma}</td>
                    <td class="py-3 px-4 text-center border border-gray-400 print:border-black print:text-xs">${dado.periodo}</td>
                    <td class="py-3 px-4 text-center border border-gray-400 print:border-black print:text-xs">${dado.totalAlunos}</td>
                    <td class="py-3 px-4 text-center border border-gray-400 print:border-black print:text-xs text-green-600 print:text-black font-medium">${dado.totalPresentes}</td>
                    <td class="py-3 px-4 text-center border border-gray-400 print:border-black print:text-xs ${corPercentual} print:text-black font-bold">${dado.percentualPresenca}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Funções auxiliares
        function formatarData(data) {
            return new Date(data).toLocaleDateString('pt-BR');
        }
    </script>
</body>
</html> 