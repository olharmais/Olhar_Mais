<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Frequência por Escola</title>
    <meta name="description" content="OlharMais - Controle de frequência por escola">
    <meta name="theme-color" content="#005ae2">
    
    <!-- Definições preliminares para evitar erros antes do carregamento -->
    <script>
        // Definir funções básicas para evitar erros de "is not defined"
        window.createSupabaseClient = function() { 
            console.warn("Cliente Supabase ainda não está disponível, aguarde carregamento"); 
            return null; 
        };
        window.getSupabaseCredentials = function() { return { url: '', key: '', options: {} }; };
        window.getWhatsappApiUrl = function() { return ''; };
        window.getWhatsappApiKey = function() { return ''; };
        window.limparSessaoEsair = function() { window.location.href = '/auth.html?logout=true'; };
        window.logout = window.limparSessaoEsair;
        window._configLoading = true;
    </script>
    
    <!-- Carregamento de configurações da Lambda -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Tela de carregamento inicial
        document.write('<div id="loading-config" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #005ae2; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 20px; color: #005ae2; font-family: Arial, sans-serif;">Carregando configurações...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>');
        
        // IIFE para encapsular todas as variáveis sensíveis e não expor no escopo global
        (function() {
            // Permitir somente um único cliente Supabase
            let _supabaseClient = null;
            let _config = null;
            let _configLoaded = false;
            
            // Interceptar a execução de scripts
            document.addEventListener('DOMContentLoaded', function(e) {
                if (!_configLoaded) {
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // Função para carregar as configurações
            async function carregarConfiguracoes() {
                try {
                    const response = await fetch('https://vzen6sfiqy2f6hhazz4tcb64ka0stezf.lambda-url.us-east-1.on.aws/');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        _config = result.data;
                        
                        // Criar cliente Supabase uma única vez
                        _supabaseClient = supabase.createClient(
                            _config.SUPABASE_URL1,
                            _config.SUPABASE_KEY1,
                            {
                                db: { schema: 'public' },
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                }
                            }
                        );
                        
                        // Substituir as funções de supabase.js pelas nossas versões
                        window.createSupabaseClient = function() {
                            return _supabaseClient;
                        };
                        
                        window.getSupabaseCredentials = function() {
                            return {
                                url: _config.SUPABASE_URL1,
                                key: _config.SUPABASE_KEY1,
                                options: {
                                    db: { schema: 'public' },
                                    auth: {
                                        autoRefreshToken: true,
                                        persistSession: true,
                                        detectSessionInUrl: true
                                    }
                                }
                            };
                        };
                        
                        // Marcar como carregado e liberar a execução
                        _configLoaded = true;
                        window._configLoading = false;
                        
                        // Remover a tela de carregamento
                        document.getElementById('loading-config').style.display = 'none';
                        
                        // Disparar o evento DOMContentLoaded novamente para inicializar a página
                        setTimeout(() => {
                            document.dispatchEvent(new Event('DOMContentLoaded'));
                        }, 100);
                        
                        return true;
                    } else {
                        throw new Error('Falha ao carregar configurações');
                    }
                } catch (error) {
                    document.getElementById('loading-config').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#ff3333" viewBox="0 0 256 256">
                                <path d="M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm-12-80V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0Zm28,40a16,16,0,1,1-16-16A16,16,0,0,1,144,172Z"></path>
                            </svg>
                            <h3 style="color: #ff3333; margin-top: 10px; font-family: Arial, sans-serif;">Erro ao carregar configurações</h3>
                            <p style="margin-top: 10px; font-family: Arial, sans-serif;">Por favor, recarregue a página ou tente novamente mais tarde.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 8px 16px; background-color: #005ae2; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif;">Recarregar página</button>
                        </div>
                    `;
                    return false;
                }
            }
            
            // Inicializar imediatamente
            carregarConfiguracoes();
        })();
    </script>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon.svg">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9',
                        'logo-blue': '#005ae2'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(180deg, #E6F0FF 0%, #FFFFFF 100%);
            min-height: 100vh;
        }
        
        .logo-olharmais {
            background: linear-gradient(90deg, #005ae2 0%, #3988ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .container {
            max-width: 992px !important;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Ajuste para o navbar mobile */
        body {
            padding-bottom: 60px;
        }
        
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }
        }

        /* Estilo personalizado para inputs de data */
        input[type="date"] {
            position: relative;
            padding-right: 20px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 10px;
            color: #005ae2;
            cursor: pointer;
        }
    </style>
</head>
<body class="font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex items-center">
            <h1 class="text-2xl font-bold logo-olharmais">OlharMais</h1>
            <div class="ml-auto flex items-center gap-4">
                <button onclick="window.location.href='cameras_gestor.html'" class="text-gray-600 hover:text-primary transition-colors" title="Câmeras">
                    <i class="ph ph-video-camera text-xl"></i>
                </button>
                <button onclick="window.location.href='notificacoes_gestor.html'" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="ph ph-bell text-xl"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Cabeçalho -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Frequência por Escola</h2>
            <p class="text-gray-600">Visualize a frequência dos alunos por escola em uma data específica</p>
        </div>
        
        <!-- Filtros -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Escola -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Escola</label>
                    <select id="escola-select" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none">
                        <option value="">Todas as escolas</option>
                    </select>
                </div>
                
                <!-- Data -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                    <input type="date" id="data-consulta" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none">
                </div>
                
                <!-- Botão Filtrar -->
                <div class="flex items-end">
                    <button id="filtrar-btn" class="w-full h-[54px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                        <i class="ph ph-funnel"></i>
                        Filtrar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Resumo Geral -->
        <div id="resumo-geral" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Total de Escolas -->
            <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="ph ph-buildings text-xl text-blue-600"></i>
            </div>
                    <span class="text-xs text-blue-600/70">Total</span>
                </div>
                <h3 id="total-escolas" class="text-2xl font-bold text-gray-800">0</h3>
                <p class="text-sm text-blue-600">Escolas</p>
                </div>
            
            <!-- Total de Alunos -->
            <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-yellow-500">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="ph ph-student text-xl text-yellow-600"></i>
            </div>
                    <span class="text-xs text-yellow-600/70">Total</span>
            </div>
                <h3 id="total-alunos" class="text-2xl font-bold text-gray-800">0</h3>
                <p class="text-sm text-yellow-600">Alunos</p>
        </div>
        
            <!-- Alunos Presentes -->
            <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-green-500">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="ph ph-check-circle text-xl text-green-600"></i>
                    </div>
                    <span class="text-xs text-green-600/70">Presentes</span>
                </div>
                <h3 id="total-presentes" class="text-2xl font-bold text-gray-800">0</h3>
                <p class="text-sm text-green-600">Alunos</p>
                        </div>
                        
            <!-- Taxa de Presença -->
            <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-purple-500">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="ph ph-chart-pie text-xl text-purple-600"></i>
                    </div>
                    <span class="text-xs text-purple-600/70">Taxa</span>
                </div>
                <h3 id="taxa-presenca" class="text-2xl font-bold text-gray-800">0%</h3>
                <p class="text-sm text-purple-600">Presença</p>
                </div>
            </div>
            
        <!-- Lista de Escolas -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Detalhes por Escola</h3>
                <p class="text-sm text-gray-600 mt-1">Clique em uma escola para ver mais detalhes</p>
            </div>
            
            <div id="lista-escolas" class="divide-y divide-gray-200">
                <!-- Escolas serão inseridas aqui -->
            </div>
        </div>
        
        <!-- Estados da página -->
        <div id="loading" class="hidden">
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
            </div>
        </div>
        
        <div id="empty-state" class="hidden">
            <div class="text-center py-12 text-gray-600 bg-white rounded-lg shadow p-6">
                <i class="ph ph-calendar-x text-5xl text-gray-400 mb-4"></i>
                <p class="text-xl font-medium">Nenhum dado encontrado</p>
                <p class="mt-2">Tente ajustar os filtros ou selecionar um período diferente</p>
            </div>
        </div>
        
        <div id="no-permission" class="hidden">
            <div class="text-center py-12 text-gray-600 bg-white rounded-lg shadow p-6">
                <i class="ph ph-lock text-5xl text-gray-400 mb-4"></i>
                <p class="text-xl font-medium">Sem permissão de acesso</p>
                <p class="mt-2">Você não tem permissão para visualizar dados de frequência</p>
            </div>
        </div>
    </main>
    
    <!-- Toast Component -->
    <div id="toast" class="fixed top-4 right-4 z-[9999] hidden">
        <div class="px-4 py-2 rounded-lg shadow-lg text-white font-medium"></div>
    </div>
    
    <!-- Navbar JavaScript -->
    <script src="botoes_gestor.js" type="module"></script>
    
    <script>
        // Toast Component
        const Toast = {
            element: document.getElementById('toast'),
            timeoutId: null,
            
            show(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                clearTimeout(this.timeoutId);
                
                const inner = this.element.querySelector('div');
                inner.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                inner.textContent = message;
                
                this.element.classList.remove('hidden');
                
                this.timeoutId = setTimeout(() => {
                    this.element.classList.add('hidden');
                }, 3000);
            },
            
            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            warning(message) { this.show(message, 'warning'); },
            info(message) { this.show(message, 'info'); }
        };
    
        // Estado da aplicação
        let estadoApp = {
            escolasPermitidas: [],
            dadosFrequencia: [],
            filtros: {
                escolaId: '',
                dataConsulta: ''
            }
        };

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Verificar autenticação
                const userSession = localStorage.getItem('user_session');
                if (!userSession) {
                    window.location.href = '/auth.html';
                    return;
                }
                
                const userData = JSON.parse(userSession);
                if (userData.tipo !== 'GESTOR') {
                    Toast.error('Acesso não autorizado');
                    setTimeout(() => window.location.href = '/auth.html', 2000);
                    return;
                }
                
                // Configurar data padrão (hoje)
                const hoje = new Date();
                
                document.getElementById('data-consulta').value = hoje.toISOString().split('T')[0];
                
                estadoApp.filtros.dataConsulta = hoje.toISOString().split('T')[0];
                
                // Carregar dados iniciais
                await carregarEscolas();
                await carregarDadosFrequencia();
                
                // Configurar event listeners
                configurarEventListeners();
                
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                Toast.error('Erro ao carregar a página');
            }
        });
        
        // Carregar escolas permitidas
        async function carregarEscolas() {
            try {
                const userSession = JSON.parse(localStorage.getItem('user_session'));
                const supabase = createSupabaseClient();
                
                // Buscar permissões do usuário
                const [
                    { data: permissoesCidade },
                    { data: permissoesEscola },
                    { data: permissoesTurma }
                ] = await Promise.all([
                    supabase.from('permissoes_cidade').select('cidade_id').eq('usuario_id', userSession.id),
                    supabase.from('permissoes_escola').select('escola_id').eq('usuario_id', userSession.id),
                    supabase.from('permissoes_turma').select('turma_id').eq('usuario_id', userSession.id)
                ]);

                let escolasPermitidas = [];

                // Determinar escolas baseado no nível de permissão
                if (permissoesCidade?.length > 0) {
                    // Acesso por cidade - todas as escolas das cidades
                    const { data: escolas } = await supabase
                            .from('escolas')
                            .select('id, nome, cidade_id')
                        .in('cidade_id', permissoesCidade.map(p => p.cidade_id))
                            .is('soft_delete', null)
                            .order('nome');
                        
                    escolasPermitidas = escolas || [];
                    
                } else if (permissoesEscola?.length > 0) {
                    // Acesso por escola específica
                    const { data: escolas } = await supabase
                            .from('escolas')
                            .select('id, nome, cidade_id')
                        .in('id', permissoesEscola.map(p => p.escola_id))
                            .is('soft_delete', null)
                            .order('nome');
                        
                    escolasPermitidas = escolas || [];

                } else if (permissoesTurma?.length > 0) {
                    // Acesso por turma - escolas das turmas permitidas
                        const { data: turmas } = await supabase
                            .from('turmas')
                            .select('escola_id')
                        .in('id', permissoesTurma.map(p => p.turma_id));

                        if (turmas?.length > 0) {
                            const escolasIds = [...new Set(turmas.map(t => t.escola_id))];
                        const { data: escolas } = await supabase
                                .from('escolas')
                                .select('id, nome, cidade_id')
                                .in('id', escolasIds)
                                .is('soft_delete', null)
                                .order('nome');
                            
                        escolasPermitidas = escolas || [];
                        }
                }

                if (escolasPermitidas.length === 0) {
                    document.getElementById('no-permission').classList.remove('hidden');
                    return;
                }

                estadoApp.escolasPermitidas = escolasPermitidas;

                // Preencher select de escolas
                const escolaSelect = document.getElementById('escola-select');
                escolaSelect.innerHTML = '<option value="">Todas as escolas</option>';

                escolasPermitidas.forEach(escola => {
                    const option = document.createElement('option');
                    option.value = escola.id;
                    option.textContent = escola.nome;
                    escolaSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar escolas:', error);
                Toast.error('Erro ao carregar escolas');
            }
        }
        
        // Carregar dados de frequência
        async function carregarDadosFrequencia() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('empty-state').classList.add('hidden');
                
                const supabase = createSupabaseClient();
                const { dataConsulta, escolaId } = estadoApp.filtros;
                
                if (!dataConsulta) {
                    Toast.warning('Selecione a data desejada');
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }

                // Filtrar escolas baseado na seleção
                let escolasParaConsulta = estadoApp.escolasPermitidas;
                if (escolaId) {
                    escolasParaConsulta = estadoApp.escolasPermitidas.filter(e => e.id.toString() === escolaId);
                }

                if (escolasParaConsulta.length === 0) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }

                let resumoGeral = {
                    totalEscolas: escolasParaConsulta.length,
                    totalAlunos: 0,
                    totalPresentes: 0,
                    taxaPresenca: 0
                };

                const dadosEscolas = [];

                // Para cada escola, buscar dados de frequência
                for (const escola of escolasParaConsulta) {
                    // Buscar cidade da escola
                    const { data: cidade } = await supabase
                        .from('cidades')
                        .select('nome')
                        .eq('id', escola.cidade_id)
                        .single();

                    // Buscar turmas da escola
                    const { data: turmas } = await supabase
                        .from('turmas')
                        .select('id')
                        .eq('escola_id', escola.id);

                    if (!turmas || turmas.length === 0) {
                        dadosEscolas.push({
                            escola: escola,
                            cidade: cidade?.nome || 'Cidade não encontrada',
                            totalAlunos: 0,
                            totalPresentes: 0,
                            taxaPresenca: 0,
                            turmas: 0
                        });
                        continue;
                    }

                    const turmasIds = turmas.map(t => t.id);

                    // Buscar total de alunos da escola
                    const { data: alunos } = await supabase
                        .from('alunos')
                        .select('id')
                        .in('turma', turmasIds)
                        .is('soft_delete', null);

                    const totalAlunosEscola = alunos?.length || 0;

                    // Buscar presença na data específica
                    const { data: presencaEscola } = await supabase
                        .from('view_alunos_logs')
                        .select('nome_aluno, turma')
                        .eq('nome_colégio', escola.nome)
                        .gte('hora_check', dataConsulta + 'T00:00:00')
                        .lte('hora_check', dataConsulta + 'T23:59:59');

                    // Contar alunos únicos presentes
                    const alunosUnicosPorTurma = presencaEscola?.reduce((acc, log) => {
                        if (!acc[log.turma]) {
                            acc[log.turma] = new Set();
                        }
                        acc[log.turma].add(log.nome_aluno);
                        return acc;
                    }, {});

                    let presentesEscola = 0;
                    if (alunosUnicosPorTurma) {
                        Object.values(alunosUnicosPorTurma).forEach(turmaSet => {
                            presentesEscola += turmaSet.size;
                        });
                    }

                    const taxaPresencaEscola = totalAlunosEscola > 0 
                        ? (presentesEscola / totalAlunosEscola * 100) 
                        : 0;

                    dadosEscolas.push({
                        escola: escola,
                        cidade: cidade?.nome || 'Cidade não encontrada',
                        totalAlunos: totalAlunosEscola,
                        totalPresentes: presentesEscola,
                        taxaPresenca: taxaPresencaEscola,
                        turmas: turmas.length
                    });

                    // Somar ao resumo geral
                    resumoGeral.totalAlunos += totalAlunosEscola;
                    resumoGeral.totalPresentes += presentesEscola;
                }

                // Calcular taxa geral de presença
                resumoGeral.taxaPresenca = resumoGeral.totalAlunos > 0 
                    ? (resumoGeral.totalPresentes / resumoGeral.totalAlunos * 100) 
                    : 0;

                estadoApp.dadosFrequencia = dadosEscolas;

                // Atualizar interface
                atualizarResumoGeral(resumoGeral);
                renderizarListaEscolas(dadosEscolas);

                document.getElementById('loading').classList.add('hidden');
                
                if (dadosEscolas.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados de frequência:', error);
                Toast.error('Erro ao carregar dados');
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        // Atualizar resumo geral
        function atualizarResumoGeral(resumo) {
            document.getElementById('total-escolas').textContent = resumo.totalEscolas;
            document.getElementById('total-alunos').textContent = resumo.totalAlunos.toLocaleString();
            document.getElementById('total-presentes').textContent = resumo.totalPresentes.toLocaleString();
            document.getElementById('taxa-presenca').textContent = resumo.taxaPresenca.toFixed(1) + '%';
        }

        // Renderizar lista de escolas
        function renderizarListaEscolas(dadosEscolas) {
            const container = document.getElementById('lista-escolas');
            container.innerHTML = '';
            
            if (dadosEscolas.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-500">
                        <i class="ph ph-buildings text-4xl mb-2"></i>
                        <p>Nenhuma escola encontrada</p>
                    </div>
                `;
                return;
            }

            dadosEscolas.forEach(dados => {
                const escolaDiv = document.createElement('div');
                escolaDiv.className = 'p-6 hover:bg-gray-50 transition-colors cursor-pointer';
                
                escolaDiv.innerHTML = `
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2">
                                <h4 class="text-lg font-semibold text-gray-800">${dados.escola.nome}</h4>
                                <span class="text-sm text-gray-500">${dados.cidade}</span>
                </div>
                            <div class="flex items-center gap-4 sm:gap-6 text-sm text-gray-600">
                    <div class="flex items-center gap-1">
                                    <i class="ph ph-users-three text-gray-500"></i>
                                    <span>${dados.turmas} turmas</span>
                    </div>
                    <div class="flex items-center gap-1">
                                    <i class="ph ph-student text-gray-500"></i>
                                    <span>${dados.totalAlunos} alunos</span>
                    </div>
                </div>
                            </div>
                        <div class="flex items-center justify-between sm:justify-end gap-4 sm:gap-6">
                            <div class="text-center">
                                <div class="text-xl sm:text-2xl font-bold text-green-600">${dados.totalPresentes}</div>
                                <div class="text-xs sm:text-sm text-gray-500">Presentes</div>
                            </div>
                            <div class="text-center">
                                <div class="text-xl sm:text-2xl font-bold text-red-600">${dados.totalAlunos - dados.totalPresentes}</div>
                                <div class="text-xs sm:text-sm text-gray-500">Ausentes</div>
                        </div>
                            <div class="text-center">
                                <div class="text-xl sm:text-2xl font-bold text-primary">${dados.taxaPresenca.toFixed(1)}%</div>
                                <div class="text-xs sm:text-sm text-gray-500">Taxa</div>
                            </div>
                            <div class="text-primary">
                                <i class="ph ph-caret-right text-xl"></i>
                            </div>
                        </div>
                    </div>
                `;

                // Adicionar evento de clique para ver detalhes
                escolaDiv.addEventListener('click', () => {
                    // Implementar visualização de detalhes se necessário
                    console.log('Ver detalhes da escola:', dados.escola.nome);
                    Toast.info(`Detalhes de ${dados.escola.nome} - ${dados.totalPresentes}/${dados.totalAlunos} presentes`);
                });
                
                container.appendChild(escolaDiv);
            });
        }
        
        // Configurar event listeners
        function configurarEventListeners() {
            // Filtro por escola
            document.getElementById('escola-select').addEventListener('change', (e) => {
                estadoApp.filtros.escolaId = e.target.value;
            });

            // Filtro de data
            document.getElementById('data-consulta').addEventListener('change', (e) => {
                estadoApp.filtros.dataConsulta = e.target.value;
            });

            // Botão filtrar
            document.getElementById('filtrar-btn').addEventListener('click', () => {
                carregarDadosFrequencia();
            });

            // Enter no campo de data
            document.getElementById('data-consulta').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') carregarDadosFrequencia();
            });
        }
    </script>
</body>
</html> 