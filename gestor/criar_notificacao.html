<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Criar Conteúdo</title>
    <meta name="description" content="OlharMais - Criar Stories e Comunicados">
    <meta name="theme-color" content="#005ae2">
    
    <!-- Definições preliminares para evitar erros antes do carregamento -->
    <script>
        // Definir funções básicas para evitar erros de "is not defined"
        window.createSupabaseClient = function() { 
            console.warn("Cliente Supabase ainda não está disponível, aguarde carregamento"); 
            return null; 
        };
        window.getSupabaseCredentials = function() { return { url: '', key: '', options: {} }; };
        window._configLoading = true;
    </script>
    
    <!-- Carregamento de configurações da Lambda -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Biblioteca para geração de vídeos -->
    <script src="https://cdn.jsdelivr.net/npm/recordrtc@5.6.2/RecordRTC.min.js"></script>
    <script>
        // Tela de carregamento inicial
        document.write('<div id="loading-config" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #005ae2; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 20px; color: #005ae2; font-family: Arial, sans-serif;">Carregando configurações...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>');
        
        // IIFE para encapsular todas as variáveis sensíveis e não expor no escopo global
        (function() {
            // Permitir somente um único cliente Supabase
            let _supabaseClient = null;
            let _config = null;
            let _configLoaded = false;
            
            // Interceptar a execução de scripts
            document.addEventListener('DOMContentLoaded', function(e) {
                if (!_configLoaded) {
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // Função para carregar as configurações
            async function carregarConfiguracoes() {
                try {
                    const response = await fetch('https://vzen6sfiqy2f6hhazz4tcb64ka0stezf.lambda-url.us-east-1.on.aws/');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        _config = result.data;
                        
                        // Criar cliente Supabase uma única vez
                        _supabaseClient = supabase.createClient(
                            _config.SUPABASE_URL1,
                            _config.SUPABASE_KEY1,
                            {
                                db: { schema: 'public' },
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                }
                            }
                        );
                        
                        // Substituir as funções de supabase.js pelas nossas versões
                        window.createSupabaseClient = function() {
                            return _supabaseClient;
                        };
                        
                        window.getSupabaseCredentials = function() {
                            return {
                                url: _config.SUPABASE_URL1,
                                key: _config.SUPABASE_KEY1,
                                options: {
                                    db: { schema: 'public' },
                                    auth: {
                                        autoRefreshToken: true,
                                        persistSession: true,
                                        detectSessionInUrl: true
                                    }
                                }
                            };
                        };
                        
                        // Marcar como carregado e liberar a execução
                        _configLoaded = true;
                        window._configLoading = false;
                        
                        // Remover a tela de carregamento
                        document.getElementById('loading-config').style.display = 'none';
                        
                        // Disparar o evento DOMContentLoaded novamente para inicializar a página
                        setTimeout(() => {
                            document.dispatchEvent(new Event('DOMContentLoaded'));
                        }, 100);
                        
                        return true;
                    } else {
                        throw new Error('Falha ao carregar configurações');
                    }
                } catch (error) {
                    document.getElementById('loading-config').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#ff3333" viewBox="0 0 256 256">
                                <path d="M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm-12-80V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0Zm28,40a16,16,0,1,1-16-16A16,16,0,0,1,144,172Z"></path>
                            </svg>
                            <h3 style="color: #ff3333; margin-top: 10px; font-family: Arial, sans-serif;">Erro ao carregar configurações</h3>
                            <p style="margin-top: 10px; font-family: Arial, sans-serif;">Por favor, recarregue a página ou tente novamente mais tarde.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 8px 16px; background-color: #005ae2; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif;">Recarregar página</button>
                        </div>
                    `;
                    return false;
                }
            }
            
            // Inicializar imediatamente
            carregarConfiguracoes();
        })();
    </script>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon.svg">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9',
                        'logo-blue': '#005ae2'
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(180deg, #E6F0FF 0%, #FFFFFF 100%);
            min-height: 100vh;
            padding-bottom: 60px;
        }
        
        .logo-olharmais {
            background: linear-gradient(90deg, #005ae2 0%, #3988ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .container {
            max-width: 992px !important;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Animação de loading */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.' }
            40% { content: '..' }
            60% { content: '...' }
            80%, 100% { content: '' }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Estilo para preview de mídia */
        .media-preview {
            aspect-ratio: 16/9;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Estilo para checkboxes personalizados */
        .checkbox-secretario {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-secretario:checked {
            background-color: #005ae2;
            border-color: #005ae2;
        }

        .checkbox-secretario:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Estilos para os tipos de story */
        .story-type-card {
            transition: all 0.3s ease;
        }

        .story-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 90, 226, 0.15);
        }

        .story-type-card.selected {
            border-color: #005ae2;
            background-color: #E6F0FF;
        }

        /* Canvas para preview */
        .canvas-preview {
            max-width: 100%;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
        }

        /* Estilo para o editor de texto */
        .text-editor {
            min-height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .text-editor canvas {
            border-radius: 8px;
        }

        /* Loading para geração de vídeo */
        .generating-video {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        /* Gradientes para fundos */
        .bg-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .bg-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .bg-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    </style>
</head>
<body class="font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex items-center">
            <h1 class="text-2xl font-bold logo-olharmais">OlharMais</h1>
            <div class="ml-auto flex items-center gap-4">
                <button onclick="window.location.href='cameras_gestor.html'" class="text-gray-600 hover:text-primary transition-colors" title="Câmeras">
                    <i class="ph ph-video-camera text-xl"></i>
                </button>
                <button onclick="window.location.href='notificacoes_gestor.html'" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="ph ph-bell text-xl"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Cabeçalho -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Criar Conteúdo</h2>
            <p class="text-gray-600">Crie Stories ou Comunicados para sua cidade</p>
        </div>
        
        <!-- Seleção do Tipo de Conteúdo -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">O que você quer criar?</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="cursor-pointer">
                    <input type="radio" name="tipo_conteudo" value="story" checked class="hidden peer" onchange="alternarTipoConteudo('story')">
                    <div class="h-20 border-2 border-gray-200 rounded-lg peer-checked:border-primary peer-checked:bg-primary-light transition-all flex items-center justify-center gap-3 hover:bg-gray-50">
                        <i class="ph ph-camera text-2xl text-primary"></i>
                        <div>
                            <div class="font-semibold text-gray-800">Story</div>
                            <div class="text-sm text-gray-600">Notificação visível na home</div>
                        </div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="tipo_conteudo" value="comunicado" class="hidden peer" onchange="alternarTipoConteudo('comunicado')">
                    <div class="h-20 border-2 border-gray-200 rounded-lg peer-checked:border-primary peer-checked:bg-primary-light transition-all flex items-center justify-center gap-3 hover:bg-gray-50">
                        <i class="ph ph-chat-circle-dots text-2xl text-primary"></i>
                        <div>
                            <div class="font-semibold text-gray-800">Comunicado</div>
                            <div class="text-sm text-gray-600" id="comunicado-description">Mensagem para profissionais</div>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- Formulário Dinâmico -->
        <form id="conteudo-form" class="bg-white rounded-lg shadow p-6">
            <!-- Seção de Story (inicialmente visível) -->
            <div id="story-section">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-camera text-primary"></i>
                    Criar Story
                </h3>
                
                <!-- Tipos de Story -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">Tipo de Story</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Vídeo -->
                        <div class="story-type-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer selected" data-type="video">
                            <div class="text-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="ph ph-video text-2xl text-blue-600"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-1">Vídeo</h4>
                                <p class="text-sm text-gray-600">Envie um vídeo do seu dispositivo</p>
                    </div>
                </div>
                        
                        <!-- Texto -->
                        <div class="story-type-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer" data-type="text">
                            <div class="text-center">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="ph ph-text-aa text-2xl text-green-600"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-1">Texto</h4>
                                <p class="text-sm text-gray-600">Crie um story com texto personalizado</p>
                            </div>
                        </div>
                        
                        <!-- Imagem -->
                        <div class="story-type-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer" data-type="image">
                            <div class="text-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="ph ph-image text-2xl text-purple-600"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-1">Imagem</h4>
                                <p class="text-sm text-gray-600">Transforme uma imagem em story</p>
                            </div>
                        </div>
                    </div>
                </div>
                

                
                <!-- Upload de Vídeo -->
                <div id="upload-video" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Vídeo</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors relative" id="upload-video-file">
                        <input type="file" id="video-file-input" accept="video/*" class="hidden">
                        <div id="video-file-placeholder" class="py-8">
                            <i class="ph ph-video text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Clique para fazer upload de um vídeo</p>
                            <p class="text-sm text-gray-500">MP4, MOV (máx. 50MB)</p>
                        </div>
                        <div id="video-file-preview" class="hidden">
                            <video controls class="w-full rounded-lg"></video>
                        </div>
                    </div>
                </div>
                
                <!-- Editor de Texto -->
                <div id="text-editor-section" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Editor de Texto</label>
                    
                    <!-- Configurações do texto -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Texto</label>
                                <textarea id="story-text-input" rows="3" placeholder="Digite seu texto aqui..." class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none"></textarea>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tamanho da Fonte</label>
                                    <input type="range" id="font-size-slider" min="20" max="80" value="48" class="w-full">
                                    <span id="font-size-value" class="text-sm text-gray-600">48px</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Cor do Texto</label>
                                    <input type="color" id="text-color" value="#ffffff" class="w-full h-10 border border-gray-300 rounded">
                                </div>
                            </div>
                </div>
                
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fundo</label>
                            <div class="flex gap-2">
                                <button type="button" class="bg-gradient-1 w-8 h-8 rounded border-2 border-gray-300" data-bg="gradient-1"></button>
                                <button type="button" class="bg-gradient-2 w-8 h-8 rounded border-2 border-gray-300" data-bg="gradient-2"></button>
                                <button type="button" class="bg-gradient-3 w-8 h-8 rounded border-2 border-gray-300" data-bg="gradient-3"></button>
                                <button type="button" class="bg-gradient-4 w-8 h-8 rounded border-2 border-gray-300" data-bg="gradient-4"></button>
                            </div>
                </div>
                    </div>
                    
                    <!-- Preview do texto -->
                    <div class="text-editor">
                        <canvas id="text-canvas" width="360" height="640" style="max-width: 300px; max-height: 533px;"></canvas>
                    </div>
                </div>
                
                <!-- Upload de Imagem -->
                <div id="upload-image-section" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Imagem</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors relative" id="upload-image-file">
                        <input type="file" id="image-file-input" accept="image/*" class="hidden">
                        <div id="image-file-placeholder" class="py-8">
                            <i class="ph ph-image text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Clique para fazer upload de uma imagem</p>
                            <p class="text-sm text-gray-500">JPG, PNG, GIF (máx. 10MB)</p>
                        </div>
                        <div id="image-file-preview" class="hidden">
                            <img class="max-w-full max-h-64 mx-auto rounded-lg" alt="Preview">
                        </div>
                    </div>
                    
                    <!-- Preview da imagem no canvas -->
                    <div id="image-canvas-container" class="mt-4 hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preview do Story</label>
                        <div class="text-editor">
                            <canvas id="image-canvas" width="360" height="640" style="max-width: 300px; max-height: 533px;"></canvas>
                        </div>
                    </div>
                </div>
                

            </div>
            
            <!-- Seção de Comunicado (inicialmente oculta) -->
            <div id="comunicado-section" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-chat-circle-dots text-primary"></i>
                    Criar Comunicado
                </h3>
                
                <!-- Título do Comunicado -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Título do Comunicado</label>
                    <input type="text" id="titulo-comunicado" 
                           class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all"
                           placeholder="Ex: Reunião de Coordenação - Urgente">
                </div>
                
                <!-- Nível de Importância -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nível de Importância</label>
                    <select id="select-importancia" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all">
                        <option value="informativo">🟢 Informativo</option>
                        <option value="importante">🟡 Importante</option>
                        <option value="urgente">🔴 Urgente</option>
                    </select>
                </div>
                
                <!-- Tipo de Envio -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enviar para</label>
                    <select id="select-tipo-envio" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all">
                        <!-- As opções serão preenchidas dinamicamente baseado no tipo de gestor -->
                    </select>
                </div>
                
                <!-- Destinatários Específicos -->
                <div id="div-destinatarios-especificos" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2" id="label-destinatarios">Destinatários</label>
                    
                    <!-- Campo de busca -->
                    <div class="mb-3">
                        <div class="relative">
                            <input type="text" id="busca-destinatario" placeholder="Digite o nome para buscar..." class="w-full h-[54px] border border-gray-300 rounded-lg px-4 pl-12 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all">
                            <i class="ph ph-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div id="lista-destinatarios" class="border border-gray-300 rounded-lg p-2 bg-gray-50 max-h-60 overflow-y-auto">
                        <!-- Lista de destinatários será inserida aqui -->
                    </div>
                </div>
                
                <!-- Conteúdo do Comunicado -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conteúdo</label>
                    <textarea id="conteudo-comunicado" rows="6"
                              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all resize-none"
                              placeholder="Digite aqui o conteúdo do comunicado. Seja claro e objetivo para facilitar o entendimento..."></textarea>
                </div>
            </div>
            
            <!-- Botões -->
            <div class="flex gap-3">
                <button type="submit" 
                        class="flex-1 h-[54px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                    <span id="btn-text">Publicar Story</span>
                    <div class="hidden" id="loading-spinner">
                        <i class="ph ph-spinner loading-spinner"></i>
                    </div>
                </button>
                <button type="button" onclick="window.location.href='notificacoes_gestor.html'" 
                        class="flex-1 h-[54px] border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
            <div id="submit-status" class="hidden mt-4 text-gray-600 flex items-center gap-2">
                <i class="ph ph-spinner loading-spinner"></i>
                <span id="status-text">Enviando story...</span>
            </div>
        </form>
    </main>
    
    <!-- Toast Component -->
    <div id="toast" class="fixed top-4 right-4 z-[9999] hidden">
        <div class="px-4 py-2 rounded-lg shadow-lg text-white font-medium"></div>
    </div>
    
    <!-- Modal de Loading para Geração de Vídeo -->
    <div id="video-generation-modal" class="fixed inset-0 z-[9999] hidden generating-video flex items-center justify-center">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Gerando seu story...</h3>
                <p class="text-gray-600 mb-4">Isso pode levar alguns segundos</p>
                <div class="bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="generation-progress" class="bg-primary h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="generation-status" class="text-sm text-gray-500 mt-2">Iniciando...</p>
            </div>
        </div>
    </div>
    
    <!-- Navbar -->
    <script src="botoes_gestor.js" type="module"></script>
    
    <script>
        // Toast Component
        const Toast = {
            element: document.getElementById('toast'),
            timeoutId: null,
            
            show(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                clearTimeout(this.timeoutId);
                
                const inner = this.element.querySelector('div');
                inner.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                inner.textContent = message;
                
                this.element.classList.remove('hidden');
                
                this.timeoutId = setTimeout(() => {
                    this.element.classList.add('hidden');
                }, 3000);
            }
        };

        // Estado do formulário
        let formState = {
            tipoConteudo: 'story',
            tipoStory: 'video', // 'video', 'text', 'image'
            tipoMidia: 'video_upload', // Sempre vídeo carregado para stories
            arquivo: null,
            destinatarios: [],
            tipoGestor: null, // 'Prefeito' ou 'Secretário'
            profissoesDestino: [],
            textConfig: {
                text: '',
                fontSize: 48,
                color: '#ffffff',
                background: 'gradient-1'
            },
            generatedVideo: null
        };

        // Video generator ready
        let videoGeneratorReady = true;

        // Inicializar gerador de vídeo (não precisa mais)
        async function initFFmpeg() {
            videoGeneratorReady = true;
            console.log('Gerador de vídeo pronto');
        }

        // Alternar tipo de story
        function alternarTipoStory(tipo) {
            formState.tipoStory = tipo;
            
            // Atualizar visual dos cards
            document.querySelectorAll('.story-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-type="${tipo}"]`).classList.add('selected');
            
            // Mostrar/ocultar seções
            document.getElementById('upload-video').style.display = tipo === 'video' ? 'block' : 'none';
            document.getElementById('text-editor-section').style.display = tipo === 'text' ? 'block' : 'none';
            document.getElementById('upload-image-section').style.display = tipo === 'image' ? 'block' : 'none';
            
            // Limpar arquivo anterior
            formState.arquivo = null;
            formState.generatedVideo = null;
            
            // Se for texto, inicializar canvas
            if (tipo === 'text') {
                videoGeneratorReady = true;
                renderTextCanvas();
            }
            
            // Se for imagem, preparar gerador
            if (tipo === 'image') {
                videoGeneratorReady = true;
            }
        }

        // Renderizar canvas de texto
        function renderTextCanvas() {
            const canvas = document.getElementById('text-canvas');
            const ctx = canvas.getContext('2d');
            
            // Limpar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Aplicar gradiente de fundo
            const gradient = getGradientForCanvas(ctx, formState.textConfig.background);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Configurar texto
            ctx.fillStyle = formState.textConfig.color;
            ctx.font = `bold ${formState.textConfig.fontSize}px Inter, Arial, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Quebrar texto em linhas
            const text = formState.textConfig.text || 'Digite seu texto aqui...';
            const lines = wrapText(ctx, text, canvas.width - 80);
            
            // Desenhar cada linha
            const lineHeight = formState.textConfig.fontSize * 1.2;
            const startY = (canvas.height - (lines.length - 1) * lineHeight) / 2;
            
            lines.forEach((line, index) => {
                ctx.fillText(line, canvas.width / 2, startY + index * lineHeight);
            });
        }

        // Quebrar texto em linhas
        function wrapText(ctx, text, maxWidth) {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            for (let word of words) {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            return lines;
        }

        // Gerar vídeo usando canvas animado
        function generateVideoFromCanvas(canvas, duration = 10000) {
            return new Promise((resolve, reject) => {
                const stream = canvas.captureStream(30); // 30 FPS
                
                // Tentar diferentes formatos baseado no suporte do navegador
                let mimeType = 'video/webm;codecs=vp8'; // Mais compatível que vp9
                
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/webm';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'video/mp4';
                }
                
                console.log('Usando formato:', mimeType);
                
                const recorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 2500000 // 2.5 Mbps para boa qualidade
                });
                
                const chunks = [];
                
                recorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                recorder.onstop = () => {
                    // Converter para MP4 se possível, senão manter o formato original
                    let finalType = mimeType.includes('mp4') ? 'video/mp4' : 'video/webm';
                    const blob = new Blob(chunks, { type: finalType });
                    resolve(blob);
                };
                
                recorder.onerror = (event) => {
                    console.error('Erro na gravação:', event.error);
                    reject(event.error);
                };
                
                recorder.start(100); // Capturar dados a cada 100ms
                
                // Parar gravação após duração especificada
                setTimeout(() => {
                    if (recorder.state === 'recording') {
                        recorder.stop();
                    }
                    // Parar todas as tracks do stream
                    stream.getTracks().forEach(track => track.stop());
                }, duration);
            });
        }

        // Obter gradiente para canvas
        function getGradientForCanvas(ctx, type) {
            const gradient = ctx.createLinearGradient(0, 0, 360, 640);
            
            switch (type) {
                case 'gradient-1':
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
                    break;
                case 'gradient-2':
                    gradient.addColorStop(0, '#f093fb');
                    gradient.addColorStop(1, '#f5576c');
                    break;
                case 'gradient-3':
                    gradient.addColorStop(0, '#4facfe');
                    gradient.addColorStop(1, '#00f2fe');
                    break;
                case 'gradient-4':
                    gradient.addColorStop(0, '#43e97b');
                    gradient.addColorStop(1, '#38f9d7');
                    break;
                default:
                    gradient.addColorStop(0, '#667eea');
                    gradient.addColorStop(1, '#764ba2');
            }
            
            return gradient;
        }

        // Renderizar canvas de imagem
        function renderImageCanvas(imageFile) {
            const canvas = document.getElementById('image-canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Limpar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Calcular dimensões para centralizar e ajustar a imagem
                const canvasRatio = canvas.width / canvas.height;
                const imageRatio = img.width / img.height;
                
                let drawWidth, drawHeight, drawX, drawY;
                
                if (imageRatio > canvasRatio) {
                    // Imagem mais larga que o canvas
                    drawWidth = canvas.width;
                    drawHeight = canvas.width / imageRatio;
                    drawX = 0;
                    drawY = (canvas.height - drawHeight) / 2;
                } else {
                    // Imagem mais alta que o canvas
                    drawHeight = canvas.height;
                    drawWidth = canvas.height * imageRatio;
                    drawX = (canvas.width - drawWidth) / 2;
                    drawY = 0;
                }
                
                // Desenhar imagem
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                
                // Mostrar container do canvas
                document.getElementById('image-canvas-container').classList.remove('hidden');
            };
            
            img.src = URL.createObjectURL(imageFile);
        }

        // Gerar vídeo de texto
        async function generateTextVideo() {
            showGenerationModal();
            updateGenerationProgress(10, 'Preparando gravação...');
            
            try {
                const canvas = document.getElementById('text-canvas');
                
                updateGenerationProgress(30, 'Iniciando gravação...');
                
                // Criar uma animação suave para o texto durante 10 segundos
                const ctx = canvas.getContext('2d');
                let animationFrame = 0;
                const totalFrames = 300; // 10 segundos * 30fps
                
                const textAnimation = () => {
                    const progress = animationFrame / totalFrames;
                    
                    // Fade in nos primeiros 2 segundos
                    if (progress < 0.2) {
                        ctx.globalAlpha = progress / 0.2;
                    } 
                    // Fade out nos últimos 2 segundos
                    else if (progress > 0.8) {
                        ctx.globalAlpha = 1 - ((progress - 0.8) / 0.2);
                    } 
                    // Opacidade total no meio
                    else {
                        ctx.globalAlpha = 1;
                    }
                    
                    renderTextCanvas();
                    animationFrame++;
                    
                    if (animationFrame < totalFrames) {
                        requestAnimationFrame(textAnimation);
                    }
                };
                
                updateGenerationProgress(50, 'Gravando vídeo...');
                
                // Iniciar animação e gravação
                textAnimation();
                const videoBlob = await generateVideoFromCanvas(canvas, 10000);
                
                updateGenerationProgress(90, 'Finalizando...');
                
                // Resetar canvas
                ctx.globalAlpha = 1;
                renderTextCanvas();
                
                updateGenerationProgress(100, 'Concluído!');
                
                setTimeout(() => {
                    hideGenerationModal();
                    Toast.show('Vídeo gerado com sucesso!', 'success');
                }, 1000);
                
                return videoBlob;
                
            } catch (error) {
                console.error('Erro ao gerar vídeo de texto:', error);
                hideGenerationModal();
                Toast.show('Erro ao gerar vídeo', 'error');
                return null;
            }
        }

        // Gerar vídeo de imagem
        async function generateImageVideo(imageFile) {
            showGenerationModal();
            updateGenerationProgress(10, 'Preparando imagem...');
            
            try {
                const canvas = document.getElementById('image-canvas');
                
                updateGenerationProgress(30, 'Iniciando gravação...');
                
                // Criar animação suave de zoom para a imagem durante 10 segundos
                const ctx = canvas.getContext('2d');
                let animationFrame = 0;
                const totalFrames = 300; // 10 segundos * 30fps
                
                const animateImage = () => {
                    const progress = animationFrame / totalFrames;
                    
                    // Zoom suave de 1.0 para 1.1 e volta
                    const scaleProgress = Math.sin(progress * Math.PI * 2) * 0.05; // Oscila entre -0.05 e +0.05
                    const scale = 1.0 + Math.abs(scaleProgress);
                    
                    ctx.save();
                    ctx.scale(scale, scale);
                    ctx.translate((canvas.width * (1 - scale)) / (2 * scale), (canvas.height * (1 - scale)) / (2 * scale));
                    renderImageCanvas(imageFile);
                    ctx.restore();
                    
                    animationFrame++;
                    
                    if (animationFrame < totalFrames) {
                        requestAnimationFrame(animateImage);
                    }
                };
                
                updateGenerationProgress(50, 'Gravando vídeo...');
                
                // Iniciar animação e gravação
                animateImage();
                const videoBlob = await generateVideoFromCanvas(canvas, 10000);
                
                updateGenerationProgress(90, 'Finalizando...');
                
                // Resetar canvas
                renderImageCanvas(imageFile);
                
                updateGenerationProgress(100, 'Concluído!');
                
                setTimeout(() => {
                    hideGenerationModal();
                    Toast.show('Vídeo gerado com sucesso!', 'success');
                }, 1000);
                
                return videoBlob;
                
            } catch (error) {
                console.error('Erro ao gerar vídeo de imagem:', error);
                hideGenerationModal();
                Toast.show('Erro ao gerar vídeo', 'error');
                return null;
            }
        }

        // Controles do modal de geração
        function showGenerationModal() {
            document.getElementById('video-generation-modal').classList.remove('hidden');
        }

        function hideGenerationModal() {
            document.getElementById('video-generation-modal').classList.add('hidden');
            updateGenerationProgress(0, 'Iniciando...');
        }

        function updateGenerationProgress(percent, status) {
            document.getElementById('generation-progress').style.width = `${percent}%`;
            document.getElementById('generation-status').textContent = status;
        }

        // Detectar tipo de gestor e configurar interface
        async function detectarTipoGestor() {
            try {
                console.log('Iniciando detecção do tipo de gestor...');
                
                const userSession = localStorage.getItem('user_session');
                if (!userSession) {
                    console.log('Sem sessão de usuário, redirecionando...');
                    window.location.href = '/auth.html';
                    return;
                }
                
                const userData = JSON.parse(userSession);
                console.log('Dados do usuário da sessão:', userData);
                
                const supabase = createSupabaseClient();
                if (!supabase) {
                    console.error('Cliente Supabase não disponível ainda');
                    // Tentar novamente em 1 segundo
                    setTimeout(detectarTipoGestor, 1000);
                    return;
                }
                
                // Buscar profissão do usuário
                console.log('Buscando profissão do usuário ID:', userData.id);
                const { data: usuario, error } = await supabase
                    .from('usuarios')
                    .select('profissao')
                    .eq('id', userData.id)
                    .single();

                if (error) {
                    console.error('Erro ao buscar dados do usuário:', error);
                    throw error;
                }

                console.log('Dados do usuário retornados:', usuario);
                
                formState.tipoGestor = usuario.profissao;
                configurarInterface(usuario.profissao);

            } catch (error) {
                console.error('Erro ao detectar tipo de gestor:', error);
                Toast.show('Erro ao carregar dados do usuário', 'error');
            }
        }

        // Configurar interface baseado no tipo de gestor
        function configurarInterface(profissao) {
            console.log('Configurando interface para profissão:', profissao);
            
            const comunicadoDescription = document.getElementById('comunicado-description');
            const selectTipoEnvio = document.getElementById('select-tipo-envio');
            
            if (profissao === 'Prefeito') {
                // Prefeito envia para Secretários
                comunicadoDescription.textContent = 'Mensagem para secretários';
                formState.profissoesDestino = ['Secretário'];
                
                selectTipoEnvio.innerHTML = `
                    <option value="todos_profissao">Todos os Secretários</option>
                    <option value="especificos">Secretários Específicos</option>
                `;
                
                console.log('Configurado para Prefeito. Profissões de destino:', formState.profissoesDestino);
                
            } else if (profissao === 'Secretário') {
                // Secretário envia para Diretores, Coordenadores e Professores
                comunicadoDescription.textContent = 'Mensagem para equipe educacional';
                formState.profissoesDestino = ['Diretor', 'Coordenador', 'Professor'];
                
                selectTipoEnvio.innerHTML = `
                    <option value="todos_profissao">Toda a Equipe Educacional</option>
                    <option value="especificos">Profissionais Específicos</option>
                    <option value="por_profissao">Por Profissão</option>
                `;
                
                console.log('Configurado para Secretário. Profissões de destino:', formState.profissoesDestino);
            } else {
                console.warn('Profissão não reconhecida:', profissao);
            }
        }

        // Alternância entre Story e Comunicado
        function alternarTipoConteudo(tipo) {
            formState.tipoConteudo = tipo;
            const storySection = document.getElementById('story-section');
            const comunicadoSection = document.getElementById('comunicado-section');
            const btnText = document.getElementById('btn-text');
            const statusText = document.getElementById('status-text');
            
            if (tipo === 'story') {
                storySection.classList.remove('hidden');
                comunicadoSection.classList.add('hidden');
                btnText.textContent = 'Publicar Story';
                statusText.textContent = 'Enviando story...';
            } else {
                storySection.classList.add('hidden');
                comunicadoSection.classList.remove('hidden');
                btnText.textContent = 'Enviar Comunicado';
                statusText.textContent = 'Enviando comunicado...';
                // Não carregar destinatários automaticamente, esperar seleção do tipo
            }
        }

        // Gerenciar tipo de envio de comunicados
        document.getElementById('select-tipo-envio').addEventListener('change', function(e) {
            const divDestinatarios = document.getElementById('div-destinatarios-especificos');
            const labelDestinatarios = document.getElementById('label-destinatarios');
            
            if (e.target.value === 'especificos') {
                divDestinatarios.classList.remove('hidden');
                labelDestinatarios.textContent = formState.tipoGestor === 'Prefeito' ? 'Secretários' : 'Profissionais';
                carregarDestinatarios('todos');
            } else if (e.target.value === 'por_profissao') {
                divDestinatarios.classList.remove('hidden');
                labelDestinatarios.textContent = 'Selecionar por Profissão';
                mostrarOpcoesProfissao();
            } else {
                divDestinatarios.classList.add('hidden');
            }
        });

        // Mostrar opções de profissão (apenas para Secretários)
        function mostrarOpcoesProfissao() {
            const container = document.getElementById('lista-destinatarios');
            container.innerHTML = `
                <div class="space-y-3">
                    <label class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="Diretor" class="mr-3 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                        <div class="flex items-center">
                            <i class="ph ph-briefcase text-lg text-gray-600 mr-3"></i>
                            <span class="font-medium">Diretores</span>
                        </div>
                    </label>
                    <label class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="Coordenador" class="mr-3 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                        <div class="flex items-center">
                            <i class="ph ph-clipboard text-lg text-gray-600 mr-3"></i>
                            <span class="font-medium">Coordenadores</span>
                        </div>
                    </label>
                    <label class="flex items-center p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="Professor" class="mr-3 h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                        <div class="flex items-center">
                            <i class="ph ph-chalkboard-teacher text-lg text-gray-600 mr-3"></i>
                            <span class="font-medium">Professores</span>
                        </div>
                    </label>
                </div>
            `;
            
            // Configurar busca desabilitada para seleção por profissão
            document.getElementById('busca-destinatario').style.display = 'none';
        }

        // Carregar lista de destinatários
        async function carregarDestinatarios(filtro = 'todos') {
            try {
                const supabase = createSupabaseClient();
                const userSession = JSON.parse(localStorage.getItem('user_session'));
                
                console.log('Carregando destinatários...');
                console.log('Tipo de gestor:', formState.tipoGestor);
                console.log('Profissões de destino:', formState.profissoesDestino);
                
                // Buscar cidade do usuário para filtrar destinatários da mesma cidade
                const { data: usuario, error: userError } = await supabase
                    .from('usuarios')
                    .select('cidade')
                    .eq('id', userSession.id)
                    .single();

                if (userError) throw userError;

                console.log('Cidade do usuário:', usuario.cidade);

                let query = supabase
                    .from('usuarios')
                    .select('id, nome, foto_url, profissao, cidade')
                    .eq('cidade', usuario.cidade) // Filtrar pela mesma cidade
                    .order('nome');

                // Aplicar filtro de profissões baseado no tipo de gestor
                if (formState.profissoesDestino && formState.profissoesDestino.length > 0) {
                    console.log('Aplicando filtro de profissões:', formState.profissoesDestino);
                    query = query.in('profissao', formState.profissoesDestino);
                } else {
                    console.warn('Nenhuma profissão de destino definida!');
                }

                const { data: destinatarios, error } = await query;

                if (error) throw error;

                console.log('Destinatários encontrados:', destinatarios?.length || 0, destinatarios);

                formState.destinatarios = destinatarios || [];
                renderizarDestinatarios(formState.destinatarios);

                // Configurar busca
                configurarBuscaDestinatarios();

            } catch (error) {
                console.error('Erro ao carregar destinatários:', error);
                Toast.show('Erro ao carregar destinatários', 'error');
            }
        }

        // Renderizar lista de destinatários
        function renderizarDestinatarios(destinatarios) {
            const container = document.getElementById('lista-destinatarios');
            container.innerHTML = '';

            // Mostrar campo de busca novamente (pode ter sido escondido na seleção por profissão)
            document.getElementById('busca-destinatario').style.display = 'block';

            if (destinatarios.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum destinatário encontrado</p>';
                return;
            }
            
            destinatarios.forEach(destinatario => {
                const div = document.createElement('div');
                div.className = 'destinatario-item flex items-center p-3 hover:bg-gray-50 rounded-lg border-b border-gray-100 last:border-b-0';
                
                // Determinar foto do destinatário
                const fotoUrl = destinatario.foto_url || '/assets/img/avatar-placeholder.png';
                
                // Ícone baseado na profissão
                let icone = 'ph-user';
                switch(destinatario.profissao) {
                    case 'Secretário': icone = 'ph-briefcase'; break;
                    case 'Diretor': icone = 'ph-buildings'; break;
                    case 'Coordenador': icone = 'ph-clipboard'; break;
                    case 'Professor': icone = 'ph-chalkboard-teacher'; break;
                }
                
                div.innerHTML = `
                    <input type="checkbox" id="dest-${destinatario.id}" value="${destinatario.id}" class="checkbox-secretario mr-3">
                    <div class="flex items-center flex-1">
                        <img src="${fotoUrl}" alt="${destinatario.nome}" class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-gray-200 shadow-sm" onerror="this.src='/assets/img/avatar-placeholder.png'">
                        <label for="dest-${destinatario.id}" class="flex-1 cursor-pointer">
                            <div class="font-medium text-gray-800">${destinatario.nome}</div>
                            <div class="text-sm text-gray-500 flex items-center gap-1">
                                <i class="${icone}"></i>
                                ${destinatario.profissao}
                            </div>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Configurar busca de destinatários
        function configurarBuscaDestinatarios() {
            const campoBusca = document.getElementById('busca-destinatario');
            if (campoBusca) {
                // Remover listeners anteriores
                campoBusca.replaceWith(campoBusca.cloneNode(true));
                const novoCampoBusca = document.getElementById('busca-destinatario');
                
                novoCampoBusca.addEventListener('input', (e) => {
                    const termo = e.target.value.toLowerCase().trim();
                    
                    if (termo === '') {
                        renderizarDestinatarios(formState.destinatarios);
                    } else {
                        const destinatariosFiltrados = formState.destinatarios.filter(destinatario => 
                            destinatario.nome.toLowerCase().includes(termo) ||
                            destinatario.profissao.toLowerCase().includes(termo)
                        );
                        renderizarDestinatarios(destinatariosFiltrados);
                    }
                });
            }
        }

        // Event listeners para tipos de story
        document.querySelectorAll('.story-type-card').forEach(card => {
            card.addEventListener('click', () => {
                alternarTipoStory(card.dataset.type);
            });
        });

        // Event listeners para editor de texto
        document.getElementById('story-text-input').addEventListener('input', (e) => {
            formState.textConfig.text = e.target.value;
            renderTextCanvas();
        });

        document.getElementById('font-size-slider').addEventListener('input', (e) => {
            formState.textConfig.fontSize = parseInt(e.target.value);
            document.getElementById('font-size-value').textContent = e.target.value + 'px';
            renderTextCanvas();
        });

        document.getElementById('text-color').addEventListener('change', (e) => {
            formState.textConfig.color = e.target.value;
            renderTextCanvas();
        });

        // Event listeners para gradientes de fundo
        document.querySelectorAll('[data-bg]').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remover seleção anterior
                document.querySelectorAll('[data-bg]').forEach(b => b.classList.remove('ring-2', 'ring-primary'));
                // Adicionar seleção atual
                btn.classList.add('ring-2', 'ring-primary');
                
                formState.textConfig.background = btn.dataset.bg;
                renderTextCanvas();
            });
        });

        // Preview de vídeo carregado
        const uploadVideoFile = document.querySelector('#upload-video-file');
        uploadVideoFile.addEventListener('click', () => {
            document.getElementById('video-file-input').click();
        });
        document.getElementById('video-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            if (!file.type.startsWith('video/')) {
                Toast.show('O arquivo deve ser um vídeo', 'error');
                return;
            }
            
            // Validar tamanho (50MB)
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                Toast.show('O vídeo deve ter no máximo 50MB', 'error');
                return;
            }
            
            formState.arquivo = file;
            document.getElementById('video-file-placeholder').classList.add('hidden');
            const preview = document.getElementById('video-file-preview');
            preview.classList.remove('hidden');
            const videoElem = preview.querySelector('video');
            videoElem.src = URL.createObjectURL(file);
        });

        // Upload de imagem
        const uploadImageFile = document.querySelector('#upload-image-file');
        uploadImageFile.addEventListener('click', () => {
            document.getElementById('image-file-input').click();
        });

        document.getElementById('image-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            if (!file.type.startsWith('image/')) {
                Toast.show('O arquivo deve ser uma imagem', 'error');
                return;
            }
            
            // Validar tamanho (10MB)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                Toast.show('A imagem deve ter no máximo 10MB', 'error');
                return;
            }
            
            // Mostrar preview da imagem
            document.getElementById('image-file-placeholder').classList.add('hidden');
            const preview = document.getElementById('image-file-preview');
            preview.classList.remove('hidden');
            const imgElem = preview.querySelector('img');
            imgElem.src = URL.createObjectURL(file);
            
            // Renderizar no canvas
            renderImageCanvas(file);
        });

        // Upload de vídeo simplificado
        async function uploadVideo(file) {
            const supabase = createSupabaseClient();
            const timestamp = new Date().getTime();
            
            // Detectar extensão correta baseada no tipo do arquivo
            let extension = 'webm';
            if (file.type.includes('mp4')) {
                extension = 'mp4';
            }
            
            const fileName = `videos/${timestamp}_story.${extension}`;
            
            console.log('Fazendo upload do vídeo:', fileName, 'Tipo:', file.type, 'Tamanho:', file.size);
            
            const { data, error } = await supabase.storage.from('videos').upload(fileName, file);
            if (error) {
                console.error('Erro ao fazer upload de vídeo:', error);
                Toast.show('Erro ao fazer upload do vídeo. Tente novamente.', 'error');
                return null;
            }
            const { data: { publicUrl } } = supabase.storage.from('videos').getPublicUrl(fileName);
            return publicUrl;
        }

        // Enviar formulário
        document.getElementById('conteudo-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const submitButton = document.querySelector('button[type="submit"]');
                const submitStatus = document.getElementById('submit-status');
                submitButton.disabled = true;
                submitStatus.classList.remove('hidden');

                if (formState.tipoConteudo === 'story') {
                    await enviarStory();
                } else {
                    await enviarComunicado();
                }
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                Toast.show('Erro ao enviar. Tente novamente.', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
            }
        });

        // Enviar Story (notificação)
        async function enviarStory() {
            // Stories não precisam de título/descrição - gerar automaticamente
            const titulo = `Story ${new Date().toLocaleDateString()}`;
            const descricao = `Story criado em ${new Date().toLocaleDateString()} às ${new Date().toLocaleTimeString()}`;
            
            const supabase = createSupabaseClient();
            
            // Buscar cidade do usuário
            const userSession = JSON.parse(localStorage.getItem('user_session'));
            const { data: usuario, error: errorUsuario } = await supabase
                .from('usuarios')
                .select('cidade')
                .eq('id', userSession.id)
                .single();
            
            if (errorUsuario) throw errorUsuario;
            
            let mediaUrl = '';
            let videoFile = null;
            
            // Processar baseado no tipo de story
            if (formState.tipoStory === 'video') {
                // Vídeo carregado
            if (!formState.arquivo) {
                Toast.show('Selecione um vídeo', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
                videoFile = formState.arquivo;
                
            } else if (formState.tipoStory === 'text') {
                // Gerar vídeo do texto
                if (!formState.textConfig.text.trim()) {
                    Toast.show('Digite um texto para o story', 'error');
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }
                
                videoFile = await generateTextVideo();
                if (!videoFile) {
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }
                
            } else if (formState.tipoStory === 'image') {
                // Gerar vídeo da imagem
                const imageInput = document.getElementById('image-file-input');
                if (!imageInput.files[0]) {
                    Toast.show('Selecione uma imagem', 'error');
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }
                
                videoFile = await generateImageVideo(imageInput.files[0]);
                if (!videoFile) {
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }
            }
            
            // Upload do vídeo
            mediaUrl = await uploadVideo(videoFile);
            if (!mediaUrl) {
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
            
            // Inserir notificação incluindo tipo_midia e URLs
            const insertData = {
                titulo,
                descricao,
                cidade_id: usuario.cidade,
                tipo_midia: `${formState.tipoStory}_upload`,
                imagem_url: null,
                video_url: null,
                video_file_url: mediaUrl
            };
            
            const { error: notificacaoError } = await supabase
                .from('notificacoes')
                .insert(insertData);
            
            if (notificacaoError) throw notificacaoError;
            
            Toast.show('Story criado com sucesso!', 'success');
            
            // Redirecionar após 2 segundos
            setTimeout(() => {
                window.location.href = 'notificacoes_gestor.html';
            }, 2000);
        }

        // Enviar Comunicado
        async function enviarComunicado() {
            const titulo = document.getElementById('titulo-comunicado').value.trim();
            const conteudo = document.getElementById('conteudo-comunicado').value.trim();
            const importancia = document.getElementById('select-importancia').value;
            const tipoEnvio = document.getElementById('select-tipo-envio').value;
            
            if (!titulo || !conteudo) {
                Toast.show('Preencha todos os campos obrigatórios', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
            
            const supabase = createSupabaseClient();
            const userSession = JSON.parse(localStorage.getItem('user_session'));
            
            // Determinar profissões de destino baseado no tipo de gestor
            let profissoesDestino;
            if (formState.tipoGestor === 'Prefeito') {
                profissoesDestino = ['Secretário'];
            } else if (formState.tipoGestor === 'Secretário') {
                profissoesDestino = ['Diretor', 'Coordenador', 'Professor'];
            }
            
            // Criar comunicado
            const comunicadoData = {
                titulo,
                conteudo,
                autor_id: userSession.id,
                nivel_importancia: importancia,
                tipo_envio: tipoEnvio === 'todos_profissao' ? 'todos_profissao' : 'especificos',
                profissao_destino: profissoesDestino.join(',') // Guardar como string separada por vírgula
            };

            const { data: comunicado, error: errorComunicado } = await supabase
                .from('comunicados')
                .insert([comunicadoData])
                .select()
                .single();
        
            if (errorComunicado) throw errorComunicado;

            // Criar destinatários
            let destinatarios = [];

            if (tipoEnvio === 'todos_profissao') {
                // Buscar usuários da mesma cidade com as profissões de destino
                const { data: usuario, error: userError } = await supabase
                    .from('usuarios')
                    .select('cidade')
                    .eq('id', userSession.id)
                    .single();

                if (userError) throw userError;

                const { data: usuariosDestino, error: errorUsuarios } = await supabase
                    .from('usuarios')
                    .select('id')
                    .eq('cidade', usuario.cidade)
                    .in('profissao', profissoesDestino);

                if (errorUsuarios) throw errorUsuarios;

                destinatarios = (usuariosDestino || []).map(u => ({
                    comunicado_id: comunicado.id,
                    usuario_id: u.id
                }));

            } else if (tipoEnvio === 'especificos') {
                // Usuários específicos selecionados
                const checkboxes = document.querySelectorAll('#lista-destinatarios input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    Toast.show('Selecione pelo menos um destinatário', 'error');
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }
                
                destinatarios = Array.from(checkboxes).map(cb => ({
                    comunicado_id: comunicado.id,
                    usuario_id: cb.value
                }));

            } else if (tipoEnvio === 'por_profissao') {
                // Profissões específicas selecionadas (apenas para Secretários)
                const checkboxes = document.querySelectorAll('#lista-destinatarios input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    Toast.show('Selecione pelo menos uma profissão', 'error');
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }

                const profissoesSelecionadas = Array.from(checkboxes).map(cb => cb.value);

                // Buscar usuários da mesma cidade com as profissões selecionadas
                const { data: usuario, error: userError } = await supabase
                    .from('usuarios')
                    .select('cidade')
                    .eq('id', userSession.id)
                    .single();

                if (userError) throw userError;

                const { data: usuariosDestino, error: errorUsuarios } = await supabase
                    .from('usuarios')
                    .select('id')
                    .eq('cidade', usuario.cidade)
                    .in('profissao', profissoesSelecionadas);

                if (errorUsuarios) throw errorUsuarios;

                destinatarios = (usuariosDestino || []).map(u => ({
                    comunicado_id: comunicado.id,
                    usuario_id: u.id
                }));
            }

            if (destinatarios.length > 0) {
                const { error: errorDestinatarios } = await supabase
                    .from('comunicados_destinatarios')
                    .insert(destinatarios);

                if (errorDestinatarios) throw errorDestinatarios;
            }

            Toast.show('Comunicado enviado com sucesso!', 'success');
            
            // Redirecionar após 2 segundos
            setTimeout(() => {
                window.location.href = 'notificacoes_gestor.html';
            }, 2000);
        }

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', function() {
            // Aguardar as configurações carregarem antes de detectar o tipo de gestor
            const tentarInicializar = () => {
                if (window._configLoading) {
                    console.log('Aguardando configurações carregarem...');
                    setTimeout(tentarInicializar, 500);
                } else {
                    console.log('Configurações carregadas, iniciando detecção do tipo de gestor...');
                    detectarTipoGestor();
                }
            };
            
            tentarInicializar();
        });

        // Inicializar canvas de texto quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Selecionar primeiro gradiente por padrão
            document.querySelector('[data-bg="gradient-1"]').classList.add('ring-2', 'ring-primary');
            
            // Renderizar canvas inicial se estiver na aba de texto
            if (formState.tipoStory === 'text') {
                setTimeout(renderTextCanvas, 100);
            }
        });
    </script>
</body>
</html> 