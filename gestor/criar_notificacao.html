<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Criar Conteúdo</title>
    <meta name="description" content="OlharMais - Criar Stories e Comunicados">
    <meta name="theme-color" content="#005ae2">
    
    <!-- Definições preliminares para evitar erros antes do carregamento -->
    <script>
        // Definir funções básicas para evitar erros de "is not defined"
        window.createSupabaseClient = function() { 
            console.warn("Cliente Supabase ainda não está disponível, aguarde carregamento"); 
            return null; 
        };
        window.getSupabaseCredentials = function() { return { url: '', key: '', options: {} }; };
        window._configLoading = true;
    </script>
    
    <!-- Carregamento de configurações da Lambda -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Tela de carregamento inicial
        document.write('<div id="loading-config" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #005ae2; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 20px; color: #005ae2; font-family: Arial, sans-serif;">Carregando configurações...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>');
        
        // IIFE para encapsular todas as variáveis sensíveis e não expor no escopo global
        (function() {
            // Permitir somente um único cliente Supabase
            let _supabaseClient = null;
            let _config = null;
            let _configLoaded = false;
            
            // Interceptar a execução de scripts
            document.addEventListener('DOMContentLoaded', function(e) {
                if (!_configLoaded) {
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // Função para carregar as configurações
            async function carregarConfiguracoes() {
                try {
                    const response = await fetch('https://vzen6sfiqy2f6hhazz4tcb64ka0stezf.lambda-url.us-east-1.on.aws/');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        _config = result.data;
                        
                        // Criar cliente Supabase uma única vez
                        _supabaseClient = supabase.createClient(
                            _config.SUPABASE_URL1,
                            _config.SUPABASE_KEY1,
                            {
                                db: { schema: 'public' },
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                }
                            }
                        );
                        
                        // Substituir as funções de supabase.js pelas nossas versões
                        window.createSupabaseClient = function() {
                            return _supabaseClient;
                        };
                        
                        window.getSupabaseCredentials = function() {
                            return {
                                url: _config.SUPABASE_URL1,
                                key: _config.SUPABASE_KEY1,
                                options: {
                                    db: { schema: 'public' },
                                    auth: {
                                        autoRefreshToken: true,
                                        persistSession: true,
                                        detectSessionInUrl: true
                                    }
                                }
                            };
                        };
                        
                        // Marcar como carregado e liberar a execução
                        _configLoaded = true;
                        window._configLoading = false;
                        
                        // Remover a tela de carregamento
                        document.getElementById('loading-config').style.display = 'none';
                        
                        // Disparar o evento DOMContentLoaded novamente para inicializar a página
                        setTimeout(() => {
                            document.dispatchEvent(new Event('DOMContentLoaded'));
                        }, 100);
                        
                        return true;
                    } else {
                        throw new Error('Falha ao carregar configurações');
                    }
                } catch (error) {
                    document.getElementById('loading-config').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#ff3333" viewBox="0 0 256 256">
                                <path d="M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm-12-80V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0Zm28,40a16,16,0,1,1-16-16A16,16,0,0,1,144,172Z"></path>
                            </svg>
                            <h3 style="color: #ff3333; margin-top: 10px; font-family: Arial, sans-serif;">Erro ao carregar configurações</h3>
                            <p style="margin-top: 10px; font-family: Arial, sans-serif;">Por favor, recarregue a página ou tente novamente mais tarde.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 8px 16px; background-color: #005ae2; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif;">Recarregar página</button>
                        </div>
                    `;
                    return false;
                }
            }
            
            // Inicializar imediatamente
            carregarConfiguracoes();
        })();
    </script>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon.svg">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9',
                        'logo-blue': '#005ae2'
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(180deg, #E6F0FF 0%, #FFFFFF 100%);
            min-height: 100vh;
            padding-bottom: 60px;
        }
        
        .logo-olharmais {
            background: linear-gradient(90deg, #005ae2 0%, #3988ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .container {
            max-width: 992px !important;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Animação de loading */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.' }
            40% { content: '..' }
            60% { content: '...' }
            80%, 100% { content: '' }
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Estilo para preview de mídia */
        .media-preview {
            aspect-ratio: 16/9;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Estilo para checkboxes personalizados */
        .checkbox-secretario {
            appearance: none;
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-secretario:checked {
            background-color: #005ae2;
            border-color: #005ae2;
        }

        .checkbox-secretario:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body class="font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex items-center">
            <h1 class="text-2xl font-bold logo-olharmais">OlharMais</h1>
            <div class="ml-auto flex items-center gap-4">
                <button onclick="window.location.href='cameras_gestor.html'" class="text-gray-600 hover:text-primary transition-colors" title="Câmeras">
                    <i class="ph ph-video-camera text-xl"></i>
                </button>
                <button onclick="window.location.href='notificacoes_gestor.html'" class="text-gray-600 hover:text-primary transition-colors">
                    <i class="ph ph-bell text-xl"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Cabeçalho -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Criar Conteúdo</h2>
            <p class="text-gray-600">Crie Stories ou Comunicados para sua cidade</p>
        </div>
        
        <!-- Seleção do Tipo de Conteúdo -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">O que você quer criar?</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="cursor-pointer">
                    <input type="radio" name="tipo_conteudo" value="story" checked class="hidden peer" onchange="alternarTipoConteudo('story')">
                    <div class="h-20 border-2 border-gray-200 rounded-lg peer-checked:border-primary peer-checked:bg-primary-light transition-all flex items-center justify-center gap-3 hover:bg-gray-50">
                        <i class="ph ph-camera text-2xl text-primary"></i>
                        <div>
                            <div class="font-semibold text-gray-800">Story</div>
                            <div class="text-sm text-gray-600">Notificação visível na home</div>
                        </div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="tipo_conteudo" value="comunicado" class="hidden peer" onchange="alternarTipoConteudo('comunicado')">
                    <div class="h-20 border-2 border-gray-200 rounded-lg peer-checked:border-primary peer-checked:bg-primary-light transition-all flex items-center justify-center gap-3 hover:bg-gray-50">
                        <i class="ph ph-chat-circle-dots text-2xl text-primary"></i>
                        <div>
                            <div class="font-semibold text-gray-800">Comunicado</div>
                            <div class="text-sm text-gray-600">Mensagem para secretários</div>
                        </div>
                    </div>
                </label>
            </div>
        </div>
        
        <!-- Formulário Dinâmico -->
        <form id="conteudo-form" class="bg-white rounded-lg shadow p-6">
            <!-- Seção de Story (inicialmente visível) -->
            <div id="story-section">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-camera text-primary"></i>
                    Criar Story
                </h3>
                
                <!-- Tipo de Mídia -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mídia</label>
                    <div class="bg-primary-light border border-primary rounded-lg p-4 flex items-center justify-center gap-2 text-primary">
                        <i class="ph ph-upload"></i>
                        <span>Vídeo Carregado</span>
                    </div>
                </div>
                
                <!-- Upload de Vídeo -->
                <div id="upload-video" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Vídeo</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-colors relative" id="upload-video-file">
                        <input type="file" id="video-file-input" accept="video/*" class="hidden">
                        <div id="video-file-placeholder" class="py-8">
                            <i class="ph ph-video text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Clique para fazer upload de um vídeo</p>
                            <p class="text-sm text-gray-500">MP4, MOV (máx. 50MB)</p>
                        </div>
                        <div id="video-file-preview" class="hidden">
                            <video controls class="w-full rounded-lg"></video>
                        </div>
                    </div>
                </div>
                
                <!-- Título do Story -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Título do Story</label>
                    <input type="text" id="titulo-story" 
                           class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all"
                           placeholder="Digite um título claro e objetivo">
                </div>
                
                <!-- Descrição do Story -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                    <textarea id="descricao-story" rows="4"
                              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all resize-none"
                              placeholder="Descreva os detalhes do story"></textarea>
                </div>
            </div>
            
            <!-- Seção de Comunicado (inicialmente oculta) -->
            <div id="comunicado-section" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="ph ph-chat-circle-dots text-primary"></i>
                    Criar Comunicado
                </h3>
                
                <!-- Título do Comunicado -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Título do Comunicado</label>
                    <input type="text" id="titulo-comunicado" 
                           class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all"
                           placeholder="Ex: Reunião de Coordenação - Urgente">
                </div>
                
                <!-- Nível de Importância -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nível de Importância</label>
                    <select id="select-importancia" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all">
                        <option value="informativo">🟢 Informativo</option>
                        <option value="importante">🟡 Importante</option>
                        <option value="urgente">🔴 Urgente</option>
                    </select>
                </div>
                
                <!-- Tipo de Envio -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Enviar para</label>
                    <select id="select-tipo-envio" class="w-full h-[54px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all">
                        <option value="todos_secretarios">Todos os Secretários</option>
                        <option value="secretarios_especificos">Secretários Específicos</option>
                    </select>
                </div>
                
                <!-- Secretários Específicos -->
                <div id="div-secretarios-especificos" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Secretários</label>
                    
                    <!-- Campo de busca -->
                    <div class="mb-3">
                        <div class="relative">
                            <input type="text" id="busca-secretario" placeholder="Digite o nome do secretário para buscar..." class="w-full h-[54px] border border-gray-300 rounded-lg px-4 pl-12 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all">
                            <i class="ph ph-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div id="lista-secretarios" class="border border-gray-300 rounded-lg p-2 bg-gray-50 max-h-60 overflow-y-auto">
                        <!-- Lista de secretários será inserida aqui -->
                    </div>
                </div>
                
                <!-- Conteúdo do Comunicado -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conteúdo</label>
                    <textarea id="conteudo-comunicado" rows="6"
                              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all resize-none"
                              placeholder="Digite aqui o conteúdo do comunicado. Seja claro e objetivo para facilitar o entendimento..."></textarea>
                </div>
            </div>
            
            <!-- Botões -->
            <div class="flex gap-3">
                <button type="submit" 
                        class="flex-1 h-[54px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                    <span id="btn-text">Publicar Story</span>
                    <div class="hidden" id="loading-spinner">
                        <i class="ph ph-spinner loading-spinner"></i>
                    </div>
                </button>
                <button type="button" onclick="window.location.href='notificacoes_gestor.html'" 
                        class="flex-1 h-[54px] border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
            <div id="submit-status" class="hidden mt-4 text-gray-600 flex items-center gap-2">
                <i class="ph ph-spinner loading-spinner"></i>
                <span id="status-text">Enviando story...</span>
            </div>
        </form>
    </main>
    
    <!-- Toast Component -->
    <div id="toast" class="fixed top-4 right-4 z-[9999] hidden">
        <div class="px-4 py-2 rounded-lg shadow-lg text-white font-medium"></div>
    </div>
    
    <!-- Navbar -->
    <script src="botoes_gestor.js" type="module"></script>
    
    <script>
        // Toast Component
        const Toast = {
            element: document.getElementById('toast'),
            timeoutId: null,
            
            show(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                clearTimeout(this.timeoutId);
                
                const inner = this.element.querySelector('div');
                inner.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                inner.textContent = message;
                
                this.element.classList.remove('hidden');
                
                this.timeoutId = setTimeout(() => {
                    this.element.classList.add('hidden');
                }, 3000);
            }
        };

        // Estado do formulário
        let formState = {
            tipoConteudo: 'story',
            tipoMidia: 'video_upload', // Sempre vídeo carregado para stories
            arquivo: null,
            secretarios: []
        };

        // Alternância entre Story e Comunicado
        function alternarTipoConteudo(tipo) {
            formState.tipoConteudo = tipo;
            const storySection = document.getElementById('story-section');
            const comunicadoSection = document.getElementById('comunicado-section');
            const btnText = document.getElementById('btn-text');
            const statusText = document.getElementById('status-text');
            
            if (tipo === 'story') {
                storySection.classList.remove('hidden');
                comunicadoSection.classList.add('hidden');
                btnText.textContent = 'Publicar Story';
                statusText.textContent = 'Enviando story...';
            } else {
                storySection.classList.add('hidden');
                comunicadoSection.classList.remove('hidden');
                btnText.textContent = 'Enviar Comunicado';
                statusText.textContent = 'Enviando comunicado...';
                carregarSecretarios();
            }
        }

        // Gerenciar tipo de envio de comunicados
        document.getElementById('select-tipo-envio').addEventListener('change', function(e) {
            const divSecretarios = document.getElementById('div-secretarios-especificos');
            if (e.target.value === 'secretarios_especificos') {
                divSecretarios.classList.remove('hidden');
                carregarSecretarios();
            } else {
                divSecretarios.classList.add('hidden');
            }
        });

        // Carregar lista de secretários
        async function carregarSecretarios() {
            try {
                const supabase = createSupabaseClient();
                
                // Buscar todos os secretários (sem filtro de cidade, pois gestor pode enviar para qualquer secretário)
                const { data: secretarios, error } = await supabase
                    .from('usuarios')
                    .select('id, nome, foto_url, cidade')
                    .eq('profissao', 'Secretário')
                    .order('nome');

                if (error) throw error;

                formState.secretarios = secretarios || [];
                renderizarSecretarios(formState.secretarios);

            } catch (error) {
                console.error('Erro ao carregar secretários:', error);
                Toast.show('Erro ao carregar secretários', 'error');
            }
        }

        // Renderizar lista de secretários
        function renderizarSecretarios(secretarios) {
            const container = document.getElementById('lista-secretarios');
            container.innerHTML = '';

            if (secretarios.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum secretário encontrado</p>';
                return;
            }
            
            secretarios.forEach(secretario => {
                const div = document.createElement('div');
                div.className = 'secretario-item flex items-center p-3 hover:bg-gray-50 rounded-lg border-b border-gray-100 last:border-b-0';
                
                // Determinar foto do secretário
                const fotoUrl = secretario.foto_url || '/assets/img/avatar-placeholder.png';
                
                div.innerHTML = `
                    <input type="checkbox" id="sec-${secretario.id}" value="${secretario.id}" class="checkbox-secretario mr-3">
                    <div class="flex items-center flex-1">
                        <img src="${fotoUrl}" alt="${secretario.nome}" class="w-10 h-10 rounded-full mr-3 object-cover border-2 border-gray-200 shadow-sm" onerror="this.src='/assets/img/avatar-placeholder.png'">
                        <label for="sec-${secretario.id}" class="flex-1 cursor-pointer">
                            <div class="font-medium text-gray-800">${secretario.nome}</div>
                            <div class="text-sm text-gray-500">Secretário</div>
                        </label>
                    </div>
                `;
                container.appendChild(div);
            });

            // Configurar busca de secretários
            configurarBuscaSecretarios();
        }

        // Configurar busca de secretários
        function configurarBuscaSecretarios() {
            const campoBusca = document.getElementById('busca-secretario');
            if (campoBusca) {
                campoBusca.addEventListener('input', (e) => {
                    const termo = e.target.value.toLowerCase().trim();
                    
                    if (termo === '') {
                        renderizarSecretarios(formState.secretarios);
                    } else {
                        const secretariosFiltrados = formState.secretarios.filter(secretario => 
                            secretario.nome.toLowerCase().includes(termo)
                        );
                        renderizarSecretarios(secretariosFiltrados);
                    }
                });
            }
        }

        // Preview de vídeo carregado
        const uploadVideoFile = document.querySelector('#upload-video-file');
        uploadVideoFile.addEventListener('click', () => {
            document.getElementById('video-file-input').click();
        });
        document.getElementById('video-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validar tipo de arquivo
            if (!file.type.startsWith('video/')) {
                Toast.show('O arquivo deve ser um vídeo', 'error');
                return;
            }
            
            // Validar tamanho (50MB)
            const maxSize = 50 * 1024 * 1024;
            if (file.size > maxSize) {
                Toast.show('O vídeo deve ter no máximo 50MB', 'error');
                return;
            }
            
            formState.arquivo = file;
            document.getElementById('video-file-placeholder').classList.add('hidden');
            const preview = document.getElementById('video-file-preview');
            preview.classList.remove('hidden');
            const videoElem = preview.querySelector('video');
            videoElem.src = URL.createObjectURL(file);
        });

        // Upload de vídeo simplificado
        async function uploadVideo(file) {
            const supabase = createSupabaseClient();
            const timestamp = new Date().getTime();
            const fileName = `videos/${timestamp}_${file.name}`;
            const { data, error } = await supabase.storage.from('videos').upload(fileName, file);
            if (error) {
                console.error('Erro ao fazer upload de vídeo:', error);
                Toast.show('Erro ao fazer upload do vídeo. Tente novamente.', 'error');
                return null;
            }
            const { data: { publicUrl } } = supabase.storage.from('videos').getPublicUrl(fileName);
            return publicUrl;
        }

        // Enviar formulário
        document.getElementById('conteudo-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const submitButton = document.querySelector('button[type="submit"]');
                const submitStatus = document.getElementById('submit-status');
                submitButton.disabled = true;
                submitStatus.classList.remove('hidden');

                if (formState.tipoConteudo === 'story') {
                    await enviarStory();
                } else {
                    await enviarComunicado();
                }
                
            } catch (error) {
                console.error('Erro ao enviar:', error);
                Toast.show('Erro ao enviar. Tente novamente.', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
            }
        });

        // Enviar Story (notificação)
        async function enviarStory() {
            const titulo = document.getElementById('titulo-story').value.trim();
            const descricao = document.getElementById('descricao-story').value.trim();
            
            if (!titulo || !descricao) {
                Toast.show('Preencha todos os campos obrigatórios', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
            
            const supabase = createSupabaseClient();
            
            // Buscar cidade do usuário
            const userSession = JSON.parse(localStorage.getItem('user_session'));
            const { data: usuario, error: errorUsuario } = await supabase
                .from('usuarios')
                .select('cidade')
                .eq('id', userSession.id)
                .single();
            
            if (errorUsuario) throw errorUsuario;
            
            let mediaUrl = '';
            
            // Para stories, sempre é vídeo carregado
            if (!formState.arquivo) {
                Toast.show('Selecione um vídeo', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
            
            mediaUrl = await uploadVideo(formState.arquivo);
            if (!mediaUrl) {
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
            
            // Inserir notificação incluindo tipo_midia e URLs
            const insertData = {
                titulo,
                descricao,
                cidade_id: usuario.cidade,
                tipo_midia: 'video_upload',
                imagem_url: null,
                video_url: null,
                video_file_url: mediaUrl
            };
            
            const { error: notificacaoError } = await supabase
                .from('notificacoes')
                .insert(insertData);
            
            if (notificacaoError) throw notificacaoError;
            
            Toast.show('Story criado com sucesso!', 'success');
            
            // Redirecionar após 2 segundos
            setTimeout(() => {
                window.location.href = 'notificacoes_gestor.html';
            }, 2000);
        }

        // Enviar Comunicado
        async function enviarComunicado() {
            const titulo = document.getElementById('titulo-comunicado').value.trim();
            const conteudo = document.getElementById('conteudo-comunicado').value.trim();
            const importancia = document.getElementById('select-importancia').value;
            const tipoEnvio = document.getElementById('select-tipo-envio').value;
            
            if (!titulo || !conteudo) {
                Toast.show('Preencha todos os campos obrigatórios', 'error');
                document.querySelector('button[type="submit"]').disabled = false;
                document.getElementById('submit-status').classList.add('hidden');
                return;
            }
            
            const supabase = createSupabaseClient();
            const userSession = JSON.parse(localStorage.getItem('user_session'));
            
            // Criar comunicado
            const comunicadoData = {
                titulo,
                conteudo,
                autor_id: userSession.id,
                nivel_importancia: importancia,
                tipo_envio: 'todos_profissao',
                profissao_destino: 'Secretário'
            };

            const { data: comunicado, error: errorComunicado } = await supabase
                .from('comunicados')
                .insert([comunicadoData])
                .select()
                .single();
        
            if (errorComunicado) throw errorComunicado;

            // Criar destinatários (secretários)
            let destinatarios = [];

            if (tipoEnvio === 'todos_secretarios') {
                // Buscar todos os secretários
                const { data: secretarios, error: errorSecretarios } = await supabase
                    .from('usuarios')
                    .select('id')
                    .eq('profissao', 'Secretário');

                if (errorSecretarios) throw errorSecretarios;

                destinatarios = (secretarios || []).map(s => ({
                    comunicado_id: comunicado.id,
                    usuario_id: s.id
                }));
            } else {
                // Secretários específicos
                const checkboxes = document.querySelectorAll('#lista-secretarios input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    Toast.show('Selecione pelo menos um secretário', 'error');
                    document.querySelector('button[type="submit"]').disabled = false;
                    document.getElementById('submit-status').classList.add('hidden');
                    return;
                }
                
                destinatarios = Array.from(checkboxes).map(cb => ({
                    comunicado_id: comunicado.id,
                    usuario_id: cb.value
                }));
            }

            if (destinatarios.length > 0) {
                const { error: errorDestinatarios } = await supabase
                    .from('comunicados_destinatarios')
                    .insert(destinatarios);

                if (errorDestinatarios) throw errorDestinatarios;
            }

            Toast.show('Comunicado enviado com sucesso!', 'success');
            
            // Redirecionar após 2 segundos
            setTimeout(() => {
                window.location.href = 'notificacoes_gestor.html';
            }, 2000);
        }
    </script>
</body>
</html> 