<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conciliação de Usuários</title>
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <!-- Loading principal -->
    <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Conciliação de Usuários</h1>

        <!-- Seletor de Dispositivo -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Selecione o Dispositivo</h2>
            <select id="deviceSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500">
                <option value="">Selecione um dispositivo...</option>
            </select>
        </div>

        <!-- Container de Conciliação -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Usuários do Dispositivo -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Usuários do Dispositivo</h2>
                    <button id="btnCarregarUsuarios" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2" disabled>
                        <i class="ph ph-users"></i>
                        <span>Carregar Usuários</span>
                        <div id="loadingCarregarUsuarios" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                    </button>
                </div>
                <div id="deviceUsersList" class="space-y-2">
                    <div class="text-center py-4 text-gray-500">
                        Selecione um dispositivo e clique em carregar usuários
                    </div>
                </div>
            </div>

            <!-- Alunos do Sistema -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Alunos do Sistema</h2>
                    <div class="relative">
                        <input type="text" 
                               id="searchAlunos" 
                               class="px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500"
                               placeholder="Buscar aluno...">
                        <i class="ph ph-magnifying-glass absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div id="alunosList" class="space-y-2">
                    <div class="text-center py-4 text-gray-500">
                        Carregando alunos...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar cliente Supabase
        const supabaseClient = createSupabaseClient();
        let currentDevice = null;
        let alunosData = [];
        let deviceUsers = [];

        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: type === 'success' ? "#22c55e" : "#ef4444"
                }
            }).showToast();
        }
        
        // Função para mostrar/esconder loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }

        // Carregar dispositivos
        async function carregarDispositivos() {
            try {
                const { data: dispositivos, error } = await supabaseClient
                    .from('dispositivos')
                    .select(`
                        id,
                        camera_id,
                        ip,
                        login,
                        senha,
                        escolas (
                            nome
                        )
                    `)
                    .is('soft_delete', null)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">Selecione um dispositivo...</option>';

                dispositivos.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = `${device.camera_id} - ${device.escolas?.nome || 'Sem escola'} (${device.ip})`;
                    option.dataset.device = JSON.stringify(device);
                    select.appendChild(option);
                });

                // Habilitar/desabilitar botão de carregar usuários
                const btnCarregar = document.getElementById('btnCarregarUsuarios');
                select.addEventListener('change', (e) => {
                    btnCarregar.disabled = !e.target.value;
                    if (e.target.value) {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        currentDevice = JSON.parse(selectedOption.dataset.device);
                    } else {
                        currentDevice = null;
                    }
                });

            } catch (error) {
                console.error('Erro ao carregar dispositivos:', error);
                showToast('Erro ao carregar lista de dispositivos', 'error');
            }
        }

        // Carregar alunos
        async function carregarAlunos() {
            try {
                const { data: alunos, error } = await supabaseClient
                    .from('alunos')
                    .select(`
                        id,
                        nome_completo,
                        foto_url,
                        serie,
                        turmas (
                            nome
                        )
                    `)
                    .is('soft_delete', null)
                    .order('nome_completo');

                if (error) throw error;

                alunosData = alunos;
                renderizarAlunos(alunos);

            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                showToast('Erro ao carregar lista de alunos', 'error');
            }
        }

        // Renderizar alunos
        function renderizarAlunos(alunos) {
            const container = document.getElementById('alunosList');
            
            if (!alunos || alunos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        Nenhum aluno encontrado
                    </div>
                `;
                return;
            }

            container.innerHTML = alunos.map(aluno => `
                <div class="flex items-center space-x-4 p-3 hover:bg-gray-50 rounded-lg transition-colors">
                    <div class="w-12 h-12 rounded-full overflow-hidden bg-gray-100 flex-shrink-0">
                        ${aluno.foto_url ? 
                            `<img src="${aluno.foto_url}" alt="${aluno.nome_completo}" class="w-full h-full object-cover">` :
                            `<div class="w-full h-full flex items-center justify-center">
                                <i class="ph ph-user text-2xl text-gray-400"></i>
                             </div>`
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-gray-900">${aluno.nome_completo}</h4>
                        <p class="text-sm text-gray-500">
                            ${aluno.serie}° Ano - ${aluno.turmas?.nome || 'Sem turma'}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        // Função para obter sessão do dispositivo
        async function getDeviceSession(ipPorta, login, senha) {
            try {
                const response = await fetch(`http://${ipPorta}/login.fcgi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        login: login,
                        password: senha
                    })
                });

                const data = await response.json();
                if (!data.session) {
                    throw new Error('Sessão não retornada pelo dispositivo');
                }
                return data.session;
            } catch (error) {
                console.error('Erro ao obter sessão:', error);
                throw new Error('Não foi possível conectar ao dispositivo. Verifique as credenciais e o IP.');
            }
        }

        // Função para obter nova sessão do dispositivo
        async function getNewDeviceSession() {
            if (!currentDevice) throw new Error('Nenhum dispositivo selecionado');
            
            const ipAddressWithPort = currentDevice.ip.includes(':') ? currentDevice.ip : `${currentDevice.ip}:80`;
            return await getDeviceSession(
                ipAddressWithPort,
                currentDevice.login || 'admin',
                currentDevice.senha || 'admin'
            );
        }

        // Carregar usuários do dispositivo
        async function carregarUsuariosDispositivo(ipAddress, login, password) {
            try {
                const ipAddressWithPort = ipAddress.includes(':') ? ipAddress : `${ipAddress}:80`;
                
                // Obter nova sessão
                const session = await getDeviceSession(ipAddressWithPort, login || 'admin', password || 'admin');

                // Fazer a requisição para listar usuários
                const payload = {
                    object: "users",
                    where: [{
                        object: "users",
                        field: "image_timestamp",
                        operator: "!=",
                        value: 0
                    }]
                };

                const response = await fetch(`http://${ipAddressWithPort}/load_objects.fcgi?session=${session}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erro ao carregar usuários: ${response.status}`);
                }

                const data = await response.json();
                
                // Para cada usuário, buscar sua imagem
                if (data.users && data.users.length > 0) {
                    for (let user of data.users) {
                        try {
                            const imageResponse = await fetch(`http://${ipAddressWithPort}/user_get_image.fcgi?session=${session}&user_id=${user.id}`);
                            if (imageResponse.ok) {
                                const imageData = await imageResponse.blob();
                                user.imageUrl = URL.createObjectURL(imageData);
                            }
                        } catch (imgError) {
                            console.warn(`Erro ao carregar imagem do usuário ${user.id}:`, imgError);
                        }
                    }
                }

                return { users: data.users || [], session };
            } catch (error) {
                console.error('Erro ao carregar usuários do dispositivo:', error);
                throw error;
            }
        }

        // Função para salvar a conciliação de um aluno com um usuário do dispositivo
        async function salvarConciliacao(alunoId, nomeAluno, deviceUserId) {
            try {
                showLoading();

                // Buscar escola_id do aluno
                const { data: aluno, error: alunoError } = await supabaseClient
                    .from('alunos')
                    .select('escola_id')
                    .eq('id', alunoId)
                    .single();

                if (alunoError) throw alunoError;

                // Buscar device_id do dispositivo (será preenchido pelo trigger)
                const { data: dispositivo, error: dispError } = await supabaseClient
                    .from('dispositivos')
                    .select('device_id')
                    .eq('id', currentDevice.id)
                    .single();

                if (dispError) throw dispError;

                // Buscar usuário logado do localStorage
                const userSession = localStorage.getItem('user_session');
                if (!userSession) throw new Error('Usuário não autenticado');
                const usuarioLogado = JSON.parse(userSession);
                const whatsappCadastrante = usuarioLogado.whatsapp;

                // Criar registro na tabela aluno_dispositivo
                const { error: insertError } = await supabaseClient
                    .from('aluno_dispositivo')
                    .insert({
                        id_dispositivo: currentDevice.id,
                        aluno: alunoId,
                        escola: aluno.escola_id,
                        id_do_aluno_no_dispositivo: deviceUserId.toString(),
                        numero_de_quem_cadastrou: whatsappCadastrante,
                        device_id: dispositivo.device_id
                    });

                if (insertError) throw insertError;

                showToast(`Conciliação salva com sucesso para ${nomeAluno}!`);
                
                // Recarregar listas apenas se não for chamado pelo sincronizarTodosUsuarios
                if (!window.isSyncingAll) {
                    await carregarUsuariosClick();
                    await carregarAlunos();
                }

            } catch (error) {
                console.error('Erro ao processar operação:', error);
                showToast('Erro: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Função para sincronizar todos os usuários correspondentes
        async function sincronizarTodosUsuarios() {
            try {
                if (!confirm('Deseja sincronizar todos os usuários correspondentes? Esta ação não pode ser desfeita.')) {
                    return;
                }

                showLoading();
                let sucessos = 0;
                let falhas = 0;

                // Flag para evitar recargas desnecessárias
                window.isSyncingAll = true;

                // Para cada usuário do dispositivo
                for (const deviceUser of deviceUsers) {
                    // Encontrar correspondências
                    const correspondencias = alunosData.filter(aluno => 
                        aluno.nome_completo.toLowerCase().includes(deviceUser.name.toLowerCase()) ||
                        deviceUser.name.toLowerCase().includes(aluno.nome_completo.toLowerCase())
                    );

                    // Se tiver exatamente uma correspondência, sincronizar
                    if (correspondencias.length === 1) {
                        const aluno = correspondencias[0];
                        try {
                            await salvarConciliacao(aluno.id, aluno.nome_completo, deviceUser.id);
                            sucessos++;
                        } catch (error) {
                            console.error(`Erro ao sincronizar ${deviceUser.name}:`, error);
                            falhas++;
                        }
                    }
                }

                // Remover flag
                window.isSyncingAll = false;

                // Recarregar dados apenas uma vez no final
                await carregarUsuariosClick();
                await carregarAlunos();

                // Mostrar resultado
                showToast(`Sincronização concluída! Sucessos: ${sucessos}, Falhas: ${falhas}`);

            } catch (error) {
                console.error('Erro na sincronização em massa:', error);
                showToast('Erro na sincronização: ' + error.message, 'error');
                window.isSyncingAll = false;
            } finally {
                hideLoading();
            }
        }

        // Renderizar usuários do dispositivo
        function renderizarUsuariosDispositivo(users) {
            const container = document.getElementById('deviceUsersList');
            deviceUsers = users;

            if (!users || users.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        Nenhum usuário cadastrado no dispositivo
                    </div>
                `;
                return;
            }

            // Adicionar botão de sincronização em massa
            container.innerHTML = `
                <div class="mb-4 flex justify-end">
                    <button 
                        onclick="sincronizarTodosUsuarios()"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                        <i class="ph ph-arrows-clockwise"></i>
                        Sincronizar Todos
                    </button>
                </div>
            `;

            // Renderizar usuários
            container.innerHTML += users.map(user => {
                // Encontrar possíveis correspondências por nome
                const possiveisAlunos = alunosData.filter(aluno => 
                    aluno.nome_completo.toLowerCase().includes(user.name.toLowerCase()) ||
                    user.name.toLowerCase().includes(aluno.nome_completo.toLowerCase())
                );

                const matchClass = possiveisAlunos.length > 0 ? 'border-green-200 bg-green-50' : 'border-gray-200';
                const matchIcon = possiveisAlunos.length === 1 ? 
                    '<i class="ph ph-check-circle text-green-600"></i>' : 
                    (possiveisAlunos.length > 1 ? '<i class="ph ph-warning text-yellow-600"></i>' : '');

                return `
                    <div class="border ${matchClass} rounded-lg p-3 hover:bg-opacity-75 transition-colors">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 rounded-full overflow-hidden bg-gray-100 flex-shrink-0">
                                ${user.imageUrl ? 
                                    `<img src="${user.imageUrl}" alt="${user.name}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center">
                                        <i class="ph ph-user text-2xl text-gray-400"></i>
                                     </div>`
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-medium text-gray-900">${user.name}</h4>
                                    ${matchIcon}
                                </div>
                                <p class="text-sm text-gray-500">ID: ${user.id}</p>
                                <p class="text-sm text-gray-500">Matrícula: ${user.registration || 'Não informada'}</p>
                            </div>
                        </div>
                        ${possiveisAlunos.length > 0 ? `
                            <div class="mt-2 pt-2 border-t border-green-200">
                                <p class="text-sm font-medium text-green-700">
                                    ${possiveisAlunos.length === 1 ? 'Correspondência encontrada:' : 'Possíveis correspondências:'}
                                </p>
                                <div class="mt-1 space-y-1">
                                    ${possiveisAlunos.map(aluno => `
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm text-green-600">${aluno.nome_completo}</p>
                                            <button 
                                                onclick="salvarConciliacao(${aluno.id}, '${aluno.nome_completo}', ${user.id})"
                                                class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors flex items-center gap-1">
                                                <i class="ph ph-link"></i>
                                                Conciliar
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Função para salvar a foto do usuário do dispositivo para um aluno
        async function salvarFotoParaAluno(imageUrl, alunoId, nomeAluno, deviceUserId) {
            try {
                showLoading();
                
                // Primeiro atualizar a matrícula no dispositivo
                await atualizarUsuarioDispositivo(deviceUserId, nomeAluno, alunoId);
                showToast('Matrícula atualizada no dispositivo com sucesso!');
                
                // Converter a URL do Blob para um arquivo
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                
                // Gerar nome único para o arquivo
                const fileExt = 'jpg'; // As fotos do dispositivo sempre vêm como JPEG
                const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
                const filePath = `fotos/${fileName}`;

                // Upload para o bucket fotos_alunos
                const { error: uploadError } = await supabaseClient.storage
                    .from('fotos_alunos')
                    .upload(filePath, blob, {
                        contentType: 'image/jpeg'
                    });

                if (uploadError) throw uploadError;

                // Obter a URL pública da foto
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('fotos_alunos')
                    .getPublicUrl(filePath);

                // Atualizar o aluno com a nova foto
                const { error: updateError } = await supabaseClient
                    .from('alunos')
                    .update({ foto_url: publicUrl })
                    .eq('id', alunoId);

                if (updateError) throw updateError;

                showToast(`Foto atualizada com sucesso para ${nomeAluno}!`);
                
                // Recarregar usuários do dispositivo e alunos para atualizar a interface
                await carregarUsuariosClick();
                await carregarAlunos();

            } catch (error) {
                console.error('Erro ao processar operação:', error);
                showToast('Erro: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Função para carregar usuários quando o botão for clicado
        async function carregarUsuariosClick() {
            const btnCarregar = document.getElementById('btnCarregarUsuarios');
            const loadingSpinner = document.getElementById('loadingCarregarUsuarios');
            
            try {
                // Desabilitar botão e mostrar loading
                btnCarregar.disabled = true;
                loadingSpinner.classList.remove('hidden');
                
                // Carregar usuários
                const { users } = await carregarUsuariosDispositivo(
                    currentDevice.ip,
                    currentDevice.login || 'admin',
                    currentDevice.senha || 'admin'
                );
                
                // Exibir usuários
                renderizarUsuariosDispositivo(users);
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showToast('Erro ao carregar usuários: ' + error.message, 'error');
            } finally {
                // Reabilitar botão e esconder loading
                btnCarregar.disabled = false;
                loadingSpinner.classList.add('hidden');
            }
        }

        // Configurar busca de alunos
        function setupSearchAlunos() {
            const searchInput = document.getElementById('searchAlunos');
            
            searchInput.addEventListener('input', (e) => {
                const termo = e.target.value.toLowerCase().trim();
                const alunosFiltrados = alunosData.filter(aluno => 
                    aluno.nome_completo.toLowerCase().includes(termo)
                );
                renderizarAlunos(alunosFiltrados);
            });
        }

        // Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Carregar dispositivos
                await carregarDispositivos();
                
                // Carregar alunos
                await carregarAlunos();
                
                // Configurar busca de alunos
                setupSearchAlunos();
                
                // Configurar evento do botão de carregar usuários
                document.getElementById('btnCarregarUsuarios').addEventListener('click', carregarUsuariosClick);
                
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao carregar o sistema', 'error');
            }
        });
    </script>
</body>
</html>
