<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Fotos dos Alunos</title>
    
    <!-- Definições preliminares para evitar erros antes do carregamento -->
    <script>
        // Definir funções básicas para evitar erros de "is not defined"
        window.createSupabaseClient = function() { 
            console.warn("Cliente Supabase ainda não está disponível, aguarde carregamento"); 
            return null; 
        };
        window.getSupabaseCredentials = function() { return { url: '', key: '', options: {} }; };
        window.limparSessaoEsair = function() { window.location.href = '/auth.html?logout=true'; };
        window.logout = window.limparSessaoEsair;
        
        // Sinalizar que estamos carregando
        window._configLoading = true;
    </script>
    
    <!-- Carregamento de configurações da Lambda -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Tela de carregamento inicial
        document.write('<div id="loading-config" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;"><div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #005ae2; border-radius: 50%; animation: spin 1s linear infinite;"></div><p style="margin-top: 20px; color: #005ae2; font-family: Arial, sans-serif;">Carregando configurações...</p></div><style>@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}</style>');
        
        // IIFE para encapsular todas as variáveis sensíveis e não expor no escopo global
        (function() {
            // Permitir somente um único cliente Supabase
            let _supabaseClient = null;
            let _config = null;
            let _configLoaded = false;
            
            // Interceptar a execução de scripts
            document.addEventListener('DOMContentLoaded', function(e) {
                if (!_configLoaded) {
                    e.stopImmediatePropagation();
                    return false;
                }
            }, true);
            
            // Função para carregar as configurações
            async function carregarConfiguracoes() {
                try {
                    const response = await fetch('https://vzen6sfiqy2f6hhazz4tcb64ka0stezf.lambda-url.us-east-1.on.aws/');
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        _config = result.data;
                        
                        // Criar cliente Supabase uma única vez
                        _supabaseClient = supabase.createClient(
                            _config.SUPABASE_URL1,
                            _config.SUPABASE_KEY1,
                            {
                                db: { schema: 'public' },
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: true,
                                    detectSessionInUrl: true
                                }
                            }
                        );
                        
                        // Substituir as funções de supabase.js pelas nossas versões
                        window.createSupabaseClient = function() {
                            return _supabaseClient;
                        };
                        
                        // Marcar como carregado e liberar a execução
                        _configLoaded = true;
                        window._configLoading = false;
                        
                        // Remover a tela de carregamento
                        document.getElementById('loading-config').style.display = 'none';
                        
                        // Disparar o evento DOMContentLoaded novamente para inicializar a página
                        setTimeout(() => {
                            document.dispatchEvent(new Event('DOMContentLoaded'));
                        }, 100);
                        
                        return true;
                    } else {
                        throw new Error('Falha ao carregar configurações');
                    }
                } catch (error) {
                    document.getElementById('loading-config').innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#ff3333" viewBox="0 0 256 256">
                                <path d="M128,20A108,108,0,1,0,236,128,108.12,108.12,0,0,0,128,20Zm0,192a84,84,0,1,1,84-84A84.09,84.09,0,0,1,128,212Zm-12-80V80a12,12,0,0,1,24,0v52a12,12,0,0,1-24,0Zm28,40a16,16,0,1,1-16-16A16,16,0,0,1,144,172Z"></path>
                            </svg>
                            <h3 style="color: #ff3333; margin-top: 10px; font-family: Arial, sans-serif;">Erro ao carregar configurações</h3>
                            <p style="margin-top: 10px; font-family: Arial, sans-serif;">Por favor, recarregue a página ou tente novamente mais tarde.</p>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 8px 16px; background-color: #005ae2; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: Arial, sans-serif;">Recarregar página</button>
                        </div>
                    `;
                    return false;
                }
            }
            
            // Inicializar imediatamente
            carregarConfiguracoes();
        })();
    </script>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Toast -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Preloader -->
    <div class="preloader fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header Fixo -->
    <header class="fixed top-0 left-0 right-0 bg-white shadow-sm z-40">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-800">OlharMais</h1>
                <div class="flex items-center space-x-2">
                    <button id="btnCadastrar" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg">
                        <i class="ph ph-plus"></i>
                    </button>
                    <button id="btnFiltros" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <i class="ph ph-funnel"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Modal de Cadastro -->
    <div id="modalCadastro" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Cadastrar Novo Aluno</h2>
                        <button id="btnFecharModal" class="text-gray-500 hover:text-gray-700">
                            <i class="ph ph-x text-2xl"></i>
                        </button>
                    </div>

                    <form id="formCadastro" class="space-y-6">
                        <!-- Informações Escolares -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Informações Escolares</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="hidden" id="escola_id" name="escola_id" value="21">
                                <div>
                                    <label for="turma" class="block text-sm font-medium text-gray-700 mb-2">Turma *</label>
                                    <select id="turma" name="turma" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">Selecione uma turma</option>
                                    </select>
                                    <p class="text-sm text-gray-500 mt-1" id="serie_info"></p>
                                </div>
                                <input type="hidden" id="serie" name="serie">
                                <div>
                                    <label for="registro_aluno" class="block text-sm font-medium text-gray-700 mb-2">RA (Registro Aluno) *</label>
                                    <input type="text" id="registro_aluno" name="registro_aluno" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite o RA">
                                </div>
                            </div>
                        </div>

                        <!-- Dados Pessoais -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Dados Pessoais</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="nome_completo" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                                    <input type="text" id="nome_completo" name="nome_completo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome completo">
                                </div>
                                <div>
                                    <label for="data_nascimento" class="block text-sm font-medium text-gray-700 mb-2">Data de Nascimento *</label>
                                    <input type="date" id="data_nascimento" name="data_nascimento" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="genero" class="block text-sm font-medium text-gray-700 mb-2">Sexo *</label>
                                    <select id="genero" name="genero" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">Selecione o sexo</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Feminino</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Foto -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Foto do Aluno</h3>
                            <div class="flex items-center space-x-4">
                                <div class="w-32 h-32 bg-gray-100 rounded-lg flex items-center justify-center cursor-pointer" onclick="document.getElementById('foto_aluno').click()">
                                    <img id="preview_foto" src="" alt="" class="w-full h-full object-cover rounded-lg hidden">
                                    <div id="placeholder_foto" class="text-center">
                                        <i class="ph ph-user text-4xl text-gray-400"></i>
                                        <p class="text-sm text-gray-500 mt-2">Clique para adicionar</p>
                                    </div>
                                </div>
                                <input type="file" id="foto_aluno" name="foto" accept="image/*" class="hidden" required>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="flex justify-end space-x-3 pt-6 border-t">
                            <button type="button" id="btnCancelar" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                                Cancelar
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Cadastrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Painel de Filtros (inicialmente oculto) -->
    <div id="painelFiltros" class="fixed inset-x-0 top-[57px] bg-white shadow-md transform -translate-y-full transition-transform duration-300 z-30">
        <div class="p-4 space-y-4">
            <!-- Seleção de Colégio -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Colégio</label>
                <select id="selectEscola" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Selecione um colégio</option>
                </select>
            </div>

            <!-- Seleção de Série -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Série</label>
                <select id="selectSerie" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todas as séries</option>
                    <option value="1">1º Ano</option>
                    <option value="2">2º Ano</option>
                    <option value="3">3º Ano</option>
                    <option value="4">4º Ano</option>
                    <option value="5">5º Ano</option>
                    <option value="6">6º Ano</option>
                    <option value="7">7º Ano</option>
                    <option value="8">8º Ano</option>
                    <option value="9">9º Ano</option>
                </select>
            </div>

            <!-- Seleção de Turma -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Turma</label>
                <select id="selectTurma" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Todas as turmas</option>
                    <option value="A">Turma A</option>
                    <option value="B">Turma B</option>
                    <option value="C">Turma C</option>
                    <option value="D">Turma D</option>
                    <option value="E">Turma E</option>
                </select>
            </div>

            <!-- Busca por Nome -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Buscar Aluno</label>
                <div class="relative">
                    <input type="text" 
                           id="searchAluno" 
                           class="w-full px-3 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Nome do aluno...">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>

            <!-- Filtro de Fotos -->
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Apenas alunos sem foto</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="filterSemFoto" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <main class="pt-[73px] px-4 pb-6">
        <!-- Loading -->
        <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
            <div class="loading-spinner"></div>
        </div>

        <!-- Contador de Alunos -->
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">
                Total: <span id="totalAlunos" class="font-medium">0</span> alunos
            </div>
            <div class="text-sm text-gray-600">
                Exibindo: <span id="alunosExibidos" class="font-medium">0</span> alunos
            </div>
        </div>

        <!-- Grid de Alunos -->
        <div id="alunosGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <!-- Os cards dos alunos serão inseridos aqui via JavaScript -->
        </div>

        <!-- Mensagem de Nenhum Aluno -->
        <div id="semAlunos" class="hidden text-center py-8 text-gray-500">
            Nenhum aluno encontrado
        </div>
    </main>

    <script>
        // Verificar se está logado
        function verificarLogin() {
            const logado = sessionStorage.getItem('logado');
            if (logado !== 'true') {
                window.location.href = 'login.html';
                return;
            }
        }

        // Verificar login ao carregar a página
        document.addEventListener('DOMContentLoaded', verificarLogin);

        // Função de logout
        function logout() {
            // Limpar tokens do Supabase
            localStorage.removeItem('sb-access-token');
            localStorage.removeItem('sb-refresh-token');
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('sb-provider-token');
            
            // Limpar dados de usuário
            localStorage.removeItem('user_session');
            localStorage.removeItem('user');
            sessionStorage.removeItem('logado');
            
            // Limpar todas as chaves que contenham 'supabase'
            Object.keys(localStorage).forEach(key => {
                if (key.includes('supabase')) {
                    localStorage.removeItem(key);
                }
            });
            
            // Limpar sessionStorage
            sessionStorage.clear();
            
            // Limpar todos os cookies
            document.cookie.split(";").forEach(function(c) {
                document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
            });
            
            // Fazer logout do Supabase se disponível
            try {
                const supabase = createSupabaseClient();
                if (supabase) {
                    supabase.auth.signOut();
                }
            } catch (e) {
                console.warn("Não foi possível executar logout do Supabase:", e);
            }
            
            // Última instrução: limpar localStorage completamente
            localStorage.clear();
            
            // Redirecionar para a página de login
            const noCache = new Date().getTime();
            window.location.replace('/auth.html?logout=true&nocache=' + noCache);
        }

        // Estado global
        let escolas = [];
        let alunos = [];
        let filtrosAbertos = false;

        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: type === 'success' ? "#22c55e" : "#ef4444"
                }
            }).showToast();
        }

        // Funções de Loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }

        // Toggle do painel de filtros
        document.getElementById('btnFiltros').addEventListener('click', () => {
            const painel = document.getElementById('painelFiltros');
            filtrosAbertos = !filtrosAbertos;
            
            if (filtrosAbertos) {
                painel.classList.remove('-translate-y-full');
            } else {
                painel.classList.add('-translate-y-full');
            }
        });

        // Carregar escolas
        async function carregarEscolas() {
            try {
                const { data: escolasData, error } = await createSupabaseClient()
                    .from('escolas')
                    .select('id, nome')
                    .order('nome');

                if (error) throw error;

                escolas = escolasData;
                
                // Preencher select de escolas
                const selectEscola = document.getElementById('selectEscola');
                selectEscola.innerHTML = '<option value="">Selecione um colégio</option>';
                
                escolas.forEach(escola => {
                    const option = document.createElement('option');
                    option.value = escola.id;
                    option.textContent = escola.nome;
                    selectEscola.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar escolas:', error);
                showToast('Erro ao carregar escolas: ' + error.message, 'error');
            }
        }

        // Carregar alunos
        async function carregarAlunos(escolaId = '') {
            try {
                showLoading();

                let query = createSupabaseClient()
                    .from('alunos')
                    .select(`
                        id,
                        nome_completo,
                        foto_url,
                        serie,
                        turma,
                        escola_id,
                        escolas (
                            nome
                        ),
                        series (
                            nome
                        ),
                        turmas (
                            nome
                        )
                    `)
                    .order('nome_completo');

                if (escolaId) {
                    query = query.eq('escola_id', escolaId);
                }

                const { data: alunosData, error } = await query;

                if (error) throw error;

                alunos = alunosData;
                await carregarFiltros();
                filtrarEExibirAlunos();
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                showToast('Erro ao carregar alunos: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Carregar séries e turmas para os filtros baseado nos alunos carregados
        async function carregarFiltros() {
            try {
                // Extrair séries e turmas únicas dos alunos carregados
                const seriesUnicas = new Map(); // ID -> {id, nome}
                const turmasUnicas = new Map(); // ID -> {id, nome}

                alunos.forEach(aluno => {
                    if (aluno.serie && aluno.series) {
                        seriesUnicas.set(aluno.serie, {
                            id: aluno.serie,
                            nome: aluno.series.nome
                        });
                    }
                    if (aluno.turma && aluno.turmas) {
                        turmasUnicas.set(aluno.turma, {
                            id: aluno.turma,
                            nome: aluno.turmas.nome
                        });
                    }
                });

                // Preencher select de séries
                const selectSerie = document.getElementById('selectSerie');
                selectSerie.innerHTML = '<option value="">Todas as séries</option>';
                
                Array.from(seriesUnicas.values()).sort((a, b) => a.nome.localeCompare(b.nome)).forEach(serie => {
                    // Encontrar turmas para esta série
                    const turmasDestaSerie = alunos
                        .filter(aluno => aluno.serie === serie.id && aluno.turmas)
                        .map(aluno => aluno.turmas.nome)
                        .filter((nome, index, arr) => nome && arr.indexOf(nome) === index)
                        .sort();
                    
                    const turmasTexto = turmasDestaSerie.length > 0 ? ` (${turmasDestaSerie.join(', ')})` : '';
                    
                    const option = document.createElement('option');
                    option.value = serie.id;
                    option.textContent = `${serie.nome}${turmasTexto}`;
                    selectSerie.appendChild(option);
                });

                // Preencher select de turmas
                const selectTurma = document.getElementById('selectTurma');
                selectTurma.innerHTML = '<option value="">Todas as turmas</option>';
                
                Array.from(turmasUnicas.values()).sort((a, b) => a.nome.localeCompare(b.nome)).forEach(turma => {
                    // Encontrar séries para esta turma
                    const seriesDestaTurma = alunos
                        .filter(aluno => aluno.turma === turma.id && aluno.series)
                        .map(aluno => aluno.series.nome)
                        .filter((nome, index, arr) => nome && arr.indexOf(nome) === index)
                        .sort();
                    
                    const seriesTexto = seriesDestaTurma.length > 0 ? ` (${seriesDestaTurma.join(', ')})` : '';
                    
                    const option = document.createElement('option');
                    option.value = turma.id;
                    option.textContent = `${turma.nome}${seriesTexto}`;
                    selectTurma.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar filtros:', error);
                showToast('Erro ao carregar filtros: ' + error.message, 'error');
            }
        }

        // Função para verificar se é uma foto padrão
        function isFotoPadrao(url) {
            if (!url) return true;
            
            const fotosDefault = [
                'freepik.com',
                'circulo-azul-com-usuario-branco',
                '78370-4707'
            ];
            
            return fotosDefault.some(padrao => url.toLowerCase().includes(padrao.toLowerCase()));
        }

        // Filtrar e exibir alunos
        function filtrarEExibirAlunos() {
            const termoBusca = document.getElementById('searchAluno').value.toLowerCase().trim();
            const apenasAlunosSemFoto = document.getElementById('filterSemFoto').checked;
            const serieSelecionada = document.getElementById('selectSerie').value;
            const turmaSelecionada = document.getElementById('selectTurma').value;
            
            const alunosFiltrados = alunos.filter(aluno => {
                const matchesNome = !termoBusca || 
                    (aluno.nome_completo && aluno.nome_completo.toLowerCase().includes(termoBusca));
                
                const semFotoValida = !aluno.foto_url || isFotoPadrao(aluno.foto_url);
                const matchesFoto = !apenasAlunosSemFoto || (apenasAlunosSemFoto && semFotoValida);
                
                const matchesSerie = !serieSelecionada || aluno.serie == serieSelecionada;
                const matchesTurma = !turmaSelecionada || aluno.turma == turmaSelecionada;
                
                return matchesNome && matchesFoto && matchesSerie && matchesTurma;
            });

            // Atualizar contadores
            document.getElementById('totalAlunos').textContent = alunos.length;
            document.getElementById('alunosExibidos').textContent = alunosFiltrados.length;

            const gridAlunos = document.getElementById('alunosGrid');
            const semAlunos = document.getElementById('semAlunos');

            if (alunosFiltrados.length === 0) {
                gridAlunos.classList.add('hidden');
                semAlunos.classList.remove('hidden');
                return;
            }

            gridAlunos.classList.remove('hidden');
            semAlunos.classList.add('hidden');

            // Exibir alunos
            gridAlunos.innerHTML = alunosFiltrados.map(aluno => {
                const semFotoValida = !aluno.foto_url || isFotoPadrao(aluno.foto_url);
                
                // Formatação usando os nomes das séries e turmas
                const nomeSerie = aluno.series?.nome || 'Série não informada';
                const nomeTurma = aluno.turmas?.nome || 'Turma não informada';
                
                return `
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="relative">
                            <div class="aspect-square bg-gray-100 flex items-center justify-center overflow-hidden">
                                ${!semFotoValida
                                    ? `<img src="${aluno.foto_url}" alt="${aluno.nome_completo}" class="w-full h-full object-cover">` 
                                    : `<i class="ph ph-user text-4xl text-gray-400"></i>`
                                }
                            </div>
                            <button onclick="alterarFoto('${aluno.id}')" 
                                    class="absolute bottom-2 right-2 w-10 h-10 bg-white rounded-full shadow-lg hover:bg-gray-50 flex items-center justify-center">
                                <i class="ph ph-camera text-gray-700"></i>
                            </button>
                        </div>
                        <div class="p-3">
                            <h3 class="font-medium text-gray-900 text-sm line-clamp-2">${aluno.nome_completo || 'Sem nome'}</h3>
                            <p class="text-gray-500 text-xs mt-1">
                                ${nomeSerie} - ${nomeTurma}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Função para alterar foto
        async function alterarFoto(alunoId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    showLoading();

                    // Primeiro, buscar dados do aluno para saber a escola
                    const { data: aluno, error: alunoError } = await createSupabaseClient()
                        .from('alunos')
                        .select('id, escola_id')
                        .eq('id', alunoId)
                        .single();

                    if (alunoError) throw alunoError;

                    // Excluir todos os registros existentes do aluno na tabela aluno_dispositivo
                    const { error: deleteError } = await createSupabaseClient()
                        .from('aluno_dispositivo')
                        .delete()
                        .eq('aluno', alunoId);

                    if (deleteError) throw deleteError;

                    // Buscar todos os dispositivos ativos da escola
                    const { data: dispositivos, error: dispositivosError } = await createSupabaseClient()
                        .from('dispositivos')
                        .select('id')
                        .eq('escola_id', aluno.escola_id)
                        .eq('status', 'ATIVO')
                        .is('soft_delete', null);

                    if (dispositivosError) throw dispositivosError;

                    // Buscar whatsapp do usuário logado
                    const usuarioId = '1b84f6c8-7a6e-404b-aca6-874b676d7bd8';
                    const { data: userData, error: userError } = await createSupabaseClient()
                        .from('usuarios')
                        .select('whatsapp')
                        .eq('id', usuarioId)
                        .single();

                    if (userError) throw userError;

                    // Criar novos registros para todos os dispositivos
                    if (dispositivos.length > 0) {
                        const novosRegistros = dispositivos.map(dispositivo => ({
                            id_dispositivo: dispositivo.id,
                            aluno: alunoId,
                            escola: aluno.escola_id,
                            numero_de_quem_cadastrou: userData.whatsapp
                        }));

                        const { error: insertError } = await createSupabaseClient()
                            .from('aluno_dispositivo')
                            .insert(novosRegistros);

                        if (insertError) throw insertError;
                    }

                    // Upload da foto para o bucket
                    const fileName = `aluno_${alunoId}_${Date.now()}.jpg`;
                    const filePath = `alunos/${fileName}`;

                    const { error: uploadError } = await createSupabaseClient()
                        .storage
                        .from('fotos_alunos')
                        .upload(filePath, file, {
                            contentType: 'image/jpeg',
                            upsert: true
                        });

                    if (uploadError) throw uploadError;

                    // Obter URL pública
                    const { data: publicUrlData } = createSupabaseClient()
                        .storage
                        .from('fotos_alunos')
                        .getPublicUrl(filePath);

                    // Atualizar URL da foto e marcar para atualizar no dispositivo
                    const { error: updateError } = await createSupabaseClient()
                        .from('alunos')
                        .update({
                            foto_url: publicUrlData.publicUrl,
                            mudar_no_dispositivo: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', alunoId);

                    if (updateError) throw updateError;

                    showToast('Foto atualizada com sucesso!');
                    
                    // Recarregar alunos
                    await carregarAlunos(document.getElementById('selectEscola').value);
                } catch (error) {
                    console.error('Erro ao atualizar foto:', error);
                    showToast('Erro ao atualizar foto: ' + error.message, 'error');
                } finally {
                    hideLoading();
                }
            };

            input.click();
        }

        // Event Listeners
        document.getElementById('selectEscola').addEventListener('change', (e) => {
            // Limpar filtros ao trocar de escola
            document.getElementById('selectSerie').value = '';
            document.getElementById('selectTurma').value = '';
            document.getElementById('searchAluno').value = '';
            document.getElementById('filterSemFoto').checked = false;
            
            carregarAlunos(e.target.value);
        });

        document.getElementById('selectSerie').addEventListener('change', () => {
            filtrarEExibirAlunos();
        });

        document.getElementById('selectTurma').addEventListener('change', () => {
            filtrarEExibirAlunos();
        });

        document.getElementById('searchAluno').addEventListener('input', () => {
            filtrarEExibirAlunos();
        });

        document.getElementById('filterSemFoto').addEventListener('change', () => {
            filtrarEExibirAlunos();
        });

        // Controles do Modal de Cadastro
        const modal = document.getElementById('modalCadastro');
        const btnCadastrar = document.getElementById('btnCadastrar');
        const btnFecharModal = document.getElementById('btnFecharModal');
        const btnCancelar = document.getElementById('btnCancelar');
        const formCadastro = document.getElementById('formCadastro');
        const fotoAluno = document.getElementById('foto_aluno');
        const previewFoto = document.getElementById('preview_foto');
        const placeholderFoto = document.getElementById('placeholder_foto');

        // Abrir modal
        btnCadastrar.addEventListener('click', () => {
            modal.classList.remove('hidden');
            carregarDadosEscola();
        });

        // Fechar modal
        [btnFecharModal, btnCancelar].forEach(btn => {
            btn.addEventListener('click', () => {
                modal.classList.add('hidden');
                formCadastro.reset();
                previewFoto.classList.add('hidden');
                placeholderFoto.classList.remove('hidden');
            });
        });

        // Preview da foto
        fotoAluno.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewFoto.src = e.target.result;
                    previewFoto.classList.remove('hidden');
                    placeholderFoto.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Carregar dados da escola
        async function carregarDadosEscola() {
            try {
                // Carregar turmas com suas séries
                const { data: turmas, error: turmasError } = await createSupabaseClient()
                    .from('turmas')
                    .select(`
                        id, 
                        nome,
                        serie_id,
                        series (
                            id,
                            nome
                        )
                    `)
                    .eq('escola_id', 21)
                    .is('soft_delete', null)
                    .order('nome');

                if (turmasError) throw turmasError;

                const selectTurma = document.getElementById('turma');
                selectTurma.innerHTML = '<option value="">Selecione uma turma</option>';
                turmas.forEach(turma => {
                    const option = document.createElement('option');
                    option.value = turma.id;
                    option.textContent = `${turma.nome} - ${turma.series?.nome || 'Série não informada'}`;
                    option.dataset.serieId = turma.serie_id;
                    option.dataset.serieNome = turma.series?.nome || 'Série não informada';
                    selectTurma.appendChild(option);
                });

                // Event listener para atualizar informação da série
                selectTurma.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const serieInfo = document.getElementById('serie_info');
                    const serieInput = document.getElementById('serie');
                    
                    if (this.value) {
                        const serieNome = selectedOption.dataset.serieNome;
                        serieInfo.textContent = `Série: ${serieNome}`;
                        serieInput.value = selectedOption.dataset.serieId;
                    } else {
                        serieInfo.textContent = '';
                        serieInput.value = '';
                    }
                });

            } catch (error) {
                console.error('Erro ao carregar dados da escola:', error);
                showToast('Erro ao carregar dados da escola', 'error');
            }
        }

        // Cadastrar aluno
        formCadastro.addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                showLoading();

                const formData = new FormData(formCadastro);
                const alunoData = {
                    nome_completo: formData.get('nome_completo'),
                    registro_aluno: formData.get('registro_aluno'),
                    escola_id: 21,
                    genero: formData.get('genero'),
                    data_nascimento: formData.get('data_nascimento'),
                    turma: parseInt(formData.get('turma')),
                    serie: parseInt(formData.get('serie'))
                };

                // Upload da foto
                const fotoFile = document.getElementById('foto_aluno').files[0];
                if (fotoFile) {
                    const fileName = `aluno_${Date.now()}.jpg`;
                    const filePath = `alunos/${fileName}`;

                    const { error: uploadError } = await createSupabaseClient()
                        .storage
                        .from('fotos_alunos')
                        .upload(filePath, fotoFile, {
                            contentType: 'image/jpeg',
                            upsert: true
                        });

                    if (uploadError) throw uploadError;

                    const { data: publicUrlData } = createSupabaseClient()
                        .storage
                        .from('fotos_alunos')
                        .getPublicUrl(filePath);

                    alunoData.foto_url = publicUrlData.publicUrl;
                }

                // Inserir aluno
                const { data: aluno, error: alunoError } = await createSupabaseClient()
                    .from('alunos')
                    .insert([alunoData])
                    .select()
                    .single();

                if (alunoError) throw alunoError;

                // Buscar dispositivos da escola
                const { data: dispositivos, error: dispositivosError } = await createSupabaseClient()
                    .from('dispositivos')
                    .select('id')
                    .eq('escola_id', 21)
                    .eq('status', 'ATIVO')
                    .is('soft_delete', null);

                if (dispositivosError) throw dispositivosError;

                // ID fixo do usuário para cadastro
                const usuarioId = '1b84f6c8-7a6e-404b-aca6-874b676d7bd8';

                // Buscar whatsapp do usuário
                const { data: userData, error: userError } = await createSupabaseClient()
                    .from('usuarios')
                    .select('whatsapp')
                    .eq('id', usuarioId)
                    .single();

                if (userError) throw userError;

                // Inserir em aluno_dispositivo para cada dispositivo
                for (const dispositivo of dispositivos) {
                    await createSupabaseClient()
                        .from('aluno_dispositivo')
                        .insert({
                            id_dispositivo: dispositivo.id,
                            aluno: aluno.id,
                            escola: 21,
                            numero_de_quem_cadastrou: userData.whatsapp
                        });
                }

                showToast('Aluno cadastrado com sucesso!');
                modal.classList.add('hidden');
                formCadastro.reset();
                carregarAlunos('21'); // Recarregar lista de alunos

            } catch (error) {
                console.error('Erro ao cadastrar aluno:', error);
                showToast('Erro ao cadastrar aluno: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await carregarEscolas();
                await carregarAlunos();

                // Remover preloader
                const preloader = document.querySelector('.preloader');
                setTimeout(() => {
                    preloader.style.opacity = '0';
                    setTimeout(() => {
                        preloader.style.display = 'none';
                    }, 200);
                }, 500);
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao carregar o sistema', 'error');
            }
        });
    </script>
</body>
</html> 