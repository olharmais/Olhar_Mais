<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Perfil respocionista</title>
    <meta name="description" content="OlharMais - Perfil respocionista">
    <meta name="theme-color" content="#005ae2">
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon.svg">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9',
                        'logo-blue': '#005ae2'
                    }
                }
            }
        }
    </script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config -->
    <script src="/config/supabase.js"></script>
    
    <!-- IMask para máscaras -->
    <script src="https://unpkg.com/imask"></script>
    
    <style>
        body {
            background: linear-gradient(180deg, #E6F0FF 0%, #FFFFFF 100%);
            min-height: 100vh;
            padding-bottom: 60px;
        }
        
        .logo-olharmais {
            background: linear-gradient(90deg, #005ae2 0%, #3988ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .container {
            max-width: 992px !important;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Animação de loading */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.' }
            40% { content: '..' }
            60% { content: '...' }
            80%, 100% { content: '' }
        }
        
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 9999px;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
            width: 24px;
            height: 24px;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4 flex items-center">
            <h1 class="text-2xl font-bold logo-olharmais">OlharMais</h1>
            <div class="ml-auto">
                <a href="notificacoes_respo.html" id="notifications-btn" class="text-gray-600 hover:text-primary transition-colors relative">
                    <i class="ph ph-bell text-xl"></i>
                    <span class="absolute -top-0.5 -right-0.5 w-2 h-2 bg-red-500 rounded-full"></span>
                </a>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Cabeçalho -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Meu Perfil</h2>
            <p class="text-gray-600">Gerencie suas informações pessoais</p>
        </div>
        
        <!-- Formulário de Perfil -->
        <form id="perfil-form" class="bg-white rounded-lg shadow p-6">
            <!-- Foto de Perfil -->
            <div class="mb-8 flex flex-col items-center">
                <label for="foto-input" class="cursor-pointer">
                    <div class="w-24 h-24 rounded-full overflow-hidden bg-gray-100 mb-3 relative group">
                        <img id="foto-perfil" src="/assets/img/avatar-placeholder.png" alt="Foto de perfil" 
                             class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="ph ph-camera text-white text-2xl"></i>
                        </div>
                        <!-- Loading Overlay -->
                        <div id="foto-loading" class="loading-overlay hidden">
                            <i class="ph ph-spinner loading-spinner"></i>
                        </div>
                    </div>
                    <span class="text-primary hover:text-primary-dark text-sm flex items-center justify-center gap-1">
                        <i class="ph ph-camera"></i> <span id="texto-alterar-foto">Alterar foto</span>
                    </span>
                </label>
                <input type="file" id="foto-input" class="hidden" accept="image/*">
            </div>
            
            <!-- Dados Pessoais -->
            <div class="space-y-6">
                <!-- Nome -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <input type="text" id="nome" name="nome" 
                           class="w-full h-[44px] border border-gray-300 rounded-lg px-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all"
                           placeholder="Seu nome completo">
                </div>
                
                <!-- WhatsApp -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp</label>
                    <div class="space-y-3">
                        <div class="relative">
                            <input type="tel" id="whatsapp" name="whatsapp" 
                                   class="w-full h-[44px] border border-primary rounded-lg pl-14 pr-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all bg-white"
                                   placeholder="(00) 00000-0000"
                                   readonly>
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">(55)</span>
                        </div>
                        <button type="button" id="alterar-whatsapp" 
                                class="w-full h-[44px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors">
                            Alterar WhatsApp
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Botões -->
            <div class="mt-8 flex flex-col gap-3">
                <button type="submit" 
                        class="w-full h-[44px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors px-6">
                    Salvar Alterações
                </button>
                <button type="button" onclick="window.location.href='home_respo.html'" 
                        class="w-full h-[44px] border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors px-6">
                    Cancelar
                </button>
            </div>
        </form>
    </main>
    
    <!-- Modal de Verificação do Número Antigo -->
    <div id="modal-verificacao-antigo" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Verificar Número Atual</h3>
            <p class="text-gray-600 mb-4">Para sua segurança, enviamos um código de verificação para seu número atual.</p>
            
            <div class="flex gap-2 mb-6">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
            </div>
            
            <div class="flex gap-2">
                <button type="button" id="confirmar-codigo-antigo" 
                        class="flex-1 bg-primary text-white rounded-lg py-2.5 font-medium hover:bg-primary-dark transition-colors">
                    Confirmar
                </button>
                <button type="button" id="cancelar-verificacao-antigo" 
                        class="flex-1 border border-gray-300 text-gray-700 rounded-lg py-2.5 font-medium hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Novo Número -->
    <div id="modal-novo-numero" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Novo Número de WhatsApp</h3>
            <p class="text-gray-600 mb-4">Digite o novo número que você deseja cadastrar:</p>
            
            <div class="mb-6">
                <div class="relative">
                    <input type="tel" id="novo-whatsapp" 
                           class="w-full h-[44px] border border-primary rounded-lg pl-14 pr-4 focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none transition-all"
                           placeholder="(00) 00000-0000">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">(55)</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button type="button" id="confirmar-novo-numero" 
                        class="flex-1 h-[44px] bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-colors">
                    Continuar
                </button>
                <button type="button" id="cancelar-novo-numero" 
                        class="flex-1 h-[44px] border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Verificação do Novo Número -->
    <div id="modal-verificacao-novo" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Verificar Novo Número</h3>
            <p class="text-gray-600 mb-4">Enviamos um código de verificação para o novo número.</p>
            
            <div class="flex gap-2 mb-6">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
                <input type="text" maxlength="1" class="w-12 h-12 border border-gray-300 rounded-lg text-center text-xl">
            </div>
            
            <div class="flex gap-2">
                <button type="button" id="confirmar-codigo-novo" 
                        class="flex-1 bg-primary text-white rounded-lg py-2.5 font-medium hover:bg-primary-dark transition-colors">
                    Confirmar
                </button>
                <button type="button" id="cancelar-verificacao-novo" 
                        class="flex-1 border border-gray-300 text-gray-700 rounded-lg py-2.5 font-medium hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Component -->
    <div id="toast" class="fixed top-4 right-4 z-[9999] hidden">
        <div class="px-4 py-2 rounded-lg shadow-lg text-white font-medium"></div>
    </div>
    
    <!-- Navbar JavaScript Alternativo -->
    <script src="botoes_respo.js"></script>
    
    <!-- Fallback: iframe com navbar (oculto se JS alternativo funcionar) -->
    <iframe id="navbar-iframe" src="navbar_respo.html" frameborder="0" scrolling="no" class="w-full fixed bottom-0 left-0 right-0 h-[60px] sm:hidden" allow="*" sandbox="allow-scripts allow-same-origin"></iframe>
    
    <script>
        // Toast Component
        const Toast = {
            element: document.getElementById('toast'),
            timeoutId: null,
            
            show(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                clearTimeout(this.timeoutId);
                
                const inner = this.element.querySelector('div');
                inner.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                inner.textContent = message;
                
                this.element.classList.remove('hidden');
                
                this.timeoutId = setTimeout(() => {
                    this.element.classList.add('hidden');
                }, 3000);
            },

            // Métodos auxiliares para conveniência
            error(message) {
                this.show(message, 'error');
            },
            
            success(message) {
                this.show(message, 'success');
            },
            
            warning(message) {
                this.show(message, 'warning');
            },
            
            info(message) {
                this.show(message, 'info');
            }
        };
        
        // Estado da aplicação
        let estadoApp = {
            codigoAntigo: '',
            codigoNovo: '',
            whatsappAtual: '',
            whatsappNovo: '',
            fotoUrl: ''
        };
        
        // Variável global para armazenar a instância da máscara
        let whatsappMask;
        let novoWhatsappMask;
        
        // Aplicar máscara ao WhatsApp
        function aplicarMascaraWhatsApp(elemento) {
            return IMask(elemento, {
                mask: '(00) 00000-0000',
                lazy: false,
                onComplete: function() {
                    // Callback quando a máscara está completa
                    console.log('Máscara completa:', this.value);
                }
            });
        }
        
        // Carregar dados do perfil
        async function carregarPerfil() {
            try {
                const userSession = JSON.parse(localStorage.getItem('user_session'));
                if (!userSession) {
                    window.location.href = '../auth.html';
                    return;
                }

                const supabase = createSupabaseClient();
                
                // Buscar dados atualizados do usuário
                const { data: userData, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', userSession.id)
                    .single();

                if (error) throw error;

                // Preencher nome
                document.getElementById('nome').value = userData.nome || '';

                // Formatar e preencher WhatsApp
                const whatsappInput = document.getElementById('whatsapp');
                if (userData.whatsapp) {
                    let whatsapp = userData.whatsapp;
                    // Remover prefixo 55 se existir
                    if (whatsapp.startsWith('55')) {
                        whatsapp = whatsapp.substring(2);
                    }
                    // Aplicar máscara ao WhatsApp
                    whatsappMask = aplicarMascaraWhatsApp(whatsappInput);
                    whatsappMask.value = whatsapp;
                } else {
                    whatsappMask = aplicarMascaraWhatsApp(whatsappInput);
                }

                // Aplicar máscara ao campo de novo WhatsApp
                const novoWhatsappInput = document.getElementById('novo-whatsapp');
                novoWhatsappMask = aplicarMascaraWhatsApp(novoWhatsappInput);

                // Carregar foto de perfil
                const fotoPerfilElement = document.getElementById('foto-perfil');
                if (userData.foto_url) {
                    fotoPerfilElement.src = userData.foto_url;
                    estadoApp.fotoUrl = userData.foto_url; // Armazenar a foto atual
                } else {
                    fotoPerfilElement.src = '../assets/img/user.png';
                }

                // Atualizar dados da sessão com informações mais recentes
                localStorage.setItem('user_session', JSON.stringify(userData));

            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                Toast.show('Erro ao carregar dados do perfil', 'error');
            }
        }

        // Carregar perfil quando a página carregar
        window.addEventListener('DOMContentLoaded', carregarPerfil);
        
        // Upload de foto com loading
        document.getElementById('foto-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                // Mostrar loading
                const loadingOverlay = document.getElementById('foto-loading');
                const textoAlterarFoto = document.getElementById('texto-alterar-foto');
                loadingOverlay.classList.remove('hidden');
                textoAlterarFoto.textContent = 'Enviando foto...';
                
                const supabase = createSupabaseClient();
                
                // Criar nome único para o arquivo
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;
                
                // Upload do arquivo
                const { data, error } = await supabase.storage
                    .from('profile-photos')
                    .upload(fileName, file);
                
                if (error) throw error;
                
                // Obter URL pública
                const { data: { publicUrl } } = supabase.storage
                    .from('profile-photos')
                    .getPublicUrl(fileName);
                
                // Atualizar foto no perfil e no banco
                document.getElementById('foto-perfil').src = publicUrl;
                estadoApp.fotoUrl = publicUrl;

                // Atualizar URL no banco de dados
                const { error: updateError } = await supabase
                    .from('usuarios')
                    .update({ foto_url: publicUrl })
                    .eq('id', JSON.parse(localStorage.getItem('user_session')).id);

                if (updateError) throw updateError;
                
                Toast.success('Foto atualizada com sucesso');
                
            } catch (error) {
                console.error('Erro ao fazer upload da foto:', error);
                Toast.error('Erro ao atualizar foto. Tente novamente.');
            } finally {
                // Ocultar loading e restaurar texto
                document.getElementById('foto-loading').classList.add('hidden');
                document.getElementById('texto-alterar-foto').textContent = 'Alterar foto';
            }
        });
        
        // Funções para manipulação dos modais
        function mostrarModal(id) {
            document.getElementById(id).classList.remove('hidden');
            const primeiroInput = document.querySelector(`#${id} input`);
            if (primeiroInput) primeiroInput.focus();
        }
        
        function ocultarModal(id) {
            document.getElementById(id).classList.add('hidden');
            const inputs = document.querySelectorAll(`#${id} input`);
            inputs.forEach(input => input.value = '');
        }
        
        // Configurar navegação entre inputs dos códigos
        function configurarInputsCodigo(modalId) {
            const inputs = document.querySelectorAll(`#${modalId} input[type="text"]`);
            
            inputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
        }
        
        // Configurar modais de verificação
        configurarInputsCodigo('modal-verificacao-antigo');
        configurarInputsCodigo('modal-verificacao-novo');
        
        // Processo de alteração de WhatsApp
        document.getElementById('alterar-whatsapp').addEventListener('click', async function() {
            try {
                const whatsapp = whatsappMask.unmaskedValue;
                
                if (!whatsapp || whatsapp.length !== 11) {
                    Toast.show('Digite um número de WhatsApp válido', 'error');
                    return;
                }

                // Gerar código para número atual
                estadoApp.codigoAntigo = Math.random().toString().substr(2, 6);
                
                // Enviar código via WhatsApp
                const response = await fetch('https://7017.bubblewhats.com/send-message', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'NTExYzUxZGIzMjc2MTAxZjJhNzhkMjAx',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jid: `55${whatsapp}`,
                        message: `Seu código de verificação do OlharMais é: ${estadoApp.codigoAntigo}`
                    })
                });
                
                if (!response.ok) throw new Error('Erro ao enviar código');
                
                mostrarModal('modal-verificacao-antigo');
                
            } catch (error) {
                console.error('Erro ao iniciar verificação:', error);
                Toast.show('Erro ao enviar código. Tente novamente.', 'error');
            }
        });
        
        // Confirmar código do número antigo
        document.getElementById('confirmar-codigo-antigo').addEventListener('click', function() {
            const inputs = document.querySelectorAll('#modal-verificacao-antigo input');
            const codigo = Array.from(inputs).map(input => input.value).join('');
            
            if (codigo === estadoApp.codigoAntigo) {
                ocultarModal('modal-verificacao-antigo');
                mostrarModal('modal-novo-numero');
            } else {
                Toast.show('Código incorreto', 'error');
            }
        });
        
        // Confirmar novo número
        document.getElementById('confirmar-novo-numero').addEventListener('click', async function() {
            try {
                const novoNumero = novoWhatsappMask.unmaskedValue;
                
                if (!novoNumero || novoNumero.length !== 11) {
                    Toast.show('Digite um número de WhatsApp válido', 'error');
                    return;
                }

                // Verificar se o número já existe
                const supabase = createSupabaseClient();
                const { data: usuarioExistente, error: errorBusca } = await supabase
                    .from('usuarios')
                    .select('id')
                    .eq('whatsapp', `55${novoNumero}`)
                    .single();

                if (errorBusca && errorBusca.code !== 'PGRST116') {
                    throw errorBusca;
                }

                if (usuarioExistente) {
                    Toast.show('Este número de WhatsApp já está cadastrado para outro usuário', 'error');
                    return;
                }
                
                // Gerar código para o novo número
                estadoApp.codigoNovo = Math.random().toString().substr(2, 6);
                estadoApp.whatsappNovo = novoNumero;
                
                // Enviar código para o novo número
                const response = await fetch('https://7017.bubblewhats.com/send-message', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'NTExYzUxZGIzMjc2MTAxZjJhNzhkMjAx',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jid: `55${novoNumero}`,
                        message: `Seu código de verificação do OlharMais é: ${estadoApp.codigoNovo}`
                    })
                });
                
                if (!response.ok) throw new Error('Erro ao enviar código');
                
                ocultarModal('modal-novo-numero');
                mostrarModal('modal-verificacao-novo');
                
            } catch (error) {
                console.error('Erro ao enviar código:', error);
                Toast.show('Erro ao enviar código. Tente novamente.', 'error');
            }
        });
        
        // Confirmar código do novo número
        document.getElementById('confirmar-codigo-novo').addEventListener('click', async function() {
            try {
                const inputs = document.querySelectorAll('#modal-verificacao-novo input');
                const codigo = Array.from(inputs).map(input => input.value).join('');
                
                if (codigo === estadoApp.codigoNovo) {
                    // Verificar novamente se o número já existe (dupla verificação)
                    const supabase = createSupabaseClient();
                    const { data: usuarioExistente, error: errorBusca } = await supabase
                        .from('usuarios')
                        .select('id')
                        .eq('whatsapp', `55${estadoApp.whatsappNovo}`)
                        .single();

                    if (errorBusca && errorBusca.code !== 'PGRST116') {
                        throw errorBusca;
                    }

                    if (usuarioExistente) {
                        Toast.show('Este número de WhatsApp já está cadastrado para outro usuário', 'error');
                        ocultarModal('modal-verificacao-novo');
                        return;
                    }

                    // Atualizar o WhatsApp no input e no estado
                    whatsappMask.value = estadoApp.whatsappNovo;
                    
                    // Adicionar o prefixo 55 antes de salvar
                    const whatsappComPrefixo = `55${estadoApp.whatsappNovo}`;
                    
                    // Atualizar no banco de dados
                    const { error: updateError } = await supabase
                        .from('usuarios')
                        .update({ 
                            whatsapp: whatsappComPrefixo 
                        })
                        .eq('id', JSON.parse(localStorage.getItem('user_session')).id);

                    if (updateError) throw updateError;
                    
                    ocultarModal('modal-verificacao-novo');
                    Toast.show('WhatsApp atualizado com sucesso', 'success');
                    
                    // Atualizar na sessão local com o prefixo
                    const userSession = JSON.parse(localStorage.getItem('user_session'));
                    userSession.whatsapp = whatsappComPrefixo;
                    localStorage.setItem('user_session', JSON.stringify(userSession));
                    
                } else {
                    Toast.show('Código incorreto', 'error');
                }
            } catch (error) {
                console.error('Erro ao confirmar código:', error);
                Toast.show('Erro ao atualizar WhatsApp. Tente novamente.', 'error');
            }
        });
        
        // Botões de cancelar
        document.getElementById('cancelar-verificacao-antigo').addEventListener('click', () => ocultarModal('modal-verificacao-antigo'));
        document.getElementById('cancelar-novo-numero').addEventListener('click', () => ocultarModal('modal-novo-numero'));
        document.getElementById('cancelar-verificacao-novo').addEventListener('click', () => ocultarModal('modal-verificacao-novo'));
        
        // Manipular envio do formulário
        document.getElementById('perfil-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const nome = document.getElementById('nome').value.trim();
                const whatsapp = whatsappMask.unmaskedValue;
                
                if (!nome) {
                    Toast.error('Nome é obrigatório');
                    return;
                }
                
                // Adicionar o prefixo 55 antes de salvar
                const whatsappComPrefixo = whatsapp ? `55${whatsapp}` : '';
                
                // Inicializar Supabase
                const supabase = createSupabaseClient();

                // Preparar dados para atualização
                const dadosAtualizacao = {
                    nome: nome,
                    whatsapp: whatsappComPrefixo
                };

                // Só incluir foto_url se uma nova foto foi enviada
                if (estadoApp.fotoUrl !== document.getElementById('foto-perfil').src) {
                    dadosAtualizacao.foto_url = estadoApp.fotoUrl;
                }
                
                // Atualizar perfil no banco de dados
                const { error: updateError } = await supabase
                    .from('usuarios')
                    .update(dadosAtualizacao)
                    .eq('id', JSON.parse(localStorage.getItem('user_session')).id);

                if (updateError) throw updateError;
                
                // Atualizar dados na sessão local
                const userSession = JSON.parse(localStorage.getItem('user_session'));
                userSession.nome = nome;
                userSession.whatsapp = whatsappComPrefixo;
                if (dadosAtualizacao.foto_url) {
                    userSession.foto_url = dadosAtualizacao.foto_url;
                }
                localStorage.setItem('user_session', JSON.stringify(userSession));
                
                Toast.success('Perfil atualizado com sucesso');
                
                // Redirecionar após 2 segundos
                setTimeout(() => {
                    window.location.href = 'home_respo.html';
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao atualizar perfil:', error);
                Toast.error('Erro ao atualizar perfil. Tente novamente.');
            }
        });

        // Atualizar WhatsApp
        async function atualizarWhatsapp() {
            try {
                const userSession = JSON.parse(localStorage.getItem('user_session'));
                if (!userSession) {
                    window.location.href = '../auth.html';
                    return;
                }

                const novoWhatsapp = whatsappMask.unmaskedValue;
                if (!novoWhatsapp) {
                    Toast.show('Por favor, insira um número de WhatsApp válido', 'error');
                    return;
                }

                // Adicionar prefixo 55 se não existir
                const whatsappComPrefixo = novoWhatsapp.startsWith('55') 
                    ? novoWhatsapp 
                    : `55${novoWhatsapp}`;

                const supabase = createSupabaseClient();
                const { data, error } = await supabase
                    .from('usuarios')
                    .update({ whatsapp: whatsappComPrefixo })
                    .eq('id', userSession.id);

                if (error) throw error;

                // Atualizar sessão do usuário
                userSession.whatsapp = whatsappComPrefixo;
                localStorage.setItem('user_session', JSON.stringify(userSession));

                Toast.show('WhatsApp atualizado com sucesso!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error('Erro ao atualizar WhatsApp:', error);
                Toast.show('Erro ao atualizar WhatsApp', 'error');
            }
        }

        // Ocultar o iframe se o JS alternativo carregar
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof adicionarBarraNavegacao === 'function') {
                const iframe = document.getElementById('navbar-iframe');
                if (iframe) iframe.style.display = 'none';
            }
        });
    </script>
</body>
</html> 