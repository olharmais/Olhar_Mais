<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Login</title>
    <meta name="description" content="Sistema OlharMais - Plataforma de gerenciamento">
    <meta name="theme-color" content="#005ae2">
    
    
    <!-- PWA -->
    <meta name="theme-color" content="#005ae2">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="OlharMais">
    
    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OlharMais">
    
    <!-- Manifest e Icons -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/icons/icon-16x16.png">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://olharmais.com/">
    <meta property="og:title" content="OlharMais - Gestão Escolar e Segurança de Alunos">
    <meta property="og:description" content="Plataforma completa para transformar a maneira como você gerencia sua Escola. Gestão escolar e segurança de alunos em um só lugar.">
    <meta property="og:image" content="https://olharmais.com/metatag.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://olharmais.com/">
    <meta property="twitter:title" content="OlharMais - Gestão Escolar e Segurança de Alunos">
    <meta property="twitter:description" content="Plataforma completa para transformar a maneira como você gerencia sua Escola. Gestão escolar e segurança de alunos em um só lugar.">
    <meta property="twitter:image" content="https://olharmais.com/metatag.png">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script>
        // Carrega Phosphor Icons com modo no-cors para evitar erro CORS
        const loadPhosphorIcons = async () => {
            try {
                // Tenta o carregamento normal primeiro
                await import('https://unpkg.com/@phosphor-icons/web');
                console.log('Phosphor Icons carregado com sucesso');
            } catch (error) {
                console.warn('Tentando carregar Phosphor Icons em modo no-cors...');
                // Fallback: cria um link para o CSS com modo no-cors
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://unpkg.com/@phosphor-icons/web/styles.css';
                document.head.appendChild(link);
            }
        };
        loadPhosphorIcons();
    </script>
    
    <!-- PWA Register -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js', {
                        scope: '/'
                    });
                    console.log('ServiceWorker registrado com sucesso:', registration.scope);
                } catch (error) {
                    console.error('Falha ao registrar o ServiceWorker:', error);
                }
            });
        }

        // Adicionar ao homescreen
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
    
    <!-- Verificador de ícones -->
    <script src="/check-icons.js"></script>
    
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9',
                        'logo-blue': '#005ae2'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            background: linear-gradient(180deg, #E6F0FF 0%, #FFFFFF 100%);
            min-height: 100vh;
        }
        
        .logo-olharmais {
            background: linear-gradient(90deg, #005ae2 0%, #3988ff 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body class="font-sans">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Menu de suporte será inserido via JavaScript -->
        <div id="support-menu-container"></div>
        
        <div class="flex flex-col items-center justify-center min-h-[90vh]">
            <!-- Logo -->
            <h1 class="text-5xl font-extrabold logo-olharmais mb-6">OlharMais</h1>
            
            <!-- Cabeçalho -->
            <div class="text-center mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-2">Seja Bem-Vindo</h2>
                <p class="text-gray-600">Digite seu telefone para receber o código</p>
            </div>
            
            <!-- Formulário -->
            <div class="w-full">
                <!-- Abas -->
                <div class="flex mb-6 border-b border-gray-200">
                    <button id="login-tab" class="tab-active flex-1 py-3 font-medium text-center border-b-2 border-primary text-primary">Entrar</button>
                    <button id="register-tab" class="flex-1 py-3 font-medium text-center text-gray-500">Cadastrar</button>
                </div>
                
                <!-- Formulário de Login -->
                <div id="login-form" class="space-y-4">
                    <div class="relative">
                        <input type="tel" id="phone" placeholder="Telefone com DDD" required
                            class="w-full py-4 pl-12 pr-4 border border-gray-300 rounded-full focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none text-base transition-all">
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M231.88,175.08A56.26,56.26,0,0,1,176,224C96.6,224,32,159.4,32,80A56.26,56.26,0,0,1,80.92,24.12a16,16,0,0,1,16.62,9.52l21.12,47.15,0,.12a16,16,0,0,1-.28,14.84,16.2,16.2,0,0,1-3,3.88l-17.28,17.28a72.08,72.08,0,0,0,39.34,39.34l17.28-17.28a16.2,16.2,0,0,1,3.88-3,16,16,0,0,1,14.84-.28l.12,0,47.15,21.12a16,16,0,0,1,9.52,16.62Z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    <button id="login-btn" type="submit" class="w-full h-[57px] bg-primary text-white rounded-full font-semibold text-lg hover:bg-primary-dark transition-colors flex items-center justify-center gap-2">
                        <span>Receber Código</span>
                        <div class="hidden">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>
                    </button>
                    
                    <!-- Campos do código de verificação (inicialmente ocultos) -->
                    <div id="login-verification-code" class="hidden">
                        <p class="text-center mb-3 text-gray-600">Digite o código recebido via WhatsApp:</p>
                        <div class="flex justify-between gap-2">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" maxlength="1" class="login-code-input w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" maxlength="1" class="login-code-input w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" maxlength="1" class="login-code-input w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" maxlength="1" class="login-code-input w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" maxlength="1" class="login-code-input w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                            <input type="number" pattern="[0-9]*" inputmode="numeric" maxlength="1" class="login-code-input w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                        </div>
                        <button id="verify-login-code" class="w-full h-[57px] bg-primary text-white py-3 rounded-full font-semibold text-lg hover:bg-primary-dark transition-colors flex items-center justify-center gap-2 mt-4">
                            <span>Entrar</span>
                            <div class="hidden">
                                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Formulário de Cadastro -->
                <div id="register-form" class="space-y-6 hidden">
                    <!-- Cards de Perfil -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="profile-card" data-type="GESTOR">
                            <div class="p-4 border rounded-xl hover:border-primary hover:bg-primary-light transition-all cursor-pointer flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#006AFF" viewBox="0 0 256 256">
                                    <path d="M244.8,150.4a8,8,0,0,1-11.2-1.6A51.6,51.6,0,0,0,192,128a8,8,0,0,1-7.37-4.89,8,8,0,0,1,0-6.22A8,8,0,0,1,192,112a24,24,0,1,0-23.24-30,8,8,0,1,1-15.5-4A40,40,0,1,1,219,117.51a67.94,67.94,0,0,1,27.43,21.68A8,8,0,0,1,244.8,150.4ZM190.92,212a8,8,0,1,1-13.84,8,57,57,0,0,0-98.16,0,8,8,0,1,1-13.84-8,72.06,72.06,0,0,1,33.74-29.92,48,48,0,1,1,58.36,0A72.06,72.06,0,0,1,190.92,212ZM128,176a32,32,0,1,0-32-32A32,32,0,0,0,128,176Z"></path>
                                </svg>
                                <span class="mt-2 font-medium">Gestor</span>
                            </div>
                        </div>
                        <div class="profile-card" data-type="NUTRICIONISTA">
                            <div class="p-4 border rounded-xl hover:border-primary hover:bg-primary-light transition-all cursor-pointer flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#006AFF" viewBox="0 0 256 256">
                                    <path d="M208,40H168a8,8,0,0,0-8,8v30.13A48.9,48.9,0,0,0,144,104a47.51,47.51,0,0,0,5.6,22.39,52.91,52.91,0,0,1-11.52,15l-32.42,28.32A16,16,0,0,1,84,176v32a8,8,0,0,0,8,8H216a8,8,0,0,0,8-8V48A8,8,0,0,0,216,40ZM104,176a28.77,28.77,0,0,0,8.42-6l32.43-28.33a68.68,68.68,0,0,0,15-19.41A47.76,47.76,0,0,0,192,104V48h16v88H107.59A67.93,67.93,0,0,1,104,176ZM177.13,180a76.4,76.4,0,0,1-16,20H151.72a59.79,59.79,0,0,0,25.41-20ZM32,104a32,32,0,1,1,32,32A32,32,0,0,1,32,104Z"></path>
                                </svg>
                                <span class="mt-2 font-medium">Nutricionista</span>
                            </div>
                        </div>
                        <div class="profile-card" data-type="PROFISSIONAL">
                            <div class="p-4 border rounded-xl hover:border-primary hover:bg-primary-light transition-all cursor-pointer flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#006AFF" viewBox="0 0 256 256">
                                    <path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40ZM40,56H216v32H40ZM216,200H40V104H216v96Zm-24-24a8,8,0,0,1-8,8H72a8,8,0,0,1,0-16H184A8,8,0,0,1,192,176Zm0-32a8,8,0,0,1-8,8H72a8,8,0,0,1,0-16H184A8,8,0,0,1,192,144Z"></path>
                                </svg>
                                <span class="mt-2 font-medium">Profissional</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Etapa WhatsApp -->
                    <div class="whatsapp-step hidden">
                        <div class="relative">
                            <input type="tel" id="register-phone" placeholder="WhatsApp com DDD" required
                                class="w-full py-4 pl-12 pr-4 border border-gray-300 rounded-full focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none text-base transition-all">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M187.58,144.84l-32-16a8,8,0,0,0-8,.5l-14.69,9.8a40.55,40.55,0,0,1-16-16l9.8-14.69a8,8,0,0,0,.5-8l-16-32A8,8,0,0,0,104,64a40,40,0,0,0-40,40,88.1,88.1,0,0,0,88,88,40,40,0,0,0,40-40A8,8,0,0,0,187.58,144.84Z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <button id="send-code" class="w-full h-[57px] mt-4 bg-primary text-white rounded-full font-medium hover:bg-primary-dark transition-all focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 active:transform active:scale-[0.99] flex items-center justify-center">
                            <span>Receber Código</span>
                        </button>
                        
                        <!-- Campo de Código -->
                        <div class="verification-code hidden mt-6">
                            <p class="text-center mb-3 text-gray-600">Digite o código recebido via WhatsApp:</p>
                            <div class="flex justify-between gap-2">
                                <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                                <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                                <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                                <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                                <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                                <input type="text" maxlength="1" class="w-12 h-12 text-center text-2xl border-2 border-gray-400 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none shadow-sm">
                            </div>
                            <button id="verify-code" class="w-full h-12 bg-primary text-white py-3 rounded-full font-semibold text-lg hover:bg-primary-dark transition-colors flex items-center justify-center gap-2 mt-4">
                                <span>Verificar</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Etapa de Dados Pessoais (oculto inicialmente) -->
                    <div class="user-details-step hidden mt-6">
                        <h3 class="text-xl font-semibold text-center mb-6">Complete seu perfil</h3>
                        
                        <!-- Foto de Perfil -->
                        <div class="mb-6">
                            <p class="mb-2 text-gray-700 text-center">Foto de Perfil</p>
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative">
                                    <div id="profile-preview" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                    </div>
                                    <input type="file" id="profile-photo" class="hidden" accept="image/*">
                                    <button id="upload-photo-btn" class="mt-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium flex items-center justify-center w-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="mr-2" viewBox="0 0 256 256">
                                            <path d="M208,56H180.28L166.65,35.56A8,8,0,0,0,160,32H96a8,8,0,0,0-6.65,3.56L75.71,56H48A24,24,0,0,0,24,80V192a24,24,0,0,0,24,24H208a24,24,0,0,0,24-24V80A24,24,0,0,0,208,56Zm8,136a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V80a8,8,0,0,1,8-8H80a8,8,0,0,0,6.66-3.56L100.28,48h55.43l13.63,20.44A8,8,0,0,0,176,72h32a8,8,0,0,1,8,8ZM128,88a44,44,0,1,0,44,44A44.05,44.05,0,0,0,128,88Zm0,72a28,28,0,1,1,28-28A28,28,0,0,1,128,160Z"></path>
                                        </svg>
                                        <span>Escolher Foto</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Primeiro Nome -->
                        <div class="relative mb-4">
                            <input type="text" id="first-name" placeholder="Primeiro Nome" required
                                class="w-full py-4 pl-12 pr-4 border border-gray-300 rounded-full focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none text-base transition-all">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64,64,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-36.06-28.75,48,48,0,1,0-59.4,0,79.66,79.66,0,0,0-36.06,28.75,88,88,0,1,1,131.52,0Z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Sobrenome -->
                        <div class="relative mb-4">
                            <input type="text" id="last-name" placeholder="Sobrenome" required
                                class="w-full py-4 pl-12 pr-4 border border-gray-300 rounded-full focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none text-base transition-all">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM74.08,197.5a64,64,0,0,1,107.84,0,87.83,87.83,0,0,1-107.84,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.76,66.41a79.66,79.66,0,0,0-36.06-28.75,48,48,0,1,0-59.4,0,79.66,79.66,0,0,0-36.06,28.75,88,88,0,1,1,131.52,0Z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Cidade -->
                        <div class="relative mb-4">
                            <select id="city" required
                                class="w-full py-4 pl-12 pr-4 border border-gray-300 rounded-full focus:border-primary focus:ring-2 focus:ring-primary-light focus:outline-none text-base transition-all">
                                <option value="">Selecione uma cidade</option>
                                <!-- As opções serão carregadas via JavaScript -->
                            </select>
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M128,16a88.1,88.1,0,0,0-88,88c0,75.3,80,132.17,83.41,134.55a8,8,0,0,0,9.18,0C136,236.17,216,179.3,216,104A88.1,88.1,0,0,0,128,16Zm0,56a32,32,0,1,1-32,32A32,32,0,0,1,128,72Z"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Sexo -->
                        <div class="mb-4">
                            <p class="mb-2 text-gray-700 pl-2">Sexo</p>
                            <div class="grid grid-cols-3 gap-4">
                                <label class="flex items-center justify-center p-3 h-12 border border-gray-300 rounded-xl cursor-pointer hover:border-primary hover:bg-primary-light transition-all">
                                    <input type="radio" name="gender" value="M" class="mr-2">
                                    <span>Masculino</span>
                                </label>
                                <label class="flex items-center justify-center p-3 h-12 border border-gray-300 rounded-xl cursor-pointer hover:border-primary hover:bg-primary-light transition-all">
                                    <input type="radio" name="gender" value="F" class="mr-2">
                                    <span>Feminino</span>
                                </label>
                                <label class="flex items-center justify-center p-3 h-12 border border-gray-300 rounded-xl cursor-pointer hover:border-primary hover:bg-primary-light transition-all">
                                    <input type="radio" name="gender" value="O" class="mr-2">
                                    <span>Outro</span>
                                </label>
                            </div>
                        </div>
                        
                        <button id="register-submit" class="w-full h-12 bg-primary text-white py-3 rounded-full font-semibold text-lg hover:bg-primary-dark transition-colors flex items-center justify-center gap-2 mt-4">
                            <span>Concluir Cadastro</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Component -->
    <div id="toast" class="fixed top-4 right-4 z-[9999] hidden animate-fade-in">
        <div class="px-4 py-2 rounded-lg shadow-lg text-white font-medium"></div>
    </div>

    <script type="module">
        // Inicialização do cliente Supabase usando a configuração padronizada
        const supabase = createSupabaseClient();
        
        /**
         * Verifica a sessão existente
         */
        function verificarSessao() {
            const session = localStorage.getItem('user_session');
            if (!session) return null;
            
            try {
                const userData = JSON.parse(session);
                return userData;
            } catch (e) {
                console.error('Erro ao processar sessão:', e);
                return null;
            }
        }
        
        /**
         * Redireciona o usuário com base no tipo
         */
        function redirecionarUsuario(tipo) {
            switch(tipo) {
                case 'RESPONSÁVEL':
                    window.location.href = '/responsavel/home_respo.html';
                    break;
                case 'NUTRICIONISTA':
                    window.location.href = '/nutricionista/home_nutri.html';
                    break;
                case 'GESTOR':
                    window.location.href = '/gestor/home_gestor.html';
                    break;
                case 'PROFISSIONAL':
                    window.location.href = '/profissional/home_profi.html';
                    break;
                case 'ADMIN':
                    window.location.href = '/admin/dashboard.html';
                    break;
                default:
                    // Para qualquer outro tipo não reconhecido
                    window.location.href = '/dashboard.html';
            }
        }
        
        // Verificar login existente
        const sessaoAtiva = verificarSessao();
        if (sessaoAtiva) {
            console.log('Sessão ativa detectada:', sessaoAtiva);
            redirecionarUsuario(sessaoAtiva.tipo);
        }
        
        /**
         * Envia código de login via WhatsApp
         */
        async function enviarCodigoLogin(whatsapp) {
            try {
                // 1. Formatar o número do telefone
                let phone = whatsapp.replace(/\D/g, '');
                if (!phone.startsWith('55')) {
                    phone = '55' + phone;
                }
                
                console.log('Buscando usuário com whatsapp:', phone);
                
                // 2. Verificar se o usuário existe e está ativo
                const { data: users, error: searchError } = await supabase
                    .from('usuarios')
                    .select('id, nome, tipo, status')
                    .eq('whatsapp', phone);

                // Se não encontrou nenhum usuário
                if (!users || users.length === 0) {
                    console.log('Nenhum usuário encontrado com este número');
                    return { success: false, error: 'Telefone não cadastrado' };
                }

                // Pegar o primeiro usuário encontrado
                const user = users[0];
                
                // 3. Verificar status do usuário
                if (user.status !== 'Ativo') {
                    console.log('Usuário não está ativo:', user.status);
                    return { 
                        success: false, 
                        error: 'Usuário aguardando aprovação',
                        pendingApproval: true 
                    };
                }
                
                // 4. Gerar código de 6 dígitos
                const codigo = Math.floor(100000 + Math.random() * 900000).toString();
                
                // 5. Salvar código e atualizar último login
                const { error: updateError } = await supabase
                    .from('usuarios')
                    .update({ 
                        hash2: codigo, // Usar hash2 para armazenar o código temporariamente
                        ultimo_log: new Date().toISOString()
                    })
                    .eq('id', user.id);
                    
                if (updateError) {
                    console.error('Erro ao salvar código:', updateError);
                    return { success: false, error: 'Erro ao gerar código de acesso' };
                }
                
                // 6. Enviar código via WhatsApp
                const mensagem = `Seu código de acesso ao OlharMais é: ${codigo}\nVálido por 10 minutos.`;
                
                // Usar credenciais diretas para garantir que não haja erros
                const WHATSAPP_API_URL = getWhatsappApiUrl();
                const WHATSAPP_API_KEY = getWhatsappApiKey();
                
                const response = await fetch(WHATSAPP_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': WHATSAPP_API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jid: phone,
                        message: mensagem
                    })
                });

                const result = await response.json();
                console.log('Resposta WhatsApp:', result);
                
                if (!response.ok) {
                    throw new Error('Erro ao enviar mensagem de WhatsApp');
                }
                
                return { success: true };
            } catch (error) {
                console.error('Erro ao enviar código:', error);
                return { success: false, error: 'Erro ao enviar código' };
            }
        }

        /**
         * Autenticar usuário por código enviado via WhatsApp
         */
        async function autenticarUsuario(whatsapp, codigo) {
            try {
                // 1. Formatar o número do telefone
                let phone = whatsapp.replace(/\D/g, '');
                if (!phone.startsWith('55')) {
                    phone = '55' + phone;
                }
                
                // 2. Buscar usuário pelo telefone
                const { data: user, error: searchError } = await supabase
                    .from('usuarios')
                    .select('id, nome, sobrenome, tipo, whatsapp, hash2, status')
                    .eq('whatsapp', phone)
                    .single();

                // 3. Validar resultado da busca
                if (searchError) {
                    console.error('Erro na busca:', searchError);
                    return { success: false, error: 'Erro ao verificar código' };
                }

                if (!user) {
                    return { success: false, error: 'Usuário não encontrado' };
                }

                // 4. Verificar código e status
                if (user.hash2 !== codigo) {
                    return { success: false, error: 'Código inválido' };
                }

                if (user.status !== 'Ativo') {
                    return { 
                        success: false, 
                        error: 'Aguardando aprovação',
                        pendingApproval: true
                    };
                }
                
                // 5. Gerar novo hash para sessão
                const sessionHash = await generateHash(Date.now() + user.whatsapp);
                
                // 6. Atualizar dados do usuário
                const { error: updateError } = await supabase
                    .from('usuarios')
                    .update({ 
                        ultimo_log: new Date().toISOString(),
                        hash2: sessionHash // Novo hash para sessão
                    })
                    .eq('id', user.id);
                    
                if (updateError) {
                    console.error('Erro ao atualizar dados:', updateError);
                    return { success: false, error: 'Erro ao atualizar sessão' };
                }
                
                // 7. Salvar sessão (12 meses)
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
                
                localStorage.setItem('user_session', JSON.stringify({
                    id: user.id,
                    nome: user.nome,
                    sobrenome: user.sobrenome || '',
                    whatsapp: user.whatsapp,
                    tipo: user.tipo,
                    token: sessionHash,
                    expiry: oneYearFromNow.toISOString()
                }));
                
                return { success: true, user: user };
            } catch (error) {
                console.error('Erro no processo de login:', error);
                return { success: false, error: 'Erro ao realizar login' };
            }
        }

        // Toast Component
        const Toast = {
            element: document.getElementById('toast'),
            timeoutId: null,
            
            show(message, type = 'info') {
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                clearTimeout(this.timeoutId);
                
                const inner = this.element.querySelector('div');
                inner.className = `px-4 py-2 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                inner.textContent = message;
                
                this.element.classList.remove('hidden');
                
                this.timeoutId = setTimeout(() => {
                    this.element.classList.add('hidden');
                }, 3000);
            },
            
            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            warning(message) { this.show(message, 'warning'); },
            info(message) { this.show(message, 'info'); }
        };

        // Gerar hash
        async function generateHash(text) {
            const msgBuffer = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const phoneInput = document.getElementById('phone');
            const loginBtn = document.getElementById('login-btn');
            const loginVerificationCodeDiv = document.getElementById('login-verification-code');
            const loginCodeInputs = document.querySelectorAll('.login-code-input');
            const verifyLoginCodeBtn = document.getElementById('verify-login-code');
            
            // Aplicar máscara de telefone
            function applyPhoneMask(input) {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value.length <= 2) {
                        e.target.value = value;
                    } else if (value.length <= 6) {
                        e.target.value = `(${value.slice(0, 2)}) ${value.slice(2)}`;
                    } else if (value.length <= 10) {
                        e.target.value = `(${value.slice(0, 2)}) ${value.slice(2, 6)}-${value.slice(6)}`;
                    } else {
                        e.target.value = `(${value.slice(0, 2)}) ${value.slice(2, 7)}-${value.slice(7, 11)}`;
                    }
                });
            }
            
            // Aplicar máscara no telefone
            if (phoneInput) {
                applyPhoneMask(phoneInput);
            }
            
            // Aplicar máscara nos outros campos de telefone
            const registerPhone = document.getElementById('register-phone');
            if (registerPhone) {
                applyPhoneMask(registerPhone);
            }
            
            // Manipular os inputs do código de verificação
            const handleCodeInputs = (inputs) => {
                inputs.forEach((input, index) => {
                    input.addEventListener('input', function(e) {
                        // Remove qualquer caractere não numérico
                        this.value = this.value.replace(/\D/g, '');
                        
                        // Se digitou um número
                        if (this.value) {
                            // Move para o próximo campo
                            if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                            }
                        }
                    });
    
                    // Permite voltar com backspace
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && !this.value && index > 0) {
                            // Se backspace e campo vazio, volta para o anterior
                            inputs[index - 1].focus();
                        } else if (e.key === 'ArrowLeft' && index > 0) {
                            // Seta esquerda move para o campo anterior
                            inputs[index - 1].focus();
                        } else if (e.key === 'ArrowRight' && index < inputs.length - 1) {
                            // Seta direita move para o próximo campo
                            inputs[index + 1].focus();
                        }
                    });
    
                    // Permite colar o código completo
                    input.addEventListener('paste', function(e) {
                        e.preventDefault();
                        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                        const numbers = pastedText.replace(/\D/g, '').split('');
                        
                        // Preenche os campos com os números colados
                        inputs.forEach((input, i) => {
                            if (numbers[i]) {
                                input.value = numbers[i];
                                // Move o foco para o próximo campo vazio
                                if (i < inputs.length - 1) {
                                    inputs[i + 1].focus();
                                }
                            }
                        });
                    });
                });
            };
            
            // Manipulador para inputs de código
            handleCodeInputs(loginCodeInputs);
            handleCodeInputs(document.querySelectorAll('.verification-code input'));
            
            // Navegação entre abas
            loginTab.addEventListener('click', function() {
                loginTab.classList.add('tab-active', 'border-b-2', 'border-primary', 'text-primary');
                loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('tab-active', 'border-b-2', 'border-primary', 'text-primary');
                registerTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            });
            
            registerTab.addEventListener('click', function() {
                registerTab.classList.add('tab-active', 'border-b-2', 'border-primary', 'text-primary');
                registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('tab-active', 'border-b-2', 'border-primary', 'text-primary');
                loginTab.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            });
            
            // Registrar os manipuladores de eventos para os cards de perfil
            const profileCards = document.querySelectorAll('.profile-card');
            profileCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Remover a seleção atual
                    profileCards.forEach(c => {
                        c.querySelector('div').classList.remove('border-primary', 'bg-primary-light');
                        c.querySelector('div').classList.add('border-gray-300');
                    });
                    
                    // Adicionar a seleção ao card clicado
                    const cardDiv = this.querySelector('div');
                    cardDiv.classList.remove('border-gray-300');
                    cardDiv.classList.add('border-primary', 'bg-primary-light');
                    
                    // Mostrar o próximo passo (WhatsApp)
                    document.querySelector('.whatsapp-step').classList.remove('hidden');
                    
                    // Armazenar o tipo selecionado
                    const selectedType = this.getAttribute('data-type');
                    console.log('Tipo selecionado:', selectedType);
                    
                    // Opcional: scroll para o próximo passo
                    document.querySelector('.whatsapp-step').scrollIntoView({ behavior: 'smooth' });
                });
            });
            
            // Login: enviar código
            if (loginBtn) {
                loginBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    const phone = phoneInput.value;
                    if (!phone) {
                        Toast.warning('Digite seu número de WhatsApp');
                        return;
                    }
                    
                    try {
                        // Mostrar spinner
                        const spinner = loginBtn.querySelector('div');
                        const textSpan = loginBtn.querySelector('span');
                        spinner.classList.remove('hidden');
                        textSpan.textContent = 'Enviando...';
                        loginBtn.disabled = true;
                        
                        // Enviar código
                        const resultado = await enviarCodigoLogin(phone);
                        
                        if (resultado.success) {
                            // Mostrar campos de código
                            loginVerificationCodeDiv.classList.remove('hidden');
                            loginBtn.classList.add('hidden');
                            
                            Toast.success('Código enviado para seu WhatsApp');
                            loginCodeInputs[0].focus();
                        } else {
                            if (resultado.pendingApproval) {
                                // Redirecionar para tela de aguardando aprovação sem mostrar mensagem de erro
                                window.location.href = '/aprovacao.html';
                                return;
                            }
                            
                            Toast.error(resultado.error || 'Erro ao enviar código');
                        }
                    } catch (error) {
                        console.error('Erro:', error);
                        Toast.error('Erro ao processar solicitação');
                    } finally {
                        // Esconder spinner
                        const spinner = loginBtn.querySelector('div');
                        const textSpan = loginBtn.querySelector('span');
                        spinner.classList.add('hidden');
                        textSpan.textContent = 'Receber Código';
                        loginBtn.disabled = false;
                    }
                });
            }
            
            // Verificar código de login
            if (verifyLoginCodeBtn) {
                verifyLoginCodeBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    const code = Array.from(loginCodeInputs).map(input => input.value).join('');
                    if (code.length !== 6) {
                        Toast.warning('Digite o código completo');
                        return;
                    }
                    
                    try {
                        // Mostrar spinner
                        const spinner = verifyLoginCodeBtn.querySelector('div');
                        const textSpan = verifyLoginCodeBtn.querySelector('span');
                        spinner.classList.remove('hidden');
                        textSpan.textContent = 'Verificando...';
                        verifyLoginCodeBtn.disabled = true;
                        
                        // Verificar código
                        const resultado = await autenticarUsuario(phoneInput.value, code);
                        
                        if (resultado.success) {
                            Toast.success('Login realizado com sucesso!');
                            
                            // Redirecionar com base no tipo de usuário
                            setTimeout(() => {
                                redirecionarUsuario(resultado.user.tipo);
                            }, 1000);
                        } else {
                            if (resultado.pendingApproval) {
                                // Redirecionar diretamente para tela de aguardando aprovação
                                window.location.href = '/aprovacao.html';
                                return;
                            }
                            
                            Toast.error(resultado.error || 'Código inválido');
                        }
                    } catch (error) {
                        console.error('Erro:', error);
                        Toast.error('Erro ao processar solicitação');
                    } finally {
                        // Esconder spinner
                        const spinner = verifyLoginCodeBtn.querySelector('div');
                        const textSpan = verifyLoginCodeBtn.querySelector('span');
                        spinner.classList.add('hidden');
                        textSpan.textContent = 'Entrar';
                        verifyLoginCodeBtn.disabled = false;
                    }
                });
            }
            
            // Manipular o envio de código para registro
            const sendCodeBtn = document.getElementById('send-code');
            if (sendCodeBtn) {
                sendCodeBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    // Validar se um perfil foi selecionado
                    const selectedCard = document.querySelector('.profile-card div.border-primary');
                    if (!selectedCard) {
                        Toast.warning('Selecione um tipo de perfil');
                        return;
                    }
                    
                    const selectedType = selectedCard.closest('.profile-card').getAttribute('data-type');
                    const phone = document.getElementById('register-phone').value;
                    
                    if (!phone) {
                        Toast.warning('Digite seu número de WhatsApp');
                        return;
                    }
                    
                    try {
                        // Mostrar estado de carregamento
                        this.innerHTML = '<span class="flex items-center"><i class="ph ph-spinner animate-spin mr-2"></i> Enviando...</span>';
                        this.disabled = true;
                        
                        // Formatar número de telefone
                        let phoneFormatado = phone.replace(/\D/g, '');
                        if (!phoneFormatado.startsWith('55')) {
                            phoneFormatado = '55' + phoneFormatado;
                        }
                        
                        console.log('Telefone formatado:', phoneFormatado);
                        
                        // Verificar se usuário já existe
                        const { data: usuarioExistente, error: erroConsulta } = await supabase
                            .from('usuarios')
                            .select('*')
                            .eq('whatsapp', phoneFormatado);
                            
                        if (erroConsulta) {
                            console.error('Erro ao verificar usuário:', erroConsulta);
                            Toast.error('Erro ao verificar usuário');
                            return;
                        }
                            
                        if (usuarioExistente && usuarioExistente.length > 0) {
                            Toast.warning('Este número já está cadastrado. Faça login.');
                            return;
                        }
                            
                        // Gerar código de verificação
                        const codigoVerificacao = Math.floor(100000 + Math.random() * 900000).toString();
                                
                        // Salvar dados temporários no localStorage para uso posterior
                        localStorage.setItem('temp_register_phone', phoneFormatado);
                        localStorage.setItem('temp_register_code', codigoVerificacao);
                        localStorage.setItem('temp_register_type', selectedType);
                        localStorage.setItem('temp_register_time', Date.now().toString());
                                
                        // Enviar mensagem WhatsApp com credenciais diretas
                        const mensagem = `Seu código de verificação para o OlharMais é: *${codigoVerificacao}*\nEste código expira em 15 minutos.`;
                        
                        // Usar credenciais diretas para garantir que não haja erros
                        const WHATSAPP_API_URL = getWhatsappApiUrl();
                        const WHATSAPP_API_KEY = getWhatsappApiKey();
                        
                        console.log('Enviando mensagem para:', phoneFormatado);
                        
                        const response = await fetch(WHATSAPP_API_URL, {
                            method: 'POST',
                            headers: {
                                'Authorization': WHATSAPP_API_KEY,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                jid: phoneFormatado,
                                message: mensagem
                            })
                        });

                        const result = await response.json();
                        console.log('Resposta WhatsApp:', result);
                        
                        if (!response.ok) {
                            throw new Error('Erro ao enviar mensagem de WhatsApp');
                        }
                            
                        // Mostrar campo de código após envio bem-sucedido
                        document.querySelector('.verification-code').classList.remove('hidden');
                        document.querySelector('.verification-code input:first-child').focus();
                        
                        Toast.success('Código enviado para seu WhatsApp');
                    } catch (error) {
                        console.error('Erro:', error);
                        Toast.error('Erro ao enviar código');
                    } finally {
                        // Restaurar botão
                        this.innerHTML = '<span>Receber Código</span>';
                        this.disabled = false;
                    }
                });
            }

            // Verificar código e passar para a próxima etapa (dados pessoais)
            const verifyCodeBtn = document.getElementById('verify-code');
            if (verifyCodeBtn) {
                verifyCodeBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    const codeInputs = document.querySelectorAll('.verification-code input');
                    const code = Array.from(codeInputs).map(input => input.value).join('');
                    
                    if (code.length !== 6) {
                        Toast.warning('Digite o código completo');
                        return;
                    }
                    
                    try {
                        // Mostrar spinner
                        this.innerHTML = '<span class="flex items-center"><i class="ph ph-spinner animate-spin mr-2"></i> Verificando...</span>';
                        this.disabled = true;
                        
                        // Recuperar dados temporários do localStorage
                        const tempCode = localStorage.getItem('temp_register_code');
                        const tempTime = localStorage.getItem('temp_register_time');
                        
                        if (!tempCode || !tempTime) {
                            Toast.error('Sessão de verificação expirada. Tente novamente.');
                            return;
                        }
                        
                        // Verificar se o código não expirou (15 minutos)
                        const now = Date.now();
                        const codeTime = parseInt(tempTime);
                        const timeDiff = (now - codeTime) / 1000 / 60; // em minutos
                        
                        if (timeDiff > 15) {
                            Toast.error('Código expirado. Solicite um novo código.');
                            return;
                        }
                        
                        // Verificar se o código é válido
                        if (code !== tempCode) {
                            Toast.error('Código inválido. Verifique e tente novamente.');
                            return;
                        }
                        
                        // Código válido - mostrar formulário de dados pessoais
                        document.querySelector('.whatsapp-step').classList.add('hidden');
                        document.querySelector('.user-details-step').classList.remove('hidden');
                        
                        Toast.success('Código verificado! Complete seu cadastro');
                        
                    } catch (error) {
                        console.error('Erro:', error);
                        Toast.error('Erro ao processar solicitação');
                    } finally {
                        // Restaurar botão
                        this.innerHTML = '<span>Verificar</span>';
                        this.disabled = false;
                    }
                });
            }

            // Preview da foto de perfil
            const profilePhotoInput = document.getElementById('profile-photo');
            const profilePreview = document.getElementById('profile-preview');
            const uploadPhotoBtn = document.getElementById('upload-photo-btn');

            if (uploadPhotoBtn && profilePhotoInput && profilePreview) {
                // Clicar no botão abre o seletor de arquivo
                uploadPhotoBtn.addEventListener('click', function() {
                    profilePhotoInput.click();
                });
                
                // Quando uma foto é selecionada, mostrar preview
                profilePhotoInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            // Remover o ícone de usuário
                            profilePreview.innerHTML = '';
                            
                            // Criar elemento de imagem
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'w-full h-full object-cover';
                            profilePreview.appendChild(img);
                        }
                        
                        reader.readAsDataURL(this.files[0]);
                    }
                });
            }

            // Carregar cidades para o dropdown
            async function loadCidades() {
                try {
                    const { data: cidades, error } = await supabase
                        .from('cidades')
                        .select('id, nome')
                        .order('nome');
                    
                    if (error) throw error;
                    
                    const cidadeSelect = document.getElementById('city');
                    if (cidades && cidades.length > 0) {
                        cidades.forEach(cidade => {
                            const option = document.createElement('option');
                            option.value = cidade.id;
                            option.textContent = cidade.nome;
                            cidadeSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "Nenhuma cidade disponível";
                        cidadeSelect.appendChild(option);
                    }
                } catch (error) {
                    console.error('Erro ao carregar cidades:', error);
                    Toast.error('Erro ao carregar lista de cidades');
                }
            }
            
            // Carregar cidades ao selecionar a aba de registro
            registerTab.addEventListener('click', function() {
                // Se estiver vazio, carregue as cidades
                const cidadeSelect = document.getElementById('city');
                if (cidadeSelect.options.length <= 1) {
                    loadCidades();
                }
            });

            // Completar cadastro
            const registerSubmitBtn = document.getElementById('register-submit');
            if (registerSubmitBtn) {
                registerSubmitBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    
                    // Validar campos
                    const firstName = document.getElementById('first-name').value;
                    const lastName = document.getElementById('last-name').value;
                    const cityId = document.getElementById('city').value;
                    const gender = document.querySelector('input[name="gender"]:checked')?.value;
                    
                    if (!firstName) {
                        Toast.warning('Digite seu primeiro nome');
                        return;
                    }
                    
                    if (!lastName) {
                        Toast.warning('Digite seu sobrenome');
                        return;
                    }
                    
                    if (!cityId) {
                        Toast.warning('Selecione uma cidade');
                        return;
                    }
                    
                    if (!gender) {
                        Toast.warning('Selecione seu sexo');
                        return;
                    }
                    
                    try {
                        // Mostrar loading
                        this.innerHTML = '<span class="flex items-center"><i class="ph ph-spinner animate-spin mr-2"></i> Cadastrando...</span>';
                        this.disabled = true;
                        
                        // Recuperar dados do localStorage
                        const phone = localStorage.getItem('temp_register_phone');
                        const selectedType = localStorage.getItem('temp_register_type');
                        
                        if (!phone || !selectedType) {
                            Toast.error('Dados de registro perdidos. Inicie o cadastro novamente.');
                            return;
                        }
                        
                        let fotoUrl = null;
                        
                        // Fazer upload da foto se existir
                        if (profilePhotoInput.files && profilePhotoInput.files[0]) {
                            const file = profilePhotoInput.files[0];
                            const fileExt = file.name.split('.').pop();
                            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
                            
                            // Upload para o bucket profile-photos
                            const { data: uploadData, error: uploadError } = await supabase
                                .storage
                                .from('profile-photos')
                                .upload(fileName, file);
                            
                            if (uploadError) {
                                console.error('Erro ao fazer upload da foto:', uploadError);
                                Toast.warning('Não foi possível fazer o upload da foto, mas o cadastro continuará');
                            } else {
                                // Gerar URL pública
                                const { data: { publicUrl } } = supabase
                                    .storage
                                    .from('profile-photos')
                                    .getPublicUrl(fileName);
                                
                                fotoUrl = publicUrl;
                            }
                        }
                        
                        // Gerar hash para senha
                        const hash = await generateHash(Date.now() + Math.random().toString());
                        
                        // AGORA sim, criar o usuário
                        const { data: novoUsuario, error: erroCriarUsuario } = await supabase
                            .from('usuarios')
                            .insert([{
                                nome: firstName,
                                sobrenome: lastName,
                                whatsapp: phone,
                                tipo: selectedType,
                                hash1: hash,
                                hash2: '',
                                foto_url: fotoUrl,
                                status: 'Inativo', // Valor permitido no enum status_usuario
                                ultimo_log: new Date().toISOString(),
                                cidade: parseInt(cityId), // Usando 'cidade' como número inteiro
                                genero: gender // Adicionando o campo genero
                            }])
                            .select();
                                
                        if (erroCriarUsuario) {
                            console.error('Erro ao criar usuário:', erroCriarUsuario);
                            Toast.error('Erro ao completar cadastro');
                            return;
                        }
                            
                        // Limpar dados temporários
                        localStorage.removeItem('temp_register_phone');
                        localStorage.removeItem('temp_register_code');
                        localStorage.removeItem('temp_register_type');
                        localStorage.removeItem('temp_register_time');
                                
                        // Sucesso - mostrar mensagem e redirecionar
                        Toast.success('Cadastro realizado com sucesso!');
                        setTimeout(() => {
                            window.location.href = '/aprovacao.html';
                        }, 1500);
                        
                    } catch (error) {
                        console.error('Erro:', error);
                        Toast.error('Erro ao processar solicitação');
                    } finally {
                        // Restaurar botão
                        this.innerHTML = '<span>Concluir Cadastro</span>';
                        this.disabled = false;
                    }
                });
            }
        });

        // Funções auxiliares
        function formatarTelefoneParaAPI(telefone) {
            // Remove todos os caracteres não numéricos
            let numero = telefone.replace(/\D/g, '');
            
            // Se o número não começar com 55 (Brasil), adiciona
            if (!numero.startsWith('55')) {
                numero = '55' + numero;
            }
            
            return numero;
        }

        function gerarCodigoVerificacao() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Função para mostrar mensagem de erro com link para cadastro
        function mostrarErroComLinkCadastro(mensagem) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'mt-4 text-center';
            errorContainer.innerHTML = `
                <p class="text-red-500 mb-2">${mensagem}</p>
                <button onclick="mostrarCadastro()" 
                        class="text-primary hover:text-primary-dark font-medium transition-colors">
                    Clique aqui para se cadastrar
                </button>
            `;
            
            // Limpar mensagens de erro anteriores
            const previousError = document.querySelector('.error-container');
            if (previousError) {
                previousError.remove();
            }
            
            // Adicionar nova mensagem
            document.getElementById('login-form').appendChild(errorContainer);
        }

        // Atualizar a função handleLoginSubmit
        async function handleLoginSubmit(e) {
            e.preventDefault();
            
            const whatsapp = whatsappMask.unmaskedValue;
            const submitButton = document.getElementById('login-submit');
            const buttonText = submitButton.querySelector('span');
            const buttonLoading = submitButton.querySelector('.loading');
            
            if (!whatsapp || whatsapp.length !== 11) {
                Toast.show('Digite um número de WhatsApp válido', 'error');
                return;
            }
            
            try {
                // Mostrar loading
                buttonText.textContent = 'Verificando...';
                buttonLoading.classList.remove('hidden');
                submitButton.disabled = true;
                
                const result = await enviarCodigoLogin(whatsapp);
                
                if (!result.success) {
                    if (result.error === 'Telefone não cadastrado') {
                        mostrarErroComLinkCadastro('Usuário não cadastrado.');
                    } else if (result.pendingApproval) {
                        Toast.show('Usuário aguardando aprovação', 'warning');
                    } else {
                        Toast.show(result.error || 'Erro ao enviar código', 'error');
                    }
                    return;
                }
                
                // Se chegou aqui, deu tudo certo
                // Guardar o número para usar na verificação
                localStorage.setItem('whatsapp_verificacao', whatsapp);
                
                // Mostrar tela de verificação
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('verify-container').classList.remove('hidden');
                
                // Focar no primeiro input
                document.querySelector('#verify-container input').focus();
                
                // Iniciar contador
                iniciarContador();
                
            } catch (error) {
                console.error('Erro no login:', error);
                Toast.show('Erro ao processar login', 'error');
            } finally {
                // Restaurar botão
                buttonText.textContent = 'Entrar';
                buttonLoading.classList.add('hidden');
                submitButton.disabled = false;
            }
        }
    </script>
</body>
</html> 