 
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Dispositivo</title>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header Fixo -->
    <header class="fixed top-0 left-0 right-0 bg-white shadow-sm z-40">
        <div class="px-4 py-3">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-800">OlharMais - Dispositivo</h1>
                <div class="flex items-center space-x-4">
                    <div class="text-sm font-medium text-gray-500">
                        Próxima verificação: <span id="cronometro" class="text-blue-600">60s</span>
                    </div>
                    <span id="statusText" class="text-sm font-medium text-gray-500">Parado</span>
                    <button id="btnPlayPause" class="p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 w-10 h-10 flex items-center justify-center">
                        <i class="ph ph-play-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="pt-[73px] px-4 pb-6">
        <!-- Loading -->
        <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
            <div class="loading-spinner"></div>
        </div>

        <!-- Contador -->
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">
                Pendentes: <span id="totalPendentes" class="font-medium">0</span> fotos
            </div>
            <div class="text-sm text-gray-600">
                Atualizadas: <span id="totalAtualizadas" class="font-medium">0</span> fotos
            </div>
        </div>

        <!-- Lista de Alunos -->
        <div id="alunosLista" class="space-y-4">
            <!-- Os cards dos alunos serão inseridos aqui via JavaScript -->
        </div>

        <!-- Mensagem Vazia -->
        <div id="listaVazia" class="hidden text-center py-8 text-gray-500">
            Nenhuma foto pendente para atualização
        </div>
    </main>

    <script>
        // Configuração do Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#005ae2',
                        'primary-light': '#E6F0FF',
                        'primary-dark': '#004bc9'
                    }
                }
            }
        }

        // Inicializar cliente Supabase
        const supabaseClient = createSupabaseClient();
        
        // Variáveis globais
        let alunosPendentes = [];
        let atualizadas = 0;
        let intervalId = null;
        let cronometroId = null;
        let tempoRestante = 60;
        let isRunning = false;
        let currentDevice = null;

        // Funções de Loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }

        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: type === 'success' ? "#22c55e" : "#ef4444"
                }
            }).showToast();
        }

        // Função para obter sessão do dispositivo
        async function getDeviceSession(ipAddress, login, password) {
            try {
                const ipAddressWithPort = ipAddress.includes(':') ? ipAddress : `${ipAddress}:80`;
                
                const response = await fetch(`http://${ipAddressWithPort}/login.fcgi`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        login: login || 'admin',
                        password: password || 'admin'
                    })
                });

                if (!response.ok) {
                    throw new Error('Erro ao obter sessão do dispositivo');
                }

                const data = await response.json();
                if (!data.session) {
                    throw new Error('Sessão não retornada pelo dispositivo');
                }

                return data.session;
            } catch (error) {
                console.error('Erro ao obter sessão:', error);
                throw new Error('Não foi possível conectar ao dispositivo. Verifique as credenciais e o IP.');
            }
        }

        // Carregar alunos pendentes
        async function carregarAlunosPendentes() {
            try {
                const { data: alunos, error } = await supabaseClient
                    .from('alunos')
                    .select(`
                        id,
                        nome_completo,
                        foto_url,
                        serie,
                        turma,
                        escolas (
                            nome
                        )
                    `)
                    .eq('mudar_no_dispositivo', true)
                    .order('nome_completo');

                if (error) throw error;

                alunosPendentes = alunos;
                atualizarInterface();
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                showToast('Erro ao carregar alunos: ' + error.message, 'error');
            }
        }

        // Atualizar interface
        function atualizarInterface() {
            const lista = document.getElementById('alunosLista');
            const listaVazia = document.getElementById('listaVazia');
            const totalPendentes = document.getElementById('totalPendentes');
            const totalAtualizadas = document.getElementById('totalAtualizadas');

            totalPendentes.textContent = alunosPendentes.length;
            totalAtualizadas.textContent = atualizadas;

            if (alunosPendentes.length === 0) {
                lista.classList.add('hidden');
                listaVazia.classList.remove('hidden');
                return;
            }

            lista.classList.remove('hidden');
            listaVazia.classList.add('hidden');

            lista.innerHTML = alunosPendentes.map(aluno => `
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 rounded-full bg-gray-100 flex-shrink-0 overflow-hidden">
                            ${aluno.foto_url 
                                ? `<img src="${aluno.foto_url}" alt="${aluno.nome_completo}" class="w-full h-full object-cover">` 
                                : `<i class="ph ph-user text-4xl text-gray-400"></i>`
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-900 truncate">${aluno.nome_completo}</h3>
                            <p class="text-sm text-gray-500">${aluno.serie}º Ano - Turma ${aluno.turma}</p>
                            <p class="text-xs text-gray-400">${aluno.escolas?.nome || 'Escola não definida'}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-100 rounded-full">
                                Pendente
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Carregar dados do dispositivo
        async function loadDeviceData() {
            try {
                // Buscar dispositivo no Supabase
                const { data: devices, error } = await supabaseClient
                    .from('dispositivos')
                    .select(`
                        id,
                        camera_id,
                        ip,
                        status,
                        login,
                        senha
                    `)
                    .eq('status', 'ATIVO')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (!devices || devices.length === 0) {
                    showToast('Nenhum dispositivo ativo encontrado', 'error');
                    return;
                }
                
                // Guardar os dados do primeiro dispositivo
                currentDevice = devices[0];
                console.log('Dispositivo carregado:', currentDevice);
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados do dispositivo: ' + error.message, 'error');
            }
        }

        // Função para redimensionar imagem
        async function redimensionarImagem(blob, maxWidth = 1920, maxHeight = 1080) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    // Calcular as novas dimensões mantendo a proporção
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    // Criar canvas com as novas dimensões
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    // Desenhar a imagem redimensionada
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Converter para blob
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.9);
                };
                img.onerror = () => reject(new Error('Erro ao carregar imagem para redimensionamento'));
                img.src = URL.createObjectURL(blob);
            });
        }

        // Simular atualização no dispositivo
        async function atualizarNoDispositivo(aluno) {
            try {
                // Buscar todos os dispositivos onde o aluno está cadastrado
                const { data: alunoDispositivos, error: dispositivoError } = await supabaseClient
                    .from('aluno_dispositivo')
                    .select(`
                        id,
                        aluno,
                        id_do_aluno_no_dispositivo,
                        dispositivos (
                            id,
                            ip,
                            login,
                            senha
                        )
                    `)
                    .eq('aluno', aluno.id);

                if (dispositivoError) throw dispositivoError;

                if (!alunoDispositivos || alunoDispositivos.length === 0) {
                    showToast(`${aluno.nome_completo} não encontrado em nenhum dispositivo`, 'error');
                    // Remover da lista de pendentes mesmo assim
                    alunosPendentes = alunosPendentes.filter(a => a.id !== aluno.id);
                    atualizarInterface();
                    return;
                }

                console.log('Dispositivos encontrados:', alunoDispositivos);

                // Para cada dispositivo, atualizar a foto
                for (const alunoDispositivo of alunoDispositivos) {
                    const dispositivo = alunoDispositivo.dispositivos;
                    if (!dispositivo) continue;

                    // Verificar se temos o ID do aluno no dispositivo
                    if (!alunoDispositivo.id_do_aluno_no_dispositivo) {
                        console.error(`ID do aluno no dispositivo não encontrado para ${aluno.nome_completo} no dispositivo ${dispositivo.ip}`);
                        showToast(`Erro: ID do aluno não encontrado no dispositivo ${dispositivo.ip}`, 'error');
                        continue;
                    }

                    try {
                        // Obter sessão do dispositivo
                        const session = await getDeviceSession(
                            dispositivo.ip,
                            dispositivo.login || 'admin',
                            dispositivo.senha || 'admin'
                        );

                        // Baixar a foto do Supabase
                        console.log('Baixando foto:', aluno.foto_url);
                        const fotoResponse = await fetch(aluno.foto_url);
                        if (!fotoResponse.ok) {
                            throw new Error('Erro ao baixar foto do Supabase');
                        }
                        const fotoBlob = await fotoResponse.blob();

                        // Redimensionar a imagem
                        console.log('Redimensionando imagem...');
                        const fotoRedimensionada = await redimensionarImagem(fotoBlob);
                        console.log('Imagem redimensionada com sucesso');

                        // Converter Blob para ArrayBuffer
                        const arrayBuffer = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = () => reject(new Error('Erro ao converter foto'));
                            reader.readAsArrayBuffer(fotoRedimensionada);
                        });

                        // Enviar foto para o dispositivo usando o ID correto do aluno no dispositivo
                        const timestamp = Math.floor(Date.now() / 1000);
                        const url = `http://${dispositivo.ip}/user_set_image.fcgi?user_id=${alunoDispositivo.id_do_aluno_no_dispositivo}&timestamp=${timestamp}&match=0&session=${session}`;
                        
                        console.log('Enviando foto para:', url);
                        const uploadResponse = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/octet-stream'
                            },
                            body: new Uint8Array(arrayBuffer)
                        });

                        const responseText = await uploadResponse.text();
                        let uploadData;
                        try {
                            uploadData = JSON.parse(responseText);
                        } catch (e) {
                            throw new Error(`Resposta inválida do servidor: ${responseText}`);
                        }

                        if (!uploadResponse.ok) {
                            throw new Error(`Erro ao fazer upload da imagem: ${uploadResponse.status} - ${responseText}`);
                        }
                        
                        if (uploadData.success === false) {
                            const errorMessages = uploadData.errors.map(err => `${err.code}: ${err.message}`).join(', ');
                            throw new Error(`Falha no cadastro da imagem: ${errorMessages}`);
                        }

                        showToast(`Foto de ${aluno.nome_completo} atualizada no dispositivo ${dispositivo.ip}!`);
                        atualizadas++;
                    } catch (deviceError) {
                        console.error(`Erro ao atualizar no dispositivo ${dispositivo.ip}:`, deviceError);
                        showToast(`Erro ao atualizar no dispositivo ${dispositivo.ip}: ${deviceError.message}`, 'error');
                    }
                }

                // Marcar como atualizado no Supabase apenas se atualizou em pelo menos um dispositivo
                if (atualizadas > 0) {
                    const { error: updateError } = await supabaseClient
                        .from('alunos')
                        .update({
                            mudar_no_dispositivo: false
                        })
                        .eq('id', aluno.id);

                    if (updateError) throw updateError;
                }

                // Remover da lista de pendentes
                alunosPendentes = alunosPendentes.filter(a => a.id !== aluno.id);
                atualizarInterface();
            } catch (error) {
                console.error('Erro ao atualizar no dispositivo:', error);
                showToast('Erro ao atualizar no dispositivo: ' + error.message, 'error');
            }
        }

        // Função para atualizar cronômetro
        function atualizarCronometro() {
            const cronometroElement = document.getElementById('cronometro');
            cronometroElement.textContent = `${tempoRestante}s`;
            
            if (tempoRestante <= 0) {
                tempoRestante = 60;
                if (!isRunning) {
                    verificarNovosAlunos();
                }
            } else {
                tempoRestante--;
            }
        }

        // Função para verificar novos alunos
        async function verificarNovosAlunos() {
            if (!isRunning) {
                console.log('Verificando novos alunos...');
                await carregarAlunosPendentes();
                if (alunosPendentes.length > 0) {
                    console.log('Novos alunos encontrados, iniciando processo...');
                    toggleProcess();
                }
            }
        }

        // Função para iniciar/parar processo
        function toggleProcess() {
            const btn = document.getElementById('btnPlayPause');
            const statusText = document.getElementById('statusText');
            const icon = btn.querySelector('i');

            if (isRunning) {
                // Parar
                clearInterval(intervalId);
                icon.classList.remove('ph-stop-circle');
                icon.classList.add('ph-play-circle');
                statusText.textContent = 'Parado';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                isRunning = false;
            } else {
                // Iniciar
                if (alunosPendentes.length > 0) {
                    intervalId = setInterval(async () => {
                        if (alunosPendentes.length > 0) {
                            const aluno = alunosPendentes[0];
                            await atualizarNoDispositivo(aluno);
                        } else {
                            clearInterval(intervalId);
                            toggleProcess();
                            showToast('Todas as fotos foram atualizadas!');
                        }
                    }, 2000); // Atualizar a cada 2 segundos

                    icon.classList.remove('ph-play-circle');
                    icon.classList.add('ph-stop-circle');
                    statusText.textContent = 'Em execução';
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-red-600', 'hover:bg-red-700');
                    isRunning = true;
                }
            }
        }

        // Event Listeners
        document.getElementById('btnPlayPause').addEventListener('click', toggleProcess);

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading();
                await loadDeviceData();
                await carregarAlunosPendentes();

                // Iniciar cronômetro
                cronometroId = setInterval(atualizarCronometro, 1000);

                // Auto-start
                if (alunosPendentes.length > 0) {
                    toggleProcess();
                }

            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao carregar o sistema', 'error');
            } finally {
                hideLoading();
            }
        });
    </script>
</body>
</html> 