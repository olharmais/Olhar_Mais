<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Visualizar Aluno</title>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preloader {
            transition: opacity 0.3s ease-out;
        }
        .detail-item {
            display: flex;
            margin-bottom: 1rem;
        }
        .detail-label {
            font-weight: 500;
            color: #4b5563;
            width: 40%;
        }
        .detail-value {
            color: #1f2937;
            width: 60%;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-green {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Preloader -->
    <div class="preloader fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
        <button id="closePreloader" class="absolute top-4 right-4 p-2 bg-gray-200 rounded-full text-gray-700 hover:bg-gray-300" title="Forçar fechamento">
            <i class="ph ph-x"></i>
        </button>
    </div>

    <!-- Inclui o Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Loading principal -->
    <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Conteúdo Principal -->
    <main class="transition-all duration-300 p-6 md:p-8 md:ml-64">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <a href="alunos.html" class="p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-800">Visualizar Aluno</h1>
            </div>
            <div class="flex space-x-2">
                <a id="editButton" href="#" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="ph ph-pencil"></i>
                    Editar
                </a>
                <a id="deleteButton" href="#" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="ph ph-trash"></i>
                    Excluir
                </a>
            </div>
        </div>

        <!-- Estado vazio/erro -->
        <div id="emptyState" class="hidden card p-12 text-center">
            <i class="ph ph-warning-circle text-3xl text-amber-500 mb-4"></i>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Aluno não encontrado</h2>
            <p class="text-gray-600 mb-6">O aluno que você está procurando não existe ou foi removido.</p>
            <a href="alunos.html" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Voltar para lista de alunos
            </a>
        </div>

        <!-- Detalhes do Aluno -->
        <div id="alunoDetails" class="hidden space-y-6">
            <!-- Informações básicas -->
            <div class="card p-6">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h2 id="alunoNome" class="text-xl font-semibold text-gray-800">-</h2>
                        <p id="alunoRegistro" class="text-sm text-gray-500">Registro: -</p>
                    </div>
                    <div>
                        <span id="alunoStatus" class="badge">-</span>
                    </div>
                </div>
                
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Foto do aluno -->
                    <div class="flex-shrink-0">
                        <div class="w-36 h-36 bg-gray-100 rounded-lg overflow-hidden">
                            <img id="alunoFoto" class="w-full h-full object-cover" src="/placeholder-user.png" alt="Foto do aluno">
                        </div>
                    </div>
                    
                    <!-- Informações pessoais -->
                    <div class="flex-grow space-y-4">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">Informações Pessoais</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="detail-item">
                                <span class="detail-label">Data de Nascimento</span>
                                <span id="alunoNascimento" class="detail-value">-</span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="detail-label">Gênero</span>
                                <span id="alunoGenero" class="detail-value">-</span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="detail-label">WhatsApp Resp. 1</span>
                                <span id="alunoContato1" class="detail-value">-</span>
                            </div>
                            
                            <div class="detail-item">
                                <span class="detail-label">WhatsApp Resp. 2</span>
                                <span id="alunoContato2" class="detail-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informações acadêmicas -->
            <div class="card p-6">
                <h3 class="text-lg font-medium text-gray-800 mb-6">Informações Acadêmicas</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Escola</h4>
                        <p id="alunoEscola" class="text-gray-800">-</p>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Série</h4>
                        <p id="alunoSerie" class="text-gray-800">-</p>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-1">Turma</h4>
                        <p id="alunoTurma" class="text-gray-800">-</p>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-500 mb-1">Dispositivos de Reconhecimento</h4>
                    <div id="alunoDispositivos" class="space-y-4">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="text-sm font-medium text-gray-500 mb-1">IDs de Reconhecimento por Dispositivo</h4>
                    <div id="alunoIdsDispositivos" class="space-y-4">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Inicialização
        let supabase;
        let alunoData = {};
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM carregado, iniciando...");
            
            // Verificar o estado do preloader
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                console.log("Preloader encontrado, garantindo que esteja visível");
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
            } else {
                console.error("Preloader não encontrado!");
            }

            // Configurar botão de escape do preloader
            document.getElementById('closePreloader').addEventListener('click', function() {
                hidePreloader(true); // Esconder imediatamente
            });

            // Inicializar Supabase
            try {
                console.log('Obtendo credenciais do Supabase...');
                const creds = window.getSupabaseCredentials();
                console.log('Credenciais obtidas:', creds.url);
                
                console.log('Criando cliente Supabase...');
                supabase = window.createSupabaseClient();
                console.log('Supabase client created successfully:', supabase);
                
                // Teste de conexão
                console.log('Testando conexão com o Supabase...');
                const { data: testData, error: testError } = await supabase.from('escolas').select('id').limit(1);
                if (testError) throw testError;
                console.log('Conexão com Supabase funcionando corretamente:', testData);
                
                // Inicializar sidebar
                initializeSidebar();
                
                // Obter ID do aluno da URL
                const urlParams = new URLSearchParams(window.location.search);
                const alunoId = urlParams.get('id');
                console.log('ID do aluno obtido da URL:', alunoId);
                
                if (alunoId) {
                    try {
                        // Mostrar preloader - ajustado para usar a nova função
                        showPreloader();
                        
                        // Buscar dados do aluno
                        await loadAlunoData(alunoId);
                    } catch (error) {
                        console.error('Erro ao carregar aluno:', error);
                        showToast('Erro ao carregar dados do aluno: ' + error.message, 'error');
                        hidePreloader();
                    }
                } else {
                    // Sem ID, mostrar erro
                    document.getElementById('emptyState').classList.remove('hidden');
                    document.getElementById('alunoDetails').classList.add('hidden');
                    showToast('ID do aluno não fornecido', 'error');
                    hidePreloader();
                }
            } catch (error) {
                console.error('Erro ao carregar supabase:', error);
                showToast('Erro ao carregar supabase: ' + error.message, 'error');
                hidePreloader(); // Esconder preloader em caso de erro na inicialização
            }
        });
        
        // Carregar dados do aluno
        async function loadAlunoData(alunoId) {
            try {
                // Buscar dados do aluno (sem colunas antigas)
                const { data: aluno, error: alunoError } = await supabase
                    .from('alunos')
                    .select('id, nome_completo, registro_aluno, data_nascimento, genero, status, contato1_whatsapp, contato2_whatsapp, foto_url, escola_id, serie, turma')
                    .eq('id', alunoId)
                    .single();
                if (alunoError) throw alunoError;

                // Buscar nome da escola
                let escolaNome = 'Não definida';
                if (aluno.escola_id) {
                    const { data: escolaData, error: escolaError } = await supabase
                        .from('escolas')
                        .select('nome')
                        .eq('id', aluno.escola_id)
                        .single();
                    if (!escolaError && escolaData) escolaNome = escolaData.nome;
                }
                aluno.escola_nome = escolaNome;

                // Buscar nome da série
                let serieNome = 'Não definida';
                if (aluno.serie) {
                    const { data: serieData, error: serieError } = await supabase
                        .from('series')
                        .select('nome')
                        .eq('id', aluno.serie)
                        .single();
                    if (!serieError && serieData) serieNome = serieData.nome;
                }
                aluno.serie_nome = serieNome;

                // Buscar nome da turma
                let turmaNome = 'Não definida';
                if (aluno.turma) {
                    const { data: turmaData, error: turmaError } = await supabase
                        .from('turmas')
                        .select('nome')
                        .eq('id', aluno.turma)
                        .single();
                    if (!turmaError && turmaData) turmaNome = turmaData.nome;
                }
                aluno.turma_nome = turmaNome;

                // Guardar dados
                alunoData = aluno;
                console.log('Dados do aluno carregados:', aluno);
                    
                    // Mostrar detalhes
                displayAlunoDetails(aluno);
                    document.getElementById('emptyState').classList.add('hidden');
                    document.getElementById('alunoDetails').classList.remove('hidden');
                    
                    // Configurar botões de ação
                    setupActionButtons(alunoId);

                // Buscar dispositivos vinculados ao aluno na tabela aluno_dispositivo
                const { data: dispositivosVinculados, error: dispError } = await supabase
                    .from('aluno_dispositivo')
                    .select('id, id_dispositivo, numero_de_quem_cadastrou, dispositivo:dispositivos(camera_id, ip)')
                    .eq('aluno', alunoId);
                if (dispError) throw dispError;

                // Preencher lista de dispositivos vinculados
                const listaDispositivos = document.getElementById('alunoDispositivos');
                listaDispositivos.innerHTML = '';
                if (dispositivosVinculados && dispositivosVinculados.length > 0) {
                    dispositivosVinculados.forEach(rel => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-4 p-2 border rounded';
                        div.innerHTML = `<span class=\"font-medium\">${rel.dispositivo?.camera_id || 'ID: ' + rel.id_dispositivo}</span> <span class=\"text-gray-500\">(${rel.dispositivo?.ip || ''})</span> <span class=\"text-xs text-gray-400 ml-auto\">Cadastrado por: ${rel.numero_de_quem_cadastrou || '-'}</span>`;
                        listaDispositivos.appendChild(div);
                    });
                } else {
                    listaDispositivos.innerHTML = '<span class="text-gray-500">Nenhum dispositivo vinculado.</span>';
                }
            } catch (error) {
                console.error('Erro ao carregar aluno:', error);
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('alunoDetails').classList.add('hidden');
                showToast('Erro ao carregar dados do aluno: ' + error.message, 'error');
            } finally {
                hidePreloader();
            }
        }
        
        // Exibir detalhes do aluno
        function displayAlunoDetails(aluno) {
            // Informações básicas
            document.getElementById('alunoNome').textContent = aluno.nome_completo || '-';
            document.getElementById('alunoRegistro').textContent = `Registro: ${aluno.registro_aluno || '-'}`;
            
            // Status
            const statusElement = document.getElementById('alunoStatus');
            if (aluno.status) {
                let statusClass = 'badge-green';
                if (aluno.status === 'INATIVO') statusClass = 'badge-red';
                if (aluno.status === 'SUSPENSO') statusClass = 'badge-yellow';
                
                statusElement.className = `badge ${statusClass}`;
                statusElement.textContent = aluno.status;
            } else {
                statusElement.className = 'badge badge-gray';
                statusElement.textContent = 'Não definido';
            }
            
            // Foto
            if (aluno.foto_url) {
                document.getElementById('alunoFoto').src = aluno.foto_url;
            }
            
            // Informações pessoais
            if (aluno.data_nascimento) {
                const dataNascimento = new Date(aluno.data_nascimento);
                document.getElementById('alunoNascimento').textContent = dataNascimento.toLocaleDateString('pt-BR');
            } else {
                document.getElementById('alunoNascimento').textContent = 'Não informado';
            }
            
            // Gênero
            let generoTexto = 'Não informado';
            if (aluno.genero === 'M') generoTexto = 'Masculino';
            if (aluno.genero === 'F') generoTexto = 'Feminino';
            if (aluno.genero === 'O') generoTexto = 'Outro';
            document.getElementById('alunoGenero').textContent = generoTexto;
            
            // Contatos
            document.getElementById('alunoContato1').textContent = aluno.contato1_whatsapp || 'Não informado';
            document.getElementById('alunoContato2').textContent = aluno.contato2_whatsapp || 'Não informado';
            
            // Informações acadêmicas
            document.getElementById('alunoEscola').textContent = aluno.escola_nome || 'Não definida';
            document.getElementById('alunoSerie').textContent = aluno.serie_nome || 'Não definida';
            document.getElementById('alunoTurma').textContent = aluno.turma_nome || 'Não definida';
            
            // Dispositivos e IDs
            const dispositivosContainer = document.getElementById('alunoDispositivos');
            const idsContainer = document.getElementById('alunoIdsDispositivos');
            dispositivosContainer.innerHTML = '';
            idsContainer.innerHTML = '';
        }
        
        // Configurar botões de ação
        function setupActionButtons(alunoId) {
            // Botão de editar
            document.getElementById('editButton').href = `alunos_edit.html?id=${alunoId}`;
            
            // Botão de excluir
            document.getElementById('deleteButton').href = `alunos_del.html?id=${alunoId}`;
        }
        
        // Função para exibir toast
        function showToast(message, type = 'success') {
            // Configurar Toast
            const toastOptions = {
                position: 'top-right',
                autoClose: 3000,
                hideProgressBar: false,
                closeOnClick: true,
                pauseOnHover: true,
                draggable: true,
                progress: undefined
            };
            
            if (type === 'success') {
                Toastify({
                    text: message,
                    className: "info",
                    style: {
                        background: "linear-gradient(to right, #00b09b, #96c93d)",
                    }
                }).showToast();
            } else {
                Toastify({
                    text: message,
                    className: "info",
                    style: {
                        background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }
                }).showToast();
            }
        }

        // Função para mostrar loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }

        // Função para esconder loading
        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }

        // Inicializar sidebar
        function initializeSidebar() {
            fetch('sidebar_admin.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao carregar o sidebar:', error);
                });
        }

        // Funções para controlar o preloader
        function showPreloader() {
            console.log("Mostrando preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
                console.log("Preloader mostrado");
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }
        
        function hidePreloader(immediate = false) {
            console.log("Escondendo preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                if (immediate) {
                    preloader.style.display = 'none';
                    console.log("Preloader escondido imediatamente");
                } else {
                    setTimeout(() => {
                        preloader.style.display = 'none';
                        console.log("Preloader escondido após transição");
                    }, 300);
                }
            } else {
                console.error("Elemento preloader não encontrado");
            }
            
            // Esconder também o loading principal
            hideLoading();
        }
    </script>
</body>
</html>
