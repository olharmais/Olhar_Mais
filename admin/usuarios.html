<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Usuários</title>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preloader {
            transition: opacity 0.3s ease-out;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-green {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .badge-purple {
            background-color: #ede9fe;
            color: #5b21b6;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Preloader -->
    <div class="preloader fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
        <button id="closePreloader" class="absolute top-4 right-4 p-2 bg-gray-200 rounded-full text-gray-700 hover:bg-gray-300" title="Forçar fechamento">
            <i class="ph ph-x"></i>
        </button>
    </div>

    <!-- Inclui o Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Loading principal -->
    <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Conteúdo Principal -->
    <main class="transition-all duration-300 p-6 md:p-8 md:ml-64">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">Usuários</h1>
            <a href="usuarios_add.html" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="ph ph-plus"></i>
                <span>Adicionar Usuário</span>
            </a>
        </div>

        <!-- Filtros -->
        <div class="card p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="w-full md:w-1/3">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Buscar</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Nome, WhatsApp" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
                            <i class="ph ph-magnifying-glass"></i>
                        </span>
                    </div>
                </div>
                <div class="w-full md:w-1/3">
                    <label for="tipoFilter" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <select id="tipoFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500">
                        <option value="">Todos os tipos</option>
                        <option value="GESTOR">Gestor</option>
                        <option value="PROFISSIONAL">Profissional</option>
                        <option value="NUTRICIONISTA">Nutricionista</option>
                        <option value="RESPONSAVEL">Responsável</option>
                    </select>
                </div>
                <div class="w-full md:w-1/3">
                    <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500">
                        <option value="">Todos os status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Inativo">Inativo</option>
                        <option value="Suspenso">Suspenso</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Estado vazio/erro -->
        <div id="emptyState" class="hidden card p-12 text-center">
            <i class="ph ph-users text-5xl text-gray-300 mb-4"></i>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Nenhum usuário encontrado</h2>
            <p class="text-gray-600 mb-6">Não há usuários cadastrados ou correspondentes aos filtros aplicados.</p>
        </div>

        <!-- Lista de Usuários -->
        <div id="userList" class="space-y-6">
            <!-- Será preenchido via JavaScript -->
            <div class="card p-6">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-1/4 mb-6"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                </div>
            </div>
        </div>
        
        <!-- Paginação -->
        <div id="pagination" class="flex justify-center mt-8 gap-2">
            <!-- Será preenchido via JavaScript -->
        </div>
    </main>

    <script>
        // Inicialização
        let supabase;
        let currentPage = 0;
        let pageSize = 10;
        let totalUsers = 0;
        let searchDebounceTimer;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM carregado, iniciando...");
            
            // Inicialização do preloader
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                console.log("Preloader encontrado, garantindo que esteja visível");
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
            }

            // Configurar botão de escape do preloader
            document.getElementById('closePreloader').addEventListener('click', function() {
                hidePreloader(true); // Esconder imediatamente
            });

            // Inicializar Supabase
            try {
                console.log('Obtendo credenciais do Supabase...');
                supabase = createSupabaseClient();
                console.log('Supabase client created successfully');
                
                // Inicializar sidebar
                initializeSidebar();
                
                // Configurar eventos de filtro e busca
                setupFilterEvents();
                
                // Carregar usuários
                await loadUsers();
                
                // Esconder preloader após inicialização
                hidePreloader();
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao inicializar a página. Por favor, recarregue.', 'error');
                hidePreloader();
            }
        });
        
        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                className: "info",
                style: {
                    background: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
                }
            }).showToast();
        }

        // Funções para controlar o preloader
        function showPreloader() {
            console.log("Mostrando preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
                console.log("Preloader mostrado");
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }
        
        function hidePreloader(immediate = false) {
            console.log("Escondendo preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                if (immediate) {
                    preloader.style.display = 'none';
                    console.log("Preloader escondido imediatamente");
                } else {
                    setTimeout(() => {
                        preloader.style.display = 'none';
                        console.log("Preloader escondido após transição");
                    }, 300);
                }
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }

        // Função para mostrar loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }

        // Função para esconder loading
        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }

        // Inicializar sidebar
        function initializeSidebar() {
            fetch('sidebar_admin.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao carregar o sidebar:', error);
                });
        }
        
        // Configurar eventos de filtro
        function setupFilterEvents() {
            const searchInput = document.getElementById('searchInput');
            const tipoFilter = document.getElementById('tipoFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // Aplicar máscara ao campo de busca para quando for WhatsApp
            searchInput.addEventListener('input', function(e) {
                // Se parece um telefone, aplicar máscara
                if (/^\(?([0-9]{0,2})\)?[-. ]?([0-9]{0,5})[-. ]?([0-9]{0,4})$/.test(e.target.value)) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    // Limitar a 11 dígitos (DDD + número)
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    // Formatar como (XX) XXXXX-XXXX
                    let formattedValue = '';
                    if (value.length > 0) {
                        formattedValue = '(' + value.substring(0, Math.min(2, value.length));
                        if (value.length > 2) {
                            formattedValue += ') ' + value.substring(2, Math.min(7, value.length));
                            if (value.length > 7) {
                                formattedValue += '-' + value.substring(7, Math.min(11, value.length));
                            }
                        }
                    }
                    
                    // Atualizar valor apenas se parece um telefone em formatação
                    if (/^\(\d{1,2}\)/.test(formattedValue)) {
                        e.target.value = formattedValue;
                    }
                }
                
                // Debounce para busca
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    currentPage = 0;
                    loadUsers();
                }, 500);
            });
            
            // Eventos de filtro
            tipoFilter.addEventListener('change', function() {
                currentPage = 0;
                loadUsers();
            });
            
            statusFilter.addEventListener('change', function() {
                currentPage = 0;
                loadUsers();
            });
        }
        
        // Carregar usuários
        async function loadUsers() {
            try {
                showLoading();
                
                const searchTerm = document.getElementById('searchInput').value;
                const tipoFilter = document.getElementById('tipoFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                
                console.log(`Carregando usuários - Página: ${currentPage}, Busca: ${searchTerm}, Tipo: ${tipoFilter}, Status: ${statusFilter}`);
                
                // Construir query
                let query = supabase
                    .from('usuarios')
                    .select('id, nome, sobrenome, tipo, whatsapp, status, foto_url, aluno', { count: 'exact' });
                
                // Aplicar filtros
                if (searchTerm) {
                    query = query.or(`nome.ilike.%${searchTerm}%,sobrenome.ilike.%${searchTerm}%,whatsapp.ilike.%${searchTerm}%`);
                }
                
                if (tipoFilter) {
                    query = query.eq('tipo', tipoFilter);
                }
                
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }
                
                // Paginação
                const from = currentPage * pageSize;
                const to = from + pageSize - 1;
                
                const { data: usuarios, error, count } = await query
                    .order('created_at', { ascending: false })
                    .range(from, to);
                
                if (error) throw error;
                
                totalUsers = count || 0;
                
                // Atualizar UI
                renderUsers(usuarios);
                renderPagination();
                
                // Verificar se há resultados
                document.getElementById('emptyState').classList.toggle('hidden', usuarios && usuarios.length > 0);
                document.getElementById('userList').classList.toggle('hidden', !(usuarios && usuarios.length > 0));
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showToast('Erro ao carregar usuários: ' + error.message, 'error');
                
                // Mostrar estado vazio em caso de erro
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('userList').classList.add('hidden');
            } finally {
                hideLoading();
            }
        }
        
        // Renderizar lista de usuários
        function renderUsers(usuarios) {
            const userListContainer = document.getElementById('userList');
            userListContainer.innerHTML = '';
            
            if (!usuarios || usuarios.length === 0) {
                return;
            }
            
            usuarios.forEach(usuario => {
                const card = document.createElement('div');
                card.className = 'card p-6';
                
                // Obter informações formatadas
                const nomeCompleto = `${usuario.nome || ''} ${usuario.sobrenome || ''}`.trim() || 'Nome não informado';
                const tipoFormatado = formatarTipo(usuario.tipo);
                const statusBadge = gerarStatusBadge(usuario.status);
                
                // Gerar HTML do card
                card.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="flex items-center gap-4 mb-4 md:mb-0">
                            <div class="w-12 h-12 rounded-full bg-gray-200 overflow-hidden">
                                ${usuario.foto_url ? 
                                    `<img src="${usuario.foto_url}" alt="${nomeCompleto}" class="w-full h-full object-cover">` : 
                                    `<div class="w-full h-full flex items-center justify-center bg-blue-100 text-blue-600">
                                        <i class="ph ph-user text-xl"></i>
                                    </div>`
                                }
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${nomeCompleto}</h3>
                                <div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-3 text-sm text-gray-500">
                                    <span class="flex items-center gap-1">
                                        <i class="ph ph-user-circle"></i> ${tipoFormatado}
                                    </span>
                                    ${usuario.whatsapp ? `
                                    <span class="flex items-center gap-1">
                                        <i class="ph ph-whatsapp-logo"></i> ${formatarWhatsapp(usuario.whatsapp)}
                                    </span>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${statusBadge}
                            <div class="flex items-center gap-1">
                                <a href="usuarios_ver.html?id=${usuario.id}" 
                                   class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg" 
                                   title="Ver detalhes">
                                    <i class="ph ph-eye"></i>
                                </a>
                                <a href="usuarios_edit.html?id=${usuario.id}" 
                                   class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg" 
                                   title="Editar usuário">
                                    <i class="ph ph-pencil"></i>
                                </a>
                                <a href="usuarios_del.html?id=${usuario.id}" 
                                   class="p-2 text-gray-600 hover:text-red-500 hover:bg-red-50 rounded-lg" 
                                   title="Excluir usuário">
                                    <i class="ph ph-trash"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                
                userListContainer.appendChild(card);
            });
        }
        
        // Renderizar paginação
        function renderPagination() {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(totalUsers / pageSize);
            
            if (totalPages <= 1) {
                return;
            }
            
            // Botão Anterior
            const prevButton = document.createElement('button');
            prevButton.className = `px-3 py-1 rounded-md ${currentPage === 0 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-300'}`;
            prevButton.innerHTML = '<i class="ph ph-caret-left"></i>';
            prevButton.disabled = currentPage === 0;
            prevButton.addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadUsers();
                }
            });
            paginationContainer.appendChild(prevButton);
            
            // Números das páginas
            const displayedPages = Math.min(5, totalPages);
            let startPage = Math.max(0, currentPage - Math.floor(displayedPages / 2));
            const endPage = Math.min(startPage + displayedPages - 1, totalPages - 1);
            
            // Ajustar startPage se estiver no final
            if (endPage === totalPages - 1) {
                startPage = Math.max(0, endPage - displayedPages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `px-3 py-1 rounded-md ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-300'}`;
                pageButton.textContent = i + 1;
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    loadUsers();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            // Botão Próximo
            const nextButton = document.createElement('button');
            nextButton.className = `px-3 py-1 rounded-md ${currentPage === totalPages - 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-300'}`;
            nextButton.innerHTML = '<i class="ph ph-caret-right"></i>';
            nextButton.disabled = currentPage === totalPages - 1;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    loadUsers();
                }
            });
            paginationContainer.appendChild(nextButton);
        }
        
        // Funções auxiliares
        function formatarTipo(tipo) {
            const tipos = {
                'GESTOR': 'Gestor',
                'PROFISSIONAL': 'Profissional',
                'NUTRICIONISTA': 'Nutricionista',
                'RESPONSAVEL': 'Responsável'
            };
            return tipos[tipo] || tipo || 'Não definido';
        }
        
        function formatarWhatsapp(whatsapp) {
            if (!whatsapp) return '';
            
            // Se começa com 55, formatar como brasileiro
            if (whatsapp.startsWith('55') && whatsapp.length >= 12) {
                const ddd = whatsapp.substring(2, 4);
                const numero = whatsapp.substring(4);
                
                if (numero.length === 9) {
                    return `(${ddd}) ${numero.substring(0, 5)}-${numero.substring(5)}`;
                } else if (numero.length === 8) {
                    return `(${ddd}) ${numero.substring(0, 4)}-${numero.substring(4)}`;
                }
            }
            
            return whatsapp;
        }
        
        function gerarStatusBadge(status) {
            let badgeClass = 'badge-gray';
            let statusText = status || 'Não definido';
            
            if (status === 'Ativo') {
                badgeClass = 'badge-green';
            } else if (status === 'Inativo') {
                badgeClass = 'badge-red';
            } else if (status === 'Suspenso') {
                badgeClass = 'badge-yellow';
            }
            
            return `<span class="badge ${badgeClass}">${statusText}</span>`;
        }
    </script>
</body>
</html> 