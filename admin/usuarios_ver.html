<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Visualizar Usuário</title>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preloader {
            transition: opacity 0.3s ease-out;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-green {
            background-color: #d1fae5;
            color: #065f46;
        }
        .badge-red {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .badge-yellow {
            background-color: #fef3c7;
            color: #92400e;
        }
        .badge-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .badge-purple {
            background-color: #ede9fe;
            color: #5b21b6;
        }
        .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .info-item i {
            width: 1.5rem;
            margin-right: 0.75rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Preloader -->
    <div class="preloader fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
        <button id="closePreloader" class="absolute top-4 right-4 p-2 bg-gray-200 rounded-full text-gray-700 hover:bg-gray-300" title="Forçar fechamento">
            <i class="ph ph-x"></i>
        </button>
    </div>

    <!-- Inclui o Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Loading principal -->
    <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Conteúdo Principal -->
    <main class="transition-all duration-300 p-6 md:p-8 md:ml-64">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <a href="usuarios.html" class="p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-800">Detalhes do Usuário</h1>
            </div>
            <div id="userActions" class="hidden flex items-center gap-2">
                <a id="editBtn" href="#" class="flex items-center gap-2 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="ph ph-pencil"></i>
                    <span>Editar</span>
                </a>
                <a id="permissoesBtn" href="#" class="flex items-center gap-2 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="ph ph-key"></i>
                    <span>Permissões</span>
                </a>
                <a id="deleteBtn" href="#" class="flex items-center gap-2 border border-red-300 text-red-700 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors">
                    <i class="ph ph-trash"></i>
                    <span>Excluir</span>
                </a>
            </div>
        </div>

        <!-- Estado vazio/erro -->
        <div id="emptyState" class="hidden card p-12 text-center">
            <i class="ph ph-warning-circle text-3xl text-amber-500 mb-4"></i>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Usuário não encontrado</h2>
            <p class="text-gray-600 mb-6">O usuário que você está procurando não existe ou foi removido.</p>
            <a href="usuarios.html" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Voltar para lista de usuários
            </a>
        </div>

        <!-- Detalhes do Usuário -->
        <div id="userDetails" class="hidden space-y-6">
            <!-- Informações Básicas -->
            <div class="card p-6">
                <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
                    <div class="w-24 h-24 rounded-full bg-gray-200 overflow-hidden flex-shrink-0">
                        <img id="userAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                        <div id="userAvatarPlaceholder" class="w-full h-full flex items-center justify-center bg-blue-100 text-blue-600">
                            <i class="ph ph-user text-4xl"></i>
                        </div>
                    </div>
                    <div class="flex-grow">
                        <div class="flex flex-col md:flex-row md:items-center gap-3 mb-3">
                            <h2 id="userName" class="text-2xl font-bold text-gray-800">-</h2>
                            <span id="userStatus" class="badge badge-green">-</span>
                        </div>
                        <p id="userType" class="text-gray-600 mb-4">-</p>
                        <div class="flex flex-wrap gap-4">
                            <div id="userWhatsappContainer" class="info-item">
                                <i class="ph ph-whatsapp-logo"></i>
                                <span id="userWhatsapp">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informações Detalhadas -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Detalhes do Cadastro -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Informações do Cadastro</h3>
                    <div class="space-y-4">
                        <div class="info-item">
                            <i class="ph ph-calendar"></i>
                            <div>
                                <p class="text-sm text-gray-500">Data de Criação</p>
                                <p id="userCreatedAt" class="text-gray-800">-</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="ph ph-clock"></i>
                            <div>
                                <p class="text-sm text-gray-500">Última Atualização</p>
                                <p id="userUpdatedAt" class="text-gray-800">-</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="ph ph-identification-badge"></i>
                            <div>
                                <p class="text-sm text-gray-500">ID do Usuário</p>
                                <p id="userId" class="text-gray-800 font-mono text-sm">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acesso do Sistema -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Acesso do Sistema</h3>
                    <div class="space-y-4">
                        <div class="info-item">
                            <i class="ph ph-phone"></i>
                            <div>
                                <p class="text-sm text-gray-500">Telefone de Login</p>
                                <p id="userHash1" class="text-gray-800 font-mono text-sm">-</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="ph ph-lock"></i>
                            <div>
                                <p class="text-sm text-gray-500">Senha</p>
                                <p id="userHash2" class="text-gray-800 font-mono text-sm">••••••••</p>
                            </div>
                        </div>
                        <div class="info-item">
                            <i class="ph ph-clock-countdown"></i>
                            <div>
                                <p class="text-sm text-gray-500">Último Login</p>
                                <p id="userLastLogin" class="text-gray-800">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informações de Aluno (caso seja um responsável) -->
            <div id="studentInfoContainer" class="card p-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Aluno Vinculado</h3>
                <div id="studentInfo" class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden">
                        <img id="studentAvatar" src="" alt="" class="w-full h-full object-cover hidden">
                        <div id="studentAvatarPlaceholder" class="w-full h-full flex items-center justify-center bg-blue-100 text-blue-600">
                            <i class="ph ph-student text-2xl"></i>
                        </div>
                    </div>
                    <div>
                        <div class="mb-1">
                            <h4 id="studentName" class="font-semibold text-gray-800">-</h4>
                            <p id="studentSchool" class="text-sm text-gray-500">-</p>
                        </div>
                        <a id="studentLink" href="#" class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1">
                            <i class="ph ph-arrow-square-out"></i>
                            <span>Ver detalhes do aluno</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Permissões de Acesso -->
            <div id="permissoesContainer" class="card p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Permissões de Acesso</h3>
                
                <!-- Tabs de Permissões -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-4" aria-label="Tabs">
                        <button type="button" class="px-3 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600" data-tab="cidades">
                            Cidades
                            <span id="cidadesCount" class="ml-1 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">0</span>
                        </button>
                        <button type="button" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="escolas">
                            Escolas
                            <span id="escolasCount" class="ml-1 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">0</span>
                        </button>
                        <button type="button" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="series">
                            Séries
                            <span id="seriesCount" class="ml-1 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">0</span>
                        </button>
                        <button type="button" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="turmas">
                            Turmas
                            <span id="turmasCount" class="ml-1 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">0</span>
                        </button>
                        <button type="button" class="px-3 py-2 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="alunos">
                            Alunos
                            <span id="alunosCount" class="ml-1 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">0</span>
                        </button>
                    </nav>
                </div>

                <!-- Conteúdo das Tabs -->
                <div class="space-y-6">
                    <!-- Lista de Cidades -->
                    <div id="cidadesTab" class="tab-content">
                        <div id="cidadesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                        <div id="cidadesEmpty" class="hidden text-center py-8">
                            <i class="ph ph-map-pin text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Nenhuma cidade associada</p>
                        </div>
                    </div>

                    <!-- Lista de Escolas -->
                    <div id="escolasTab" class="tab-content hidden">
                        <div id="escolasList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                        <div id="escolasEmpty" class="hidden text-center py-8">
                            <i class="ph ph-buildings text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Nenhuma escola associada</p>
                        </div>
                    </div>

                    <!-- Lista de Séries -->
                    <div id="seriesTab" class="tab-content hidden">
                        <div id="seriesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                        <div id="seriesEmpty" class="hidden text-center py-8">
                            <i class="ph ph-book text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Nenhuma série associada</p>
                        </div>
                    </div>

                    <!-- Lista de Turmas -->
                    <div id="turmasTab" class="tab-content hidden">
                        <div id="turmasList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                        <div id="turmasEmpty" class="hidden text-center py-8">
                            <i class="ph ph-users-three text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Nenhuma turma associada</p>
                        </div>
                    </div>

                    <!-- Lista de Alunos -->
                    <div id="alunosTab" class="tab-content hidden">
                        <div id="alunosList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                        <div id="alunosEmpty" class="hidden text-center py-8">
                            <i class="ph ph-student text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">Nenhum aluno associado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Inicialização
        let supabase;
        let userId;
        let userData;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM carregado, iniciando...");
            
            // Inicialização do preloader
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                console.log("Preloader encontrado, garantindo que esteja visível");
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
            }

            // Configurar botão de escape do preloader
            document.getElementById('closePreloader').addEventListener('click', function() {
                hidePreloader(true); // Esconder imediatamente
            });

            // Inicializar Supabase
            try {
                console.log('Obtendo credenciais do Supabase...');
                supabase = createSupabaseClient();
                console.log('Supabase client created successfully');
                
                // Inicializar sidebar
                initializeSidebar();
                
                // Obter ID do usuário da URL
                const urlParams = new URLSearchParams(window.location.search);
                userId = urlParams.get('id');
                
                if (!userId) {
                    showEmptyState('ID do usuário não fornecido');
                    hidePreloader();
                    return;
                }
                
                // Carregar dados do usuário
                await loadUserDetails();
                
                // Configurar botões de ação
                setupActionButtons();
                
                // Esconder preloader após inicialização
                hidePreloader();
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao inicializar a página. Por favor, recarregue.', 'error');
                hidePreloader();
            }
        });
        
        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                className: "info",
                style: {
                    background: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
                }
            }).showToast();
        }

        // Funções para controlar o preloader
        function showPreloader() {
            console.log("Mostrando preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
                console.log("Preloader mostrado");
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }
        
        function hidePreloader(immediate = false) {
            console.log("Escondendo preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                if (immediate) {
                    preloader.style.display = 'none';
                    console.log("Preloader escondido imediatamente");
                } else {
                    setTimeout(() => {
                        preloader.style.display = 'none';
                        console.log("Preloader escondido após transição");
                    }, 300);
                }
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }

        // Função para mostrar loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }

        // Função para esconder loading
        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }

        // Inicializar sidebar
        function initializeSidebar() {
            fetch('sidebar_admin.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao carregar o sidebar:', error);
                });
        }
        
        // Função para mostrar estado vazio
        function showEmptyState(message) {
            const emptyState = document.getElementById('emptyState');
            const userDetails = document.getElementById('userDetails');
            const userActions = document.getElementById('userActions');
            
            // Mostrar mensagem personalizada se fornecida
            if (message) {
                const paragraph = emptyState.querySelector('p');
                if (paragraph) {
                    paragraph.textContent = message;
                }
            }
            
            emptyState.classList.remove('hidden');
            userDetails.classList.add('hidden');
            userActions.classList.add('hidden');
        }
        
        // Configurar botões de ação
        function setupActionButtons() {
            const editBtn = document.getElementById('editBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const permissoesBtn = document.getElementById('permissoesBtn');
            
            if (userId) {
                editBtn.href = `usuarios_edit.html?id=${userId}`;
                deleteBtn.href = `usuarios_del.html?id=${userId}`;
                permissoesBtn.href = `usuarios_permissoes.html?id=${userId}`;
                document.getElementById('userActions').classList.remove('hidden');
            }
        }
        
        // Carregar detalhes do usuário
        async function loadUserDetails() {
            try {
                showLoading();
                
                // Buscar dados do usuário
                const { data: usuario, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    throw error;
                }
                
                if (!usuario) {
                    showEmptyState('Usuário não encontrado');
                    hideLoading();
                    return;
                }
                
                // Guardar dados do usuário
                userData = usuario;
                
                // Atualizar UI com os dados do usuário
                updateUserDetails(usuario);
                
                // Buscar dados do aluno associado, se houver
                if (usuario.tipo === 'RESPONSAVEL' && usuario.aluno) {
                    await loadStudentDetails(usuario.aluno);
                }
                
                // Mostrar seção de detalhes
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('userDetails').classList.remove('hidden');
                
                // Carregar permissões após carregar dados do usuário
                await loadPermissoes();
                
            } catch (error) {
                console.error('Erro ao carregar detalhes do usuário:', error);
                showToast('Erro ao carregar detalhes: ' + error.message, 'error');
                showEmptyState('Erro ao carregar detalhes do usuário');
            } finally {
                hideLoading();
            }
        }
        
        // Atualizar UI com os dados do usuário
        function updateUserDetails(usuario) {
            // Informações básicas
            const nomeCompleto = `${usuario.nome || ''} ${usuario.sobrenome || ''}`.trim();
            document.getElementById('userName').textContent = nomeCompleto || 'Nome não informado';
            document.getElementById('userType').textContent = formatarTipo(usuario.tipo);
            
            // Status
            const statusElement = document.getElementById('userStatus');
            statusElement.textContent = usuario.status || 'Não definido';
            statusElement.className = `badge ${gerarStatusClass(usuario.status)}`;
            
            // WhatsApp
            if (usuario.whatsapp) {
                document.getElementById('userWhatsapp').textContent = formatarWhatsapp(usuario.whatsapp);
                document.getElementById('userWhatsappContainer').classList.remove('hidden');
            } else {
                document.getElementById('userWhatsappContainer').classList.add('hidden');
            }
            
            // Foto
            if (usuario.foto_url) {
                const avatar = document.getElementById('userAvatar');
                avatar.src = usuario.foto_url;
                avatar.alt = nomeCompleto;
                avatar.classList.remove('hidden');
                document.getElementById('userAvatarPlaceholder').classList.add('hidden');
            } else {
                document.getElementById('userAvatar').classList.add('hidden');
                document.getElementById('userAvatarPlaceholder').classList.remove('hidden');
            }
            
            // Informações do cadastro
            document.getElementById('userId').textContent = usuario.id || '-';
            document.getElementById('userCreatedAt').textContent = formatarData(usuario.created_at) || '-';
            document.getElementById('userUpdatedAt').textContent = formatarData(usuario.updated_at) || '-';
            
            // Acesso do sistema
            if (usuario.hash1) {
                // Tenta formatar o hash1 como número de telefone brasileiro (se for um número)
                const hash1 = usuario.hash1;
                if (/^\d+$/.test(hash1) && hash1.startsWith('55') && hash1.length >= 12) {
                    document.getElementById('userHash1').textContent = formatarWhatsapp(hash1);
                } else {
                    document.getElementById('userHash1').textContent = hash1;
                }
            } else {
                document.getElementById('userHash1').textContent = '-';
            }
            
            // Não exibimos o valor real da senha, apenas um placeholder
            document.getElementById('userLastLogin').textContent = formatarData(usuario.ultimo_log) || 'Nunca acessou';
        }
        
        // Carregar detalhes do aluno associado
        async function loadStudentDetails(alunoId) {
            try {
                const { data: aluno, error } = await supabase
                    .from('alunos')
                    .select(`
                        id,
                        nome_completo,
                        foto_url,
                        escola_id,
                        escolas:escola_id (
                            id,
                            nome
                        )
                    `)
                    .eq('id', alunoId)
                    .single();
                
                if (error) {
                    throw error;
                }
                
                if (aluno) {
                    // Mostrar container de informações do aluno
                    document.getElementById('studentInfoContainer').classList.remove('hidden');
                    
                    // Preencher dados do aluno
                    document.getElementById('studentName').textContent = aluno.nome_completo || 'Nome não informado';
                    document.getElementById('studentSchool').textContent = aluno.escolas?.nome || 'Escola não informada';
                    document.getElementById('studentLink').href = `alunos_ver.html?id=${aluno.id}`;
                    
                    // Foto do aluno
                    if (aluno.foto_url) {
                        const avatar = document.getElementById('studentAvatar');
                        avatar.src = aluno.foto_url;
                        avatar.alt = aluno.nome_completo;
                        avatar.classList.remove('hidden');
                        document.getElementById('studentAvatarPlaceholder').classList.add('hidden');
                    } else {
                        document.getElementById('studentAvatar').classList.add('hidden');
                        document.getElementById('studentAvatarPlaceholder').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do aluno:', error);
                // Não mostrar toast para não interromper a experiência do usuário
            }
        }
        
        // Funções auxiliares
        function formatarTipo(tipo) {
            const tipos = {
                'GESTOR': 'Gestor',
                'PROFISSIONAL': 'Profissional',
                'NUTRICIONISTA': 'Nutricionista',
                'RESPONSAVEL': 'Responsável'
            };
            return tipos[tipo] || tipo || 'Não definido';
        }
        
        function formatarWhatsapp(whatsapp) {
            if (!whatsapp) return '';
            
            // Se começa com 55, formatar como brasileiro
            if (whatsapp.startsWith('55') && whatsapp.length >= 12) {
                const ddd = whatsapp.substring(2, 4);
                const numero = whatsapp.substring(4);
                
                if (numero.length === 9) {
                    return `(${ddd}) ${numero.substring(0, 5)}-${numero.substring(5)}`;
                } else if (numero.length === 8) {
                    return `(${ddd}) ${numero.substring(0, 4)}-${numero.substring(4)}`;
                }
            }
            
            return whatsapp;
        }
        
        function formatarData(dataString) {
            if (!dataString) return null;
            
            const data = new Date(dataString);
            if (isNaN(data.getTime())) return dataString;
            
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function gerarStatusClass(status) {
            if (status === 'Ativo') return 'badge-green';
            if (status === 'Inativo') return 'badge-red';
            if (status === 'Suspenso') return 'badge-yellow';
            return 'badge-gray';
        }

        // Após a função loadUserDetails()
        async function loadPermissoes() {
            try {
                showLoading();
                
                // Buscar todas as permissões do usuário
                const [
                    { data: permissoesCidade, error: errorCidade },
                    { data: permissoesEscola, error: errorEscola },
                    { data: permissoesSerie, error: errorSerie },
                    { data: permissoesTurma, error: errorTurma },
                    { data: permissoesAluno, error: errorAluno }
                ] = await Promise.all([
                    supabase
                        .from('permissoes_cidade')
                        .select(`
                            id,
                            cidade_id,
                            cidades:cidade_id (
                                id,
                                nome
                            )
                        `)
                        .eq('usuario_id', userId),
                    supabase
                        .from('permissoes_escola')
                        .select(`
                            id,
                            escola_id,
                            escolas:escola_id (
                                id,
                                nome
                            )
                        `)
                        .eq('usuario_id', userId),
                    supabase
                        .from('permissoes_serie')
                        .select(`
                            id,
                            serie_id,
                            series:serie_id (
                                id,
                                nome
                            )
                        `)
                        .eq('usuario_id', userId),
                    supabase
                        .from('permissoes_turma')
                        .select(`
                            id,
                            turma_id,
                            turmas:turma_id (
                                id,
                                nome
                            )
                        `)
                        .eq('usuario_id', userId),
                    supabase
                        .from('permissoes_aluno')
                        .select(`
                            id,
                            aluno_id,
                            alunos:aluno_id (
                                id,
                                nome_completo,
                                foto_url,
                                escola_id,
                                escolas:escola_id (
                                    id,
                                    nome
                                )
                            )
                        `)
                        .eq('usuario_id', userId)
                ]);

                if (errorCidade || errorEscola || errorSerie || errorTurma || errorAluno) {
                    throw new Error('Erro ao carregar permissões');
                }

                // Atualizar contadores
                document.getElementById('cidadesCount').textContent = permissoesCidade?.length || 0;
                document.getElementById('escolasCount').textContent = permissoesEscola?.length || 0;
                document.getElementById('seriesCount').textContent = permissoesSerie?.length || 0;
                document.getElementById('turmasCount').textContent = permissoesTurma?.length || 0;
                document.getElementById('alunosCount').textContent = permissoesAluno?.length || 0;

                // Preencher listas
                preencherListaPermissoes('cidades', permissoesCidade);
                preencherListaPermissoes('escolas', permissoesEscola);
                preencherListaPermissoes('series', permissoesSerie);
                preencherListaPermissoes('turmas', permissoesTurma);
                preencherListaPermissoes('alunos', permissoesAluno);

                // Configurar eventos das tabs
                setupTabEvents();

            } catch (error) {
                console.error('Erro ao carregar permissões:', error);
                showToast('Erro ao carregar permissões: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function preencherListaPermissoes(tipo, permissoes) {
            const listElement = document.getElementById(`${tipo}List`);
            const emptyElement = document.getElementById(`${tipo}Empty`);
            
            if (!permissoes || permissoes.length === 0) {
                listElement.innerHTML = '';
                emptyElement.classList.remove('hidden');
                return;
            }

            emptyElement.classList.add('hidden');
            listElement.innerHTML = permissoes.map(permissao => {
                const item = permissao[tipo.slice(0, -1)+'s'] || {};
                
                // Template especial para alunos
                if (tipo === 'alunos') {
                    return `
                        <div class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-full overflow-hidden bg-blue-100 flex items-center justify-center text-blue-600">
                                    ${item.foto_url ? 
                                        `<img src="${item.foto_url}" alt="${item.nome_completo}" class="w-full h-full object-cover">` :
                                        `<i class="ph ph-student text-xl"></i>`
                                    }
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">${item.nome_completo || 'Nome não disponível'}</h4>
                                    <p class="text-sm text-gray-500">${item.escolas?.nome || 'Escola não disponível'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Template padrão para outros tipos
                return `
                    <div class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                <i class="ph ${getIconForType(tipo)}"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">${item.nome || 'Nome não disponível'}</h4>
                                <p class="text-sm text-gray-500">ID: ${item.id || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getIconForType(tipo) {
            const icons = {
                'cidades': 'ph-map-pin',
                'escolas': 'ph-buildings',
                'series': 'ph-book',
                'turmas': 'ph-users-three',
                'alunos': 'ph-student'
            };
            return icons[tipo] || 'ph-circle';
        }

        function setupTabEvents() {
            const tabs = document.querySelectorAll('[data-tab]');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remover classes ativas de todas as tabs
                    tabs.forEach(t => {
                        t.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                        t.classList.add('text-gray-500');
                    });

                    // Adicionar classes ativas à tab clicada
                    tab.classList.remove('text-gray-500');
                    tab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');

                    // Esconder todos os conteúdos
                    contents.forEach(content => content.classList.add('hidden'));

                    // Mostrar o conteúdo correspondente
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}Tab`).classList.remove('hidden');
                });
            });
        }
    </script>
</body>
</html> 