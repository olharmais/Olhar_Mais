<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Editar Usuário</title>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .preloader {
            transition: opacity 0.3s ease-out;
        }
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        /* Correção para o Phosphor Icons */
        .ph {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Preloader -->
    <div class="preloader fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
        <button id="closePreloader" class="absolute top-4 right-4 p-2 bg-gray-200 rounded-full text-gray-700 hover:bg-gray-300" title="Forçar fechamento">
            <i class="ph ph-x"></i>
        </button>
    </div>

    <!-- Inclui o Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Loading principal -->
    <div id="mainLoading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-40 hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Conteúdo Principal -->
    <main class="transition-all duration-300 p-6 md:p-8 md:ml-64">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <a href="usuarios.html" class="p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-800">Editar Usuário</h1>
            </div>
            <button type="button" id="submitBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center gap-2">
                <i class="ph ph-check"></i>
                <span>Salvar</span>
            </button>
        </div>

        <!-- Estado vazio/erro -->
        <div id="emptyState" class="hidden card p-12 text-center">
            <i class="ph ph-warning-circle text-3xl text-amber-500 mb-4"></i>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Usuário não encontrado</h2>
            <p class="text-gray-600 mb-6">O usuário que você está procurando não existe ou foi removido.</p>
            <a href="usuarios.html" class="inline-flex items-center justify-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Voltar para lista de usuários
            </a>
        </div>

        <!-- Formulário -->
        <form id="userForm" class="space-y-6 hidden">
            <!-- ID do usuário (oculto) -->
            <input type="hidden" id="userId" name="userId">
            
            <!-- Informações Básicas -->
            <div class="card p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-6">Informações Básicas</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nome -->
                    <div>
                        <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome <span class="text-red-500">*</span></label>
                        <input type="text" id="nome" name="nome" placeholder="Digite o nome do usuário" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    
                    <!-- Sobrenome -->
                    <div>
                        <label for="sobrenome" class="block text-sm font-medium text-gray-700 mb-1">Sobrenome <span class="text-red-500">*</span></label>
                        <input type="text" id="sobrenome" name="sobrenome" placeholder="Digite o sobrenome do usuário" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    
                    <!-- WhatsApp -->
                    <div>
                        <label for="whatsapp" class="block text-sm font-medium text-gray-700 mb-1">WhatsApp <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-500">
                                <i class="ph ph-whatsapp-logo"></i>
                            </div>
                            <input type="tel" id="whatsapp" name="whatsapp" class="w-full p-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="(99) 99999-9999" required>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Formato: DDD + número, ex: 11999999999</p>
                    </div>
                    
                    <!-- Tipo de Usuário -->
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Usuário <span class="text-red-500">*</span></label>
                        <select id="tipo" name="tipo" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="" disabled>Selecione um tipo</option>
                            <option value="GESTOR">Gestor</option>
                            <option value="PROFISSIONAL">Profissional</option>
                            <option value="NUTRICIONISTA">Nutricionista</option>
                            <option value="RESPONSÁVEL">Responsável</option>
                        </select>
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status <span class="text-red-500">*</span></label>
                        <select id="status" name="status" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                            <option value="Suspenso">Suspenso</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Botão de Submit (visível apenas em mobile) -->
            <div class="block md:hidden">
                <button type="button" id="mobileSubmitBtn" class="w-full px-4 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                    <i class="ph ph-check"></i>
                    <span>Salvar Alterações</span>
                </button>
            </div>
        </form>
        
        <!-- Estado de progresso ao salvar -->
        <div id="saveProgress" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-6 rounded-lg max-w-md w-full">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Atualizando Usuário</h3>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <p id="progressStatus" class="text-sm text-gray-600">Preparando dados...</p>
            </div>
        </div>
    </main>

    <script>
        // Inicialização
        let supabase;
        let userId;
        let userData;
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM carregado, iniciando...");
            
            // Inicialização do preloader
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                console.log("Preloader encontrado, garantindo que esteja visível");
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
            }
            
            // Configurar botão de escape do preloader
            document.getElementById('closePreloader').addEventListener('click', function() {
                hidePreloader(true); // Esconder imediatamente
            });
            
            try {
                // Inicializar Supabase
                console.log('Obtendo credenciais do Supabase...');
                supabase = createSupabaseClient();
                console.log('Supabase client created successfully');
                
                // Inicializar sidebar
                initializeSidebar();
                
                // Obter ID do usuário da URL
                const urlParams = new URLSearchParams(window.location.search);
                userId = urlParams.get('id');
                
                if (!userId) {
                    showEmptyState('ID do usuário não fornecido');
                    hidePreloader();
                    return;
                }
                
                // Configurar eventos
                setupEventListeners();
                
                // Carregar dados do usuário
                await loadUserData();
                
                // Esconder preloader após inicialização
                hidePreloader();
            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao inicializar a página. Por favor, recarregue.', 'error');
                hidePreloader();
            }
        });
        
        // Inicializar sidebar
        function initializeSidebar() {
            fetch('sidebar_admin.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('sidebar-container').innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao carregar o sidebar:', error);
                });
        }
        
        // Configurar eventos
        function setupEventListeners() {
            // Aplicar máscara ao campo de WhatsApp
            const whatsappInput = document.getElementById('whatsapp');
            if (whatsappInput) {
                whatsappInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) {
                        value = value.substring(0, 11);
                    }
                    
                    let formattedValue = '';
                    if (value.length > 0) {
                        formattedValue = '(' + value.substring(0, Math.min(2, value.length));
                        if (value.length > 2) {
                            formattedValue += ') ' + value.substring(2, Math.min(7, value.length));
                            if (value.length > 7) {
                                formattedValue += '-' + value.substring(7, Math.min(11, value.length));
                            }
                        }
                    }
                    
                    e.target.value = formattedValue;
                });
            }
            
            // Botões de submit
            const submitBtn = document.getElementById('submitBtn');
            const mobileSubmitBtn = document.getElementById('mobileSubmitBtn');
            
            if (submitBtn) {
                submitBtn.addEventListener('click', updateUser);
            }
            
            if (mobileSubmitBtn) {
                mobileSubmitBtn.addEventListener('click', updateUser);
            }
        }
        
        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                className: "info",
                style: {
                    background: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
                }
            }).showToast();
        }

        // Função para mostrar loading
        function showLoading() {
            document.getElementById('mainLoading').classList.remove('hidden');
        }

        // Função para esconder loading
        function hideLoading() {
            document.getElementById('mainLoading').classList.add('hidden');
        }
        
        // Funções para controlar o preloader
        function showPreloader() {
            console.log("Mostrando preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '1';
                preloader.style.display = 'flex';
                console.log("Preloader mostrado");
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }
        
        function hidePreloader(immediate = false) {
            console.log("Escondendo preloader...");
            const preloader = document.querySelector('.preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                if (immediate) {
                    preloader.style.display = 'none';
                    console.log("Preloader escondido imediatamente");
                } else {
                    setTimeout(() => {
                        preloader.style.display = 'none';
                        console.log("Preloader escondido após transição");
                    }, 300);
                }
            } else {
                console.error("Elemento preloader não encontrado");
            }
        }
        
        // Função para mostrar estado vazio
        function showEmptyState(message) {
            const emptyState = document.getElementById('emptyState');
            const userForm = document.getElementById('userForm');
            
            // Mostrar mensagem personalizada se fornecida
            if (message) {
                const paragraph = emptyState.querySelector('p');
                if (paragraph) {
                    paragraph.textContent = message;
                }
            }
            
            emptyState.classList.remove('hidden');
            userForm.classList.add('hidden');
        }
        
        // Funções para controlar o progresso
        function showProgress() {
            document.getElementById('saveProgress').classList.remove('hidden');
        }
        
        function hideProgress() {
            document.getElementById('saveProgress').classList.add('hidden');
        }
        
        function updateProgress(percent, status) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressStatus').textContent = status;
        }
        
        // Carregar dados do usuário
        async function loadUserData() {
            try {
                showLoading();
                
                // Buscar dados do usuário
                const { data: usuario, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) {
                    throw error;
                }
                
                if (!usuario) {
                    showEmptyState('Usuário não encontrado');
                    hideLoading();
                    return;
                }
                
                // Guardar dados do usuário
                userData = usuario;
                
                // Preencher formulário com os dados
                fillForm(usuario);
                
                // Mostrar formulário
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('userForm').classList.remove('hidden');
                
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                showToast('Erro ao carregar dados: ' + error.message, 'error');
                showEmptyState('Erro ao carregar dados do usuário');
            } finally {
                hideLoading();
            }
        }
        
        // Preencher formulário com os dados do usuário
        function fillForm(usuario) {
            // Função auxiliar para definir valor com segurança
            const setValueSafely = (elementId, value) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value || '';
                }
            };

            // Função auxiliar para selecionar option com segurança
            const setSelectSafely = (elementId, value) => {
                const select = document.getElementById(elementId);
                if (select && value) {
                    const options = Array.from(select.options);
                    const optionToSelect = options.find(option => option.value === value);
                    if (optionToSelect) {
                        optionToSelect.selected = true;
                    }
                }
            };

            // Definir valores dos campos
            setValueSafely('userId', usuario.id);
            setValueSafely('nome', usuario.nome);
            setValueSafely('sobrenome', usuario.sobrenome);
            
            // Formatar e preencher WhatsApp
            if (usuario.whatsapp) {
                setValueSafely('whatsapp', formatarWhatsapp(usuario.whatsapp));
            }
            
            // Selecionar tipo e status
            setSelectSafely('tipo', usuario.tipo);
            setSelectSafely('status', usuario.status);
        }
        
        // Formatar WhatsApp
        function formatarWhatsapp(whatsapp) {
            if (!whatsapp) return '';
            
            // Se começa com 55, formatar como brasileiro
            if (whatsapp.startsWith('55') && whatsapp.length >= 12) {
                const ddd = whatsapp.substring(2, 4);
                const numero = whatsapp.substring(4);
                
                if (numero.length === 9) {
                    return `(${ddd}) ${numero.substring(0, 5)}-${numero.substring(5)}`;
                } else if (numero.length === 8) {
                    return `(${ddd}) ${numero.substring(0, 4)}-${numero.substring(4)}`;
                }
            }
            
            return whatsapp;
        }
        
        // Atualizar usuário
        async function updateUser() {
            // Validação do formulário
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            try {
                showProgress();
                updateProgress(10, 'Verificando dados...');
                
                // Obter valores do formulário com verificações de existência
                const id = document.getElementById('userId') ? document.getElementById('userId').value : null;
                const nome = document.getElementById('nome') ? document.getElementById('nome').value.trim() : '';
                const sobrenome = document.getElementById('sobrenome') ? document.getElementById('sobrenome').value.trim() : '';
                const whatsapp = document.getElementById('whatsapp') ? document.getElementById('whatsapp').value.trim().replace(/\D/g, '') : '';
                const tipo = document.getElementById('tipo') ? document.getElementById('tipo').value : '';
                const status = document.getElementById('status') ? document.getElementById('status').value : '';
                const hash2 = document.getElementById('hash2') ? document.getElementById('hash2').value.trim() : '';
                
                // Verifique se o ID do usuário foi encontrado
                if (!id) {
                    throw new Error('ID do usuário não encontrado.');
                }
                
                updateProgress(20, 'Preparando dados para envio...');
                
                // Formatar o número de WhatsApp
                let whatsappFormatado = whatsapp;
                if (!whatsappFormatado.startsWith('55')) {
                    whatsappFormatado = '55' + whatsappFormatado;
                }
                
                // Criar objeto com dados do usuário
                const updatedUser = {
                    nome,
                    sobrenome,
                    whatsapp: whatsappFormatado,
                    tipo,
                    status,
                    updated_at: new Date().toISOString()
                };
                
                // Adicionar senha apenas se foi fornecida
                if (hash2) {
                    updatedUser.hash2 = hash2;
                }
                
                updateProgress(40, 'Enviando dados para o servidor...');
                
                // Atualizar no Supabase
                const { data, error } = await supabase
                    .from('usuarios')
                    .update(updatedUser)
                    .eq('id', id)
                    .select();
                
                if (error) {
                    throw error;
                }
                
                showToast('Usuário atualizado com sucesso!');
                setTimeout(() => {
                    window.location.href = 'usuarios_ver.html?id=' + id;
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao atualizar usuário:', error);
                showToast('Erro ao atualizar usuário: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html> 