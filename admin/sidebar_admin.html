<!-- Configuração do Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Phosphor Icons -->
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Supabase Config -->
<script src="/config/supabase.js"></script>

<!-- Função global de toggle -->
<script>
    // Função global para toggle do menu - DEVE estar fora do DOMContentLoaded
    function toggleMenu() {
        console.log('toggleMenu chamado!');
        document.getElementById('sidebar').classList.toggle('active');
        document.getElementById('sidebar-overlay').classList.toggle('active');
        document.getElementById('menu-toggle').classList.toggle('active');
    }
</script>

<!-- Função de logout definitiva -->
<script>
    // Função de limpeza completa de sessão - DEFINITIVA
    function limparSessaoEsair() {
        console.log("Limpando sessão completamente antes de sair...");
        
        try {
            // 1. Limpar tokens do Supabase especificamente
            localStorage.removeItem('sb-access-token');
            localStorage.removeItem('sb-refresh-token');
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('sb-provider-token');
            
            // 2. Limpar dados de usuário
            localStorage.removeItem('user_session');
            localStorage.removeItem('user');
            
            // 3. Limpar todas as chaves que contenham 'supabase'
            Object.keys(localStorage).forEach(key => {
                if (key.includes('supabase')) {
                    localStorage.removeItem(key);
                }
            });
            
            // 4. Limpar sessionStorage
            sessionStorage.clear();
            
            // 5. Limpar todos os cookies de forma completa
            document.cookie.split(";").forEach(function(c) {
                document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                document.cookie = c.trim().split("=")[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
            });
            
            // 6. Última instrução: limpar localStorage completamente
            localStorage.clear();
            
            console.log("Sessão limpa com sucesso!");
            
            // 7. Imprimir o que resta (debug)
            console.log("LocalStorage restante:", Object.keys(localStorage));
            console.log("Cookies restantes:", document.cookie);
            
            // 8. Iniciar o processo de redirecionamento
            window.location.replace('/auth.html?logout=true&t=' + new Date().getTime());
            
        } catch (error) {
            console.error("Erro ao limpar sessão:", error);
            // Mesmo com erro, tentar redirecionar
            window.location.href = '/auth.html?logout=true';
        }
    }
    
    // Registrar globalmente
    window.limparSessaoEsair = limparSessaoEsair;
</script>

<!-- Estilos do Sidebar -->
<style>
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100%;
        width: 16rem;
        background-color: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transform: translateX(-100%);
        transition: transform 300ms ease-in-out;
        z-index: 999;
    }

    /* Quando o sidebar está ativo em mobile */
    .sidebar.active {
        transform: translateX(0) !important;
    }

    /* Em desktop */
    @media (min-width: 768px) {
        .sidebar {
            transform: translateX(0);
        }

        .sidebar.collapsed {
            width: 5rem;
        }

        /* Esconder botão hamburguer em desktop */
        #menu-toggle {
            display: none !important;
        }
    }

    .menu-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        color: white;
        cursor: pointer;
        transition: all 200ms;
        border-radius: 0.375rem;
    }

    .menu-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .menu-item.active {
        background-color: rgba(255, 255, 255, 0.15);
    }

    .menu-item.active i {
        transform: scale(1.1);
    }

    .menu-text {
        font-weight: 500;
        white-space: nowrap;
        font-size: 0.999rem;
    }

    /* Em desktop, esconder texto quando colapsado */
    @media (min-width: 768px) {
        .sidebar.collapsed .menu-text {
            display: none;
        }

        .sidebar.collapsed .logo-text {
            display: none;
        }

        .sidebar.collapsed .logo-icon {
            display: block;
        }
    }

    .logo-icon {
        display: none;
        font-size: 1.5rem;
        color: white;
    }

    .logo-text {
        display: block;
    }

    .sidebar-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 998;
        opacity: 0;
        visibility: hidden;
        transition: all 300ms ease;
    }

    .sidebar-overlay.active {
        opacity: 1;
        visibility: visible;
    }
</style>


<!-- Overlay -->
<div id="sidebar-overlay" onclick="toggleMenu()" class="sidebar-overlay"></div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar bg-gradient-to-b from-blue-600 to-blue-700">
    <!-- Logo -->
    <div class="p-4 border-b border-white/10">
        <div class="flex items-center justify-center md:justify-start gap-2">
            <span class="logo-text text-xl font-bold text-white">OlharMais</span>
            <i class="logo-icon ph ph-eye"></i>
        </div>
    </div>

    <!-- Menu -->
    <nav class="py-3 px-2">
        <div class="space-y-1">
            <a href="dashboard.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="dashboard.html">
                <i class="ph ph-house text-xl transition-transform"></i>
                <span class="menu-text">Início</span>
            </a>  

            <a href="alunos.html" class="menu-item" data-href="alunos.html">
                <i class="ph ph-student text-xl"></i>
                <span class="menu-text">Alunos</span>
            </a>
            
            <a href="cidades.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="cidades.html">
                <i class="ph ph-buildings text-xl transition-transform"></i>
                <span class="menu-text">Cidades</span>
            </a>
            
            <a href="logs.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="logs.html">
                <i class="ph ph-chart-line text-xl transition-transform"></i>
                <span class="menu-text">Logs</span>
            </a>
            
            <a href="escolas.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="escolas.html">
                <i class="ph ph-graduation-cap text-xl transition-transform"></i>
                <span class="menu-text">Escolas</span>
            </a>
            
            <a href="serie.html" class="menu-item" data-href="serie.html">
                <i class="ph ph-graduation-cap text-xl"></i>
                <span class="menu-text">Séries</span>
            </a>
            
            <a href="turmas.html" class="menu-item" data-href="turmas.html">
                <i class="ph ph-users-three text-xl"></i>
                <span class="menu-text">Turmas</span>
            </a>
            
            <a href="cameras.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="cameras.html">
                <i class="ph ph-camera text-xl transition-transform"></i>
                <span class="menu-text">Câmeras</span>
            </a>
            
            <a href="dispositivos.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="dispositivos.html">
                <i class="ph ph-webcam text-xl transition-transform"></i>
                <span class="menu-text">Dispositivos</span>
            </a>
            
            <a href="usuarios.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="usuarios.html">
                <i class="ph ph-user-circle text-xl transition-transform"></i>
                <span class="menu-text">Usuários</span>
            </a>
        </div>
    </nav>

    <!-- Footer -->
    <div class="absolute bottom-0 w-full p-3 border-t border-white/10">
        <!-- Botão de logout que aciona a função de limpeza antes de redirecionar -->
        <a href="javascript:void(0)" class="menu-item hover:bg-white/10 rounded-lg" onclick="limparSessaoEsair(); return false;">
            <i class="ph ph-sign-out text-xl transition-transform"></i>
            <span class="menu-text">Sair</span>
        </a>
    </div>
</aside>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM carregado');
        
        // Adicionar evento para limpar dados ao clicar em qualquer link para auth.html
        document.querySelectorAll('a[href="/auth.html"]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Limpando dados e redirecionando...');
                
                // Limpar dados locais
                localStorage.clear();
                sessionStorage.clear();
                
                // Limpar cookies
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i];
                    const eqPos = cookie.indexOf("=");
                    const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                }
                
                // Redirecionar
                window.location.href = '/auth.html';
            });
        });
        
        // Tratar cliques nos links do menu no mobile
        const menuLinks = document.querySelectorAll('.menu-item');
        menuLinks.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth < 768 && document.getElementById('sidebar').classList.contains('active')) {
                    toggleMenu();
                }
            });
        });
        
        // Adicionar classe ativa ao item de menu correspondente à página atual
        const currentPage = window.location.pathname.split('/').pop();
        const menuItems = document.querySelectorAll('.menu-item');
        
        menuItems.forEach(item => {
            const href = item.getAttribute('data-href');
            
            // Se estamos em uma página como dispositivos_add.html, dispositivos_edit.html, etc.
            // ainda queremos destacar o item do menu principal dispositivos.html
            if (currentPage.includes('dispositivos') && href === 'dispositivos.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('alunos') && href === 'alunos.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('cidades') && href === 'cidades.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('escolas') && href === 'escolas.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('serie') && href === 'serie.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('turmas') && href === 'turmas.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('logs') && href === 'logs.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('usuarios') && href === 'usuarios.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage.includes('cameras') && href === 'cameras.html') {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
            else if (currentPage === href) {
                item.classList.add('active');
                item.classList.add('bg-white/10');
            }
        });
    });
</script>

<!-- Sidebar e Botão Hamburguer para inclusão via JavaScript -->

<!-- Conteúdo HTML a ser inserido -->
<div id="olharmais-sidebar-content">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gradient-to-b from-blue-600 to-blue-700">
        <!-- Logo -->
        <div class="p-4 border-b border-white/10">
            <div class="flex items-center justify-center md:justify-start gap-2">
                <span class="logo-text text-xl font-bold text-white">OlharMais</span>
                <i class="logo-icon ph ph-eye"></i>
            </div>
        </div>

        <!-- Menu -->
        <nav class="py-3 px-2">
            <div class="space-y-1">
                <a href="dashboard.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="dashboard.html">
                    <i class="ph ph-house text-xl transition-transform"></i>
                    <span class="menu-text">Início</span>
                </a>  

                <a href="alunos.html" class="menu-item" data-href="alunos.html">
                    <i class="ph ph-student text-xl"></i>
                    <span class="menu-text">Alunos</span>
                </a>
                
                <a href="cidades.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="cidades.html">
                    <i class="ph ph-buildings text-xl transition-transform"></i>
                    <span class="menu-text">Cidades</span>
                </a>
                
                <a href="logs.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="logs.html">
                    <i class="ph ph-chart-line text-xl transition-transform"></i>
                    <span class="menu-text">Logs</span>
                </a>
                
                <a href="escolas.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="escolas.html">
                    <i class="ph ph-graduation-cap text-xl transition-transform"></i>
                    <span class="menu-text">Escolas</span>
                </a>
                
                <a href="serie.html" class="menu-item" data-href="serie.html">
                    <i class="ph ph-graduation-cap text-xl"></i>
                    <span class="menu-text">Séries</span>
                </a>
                
                <a href="turmas.html" class="menu-item" data-href="turmas.html">
                    <i class="ph ph-users-three text-xl"></i>
                    <span class="menu-text">Turmas</span>
                </a>
                
                <a href="cameras.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="cameras.html">
                    <i class="ph ph-camera text-xl transition-transform"></i>
                    <span class="menu-text">Câmeras</span>
                </a>
                
                <a href="dispositivos.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="dispositivos.html">
                    <i class="ph ph-webcam text-xl transition-transform"></i>
                    <span class="menu-text">Dispositivos</span>
                </a>
                
                <a href="usuarios.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="usuarios.html">
                    <i class="ph ph-user-circle text-xl transition-transform"></i>
                    <span class="menu-text">Usuários</span>
                </a>
            </div>
        </nav>

        <!-- Footer -->
        <div class="absolute bottom-0 w-full p-3 border-t border-white/10">
            <a href="javascript:void(0)" class="menu-item hover:bg-white/10 rounded-lg" onclick="limparSessaoEsair(); return false;">
                <i class="ph ph-sign-out text-xl transition-transform"></i>
                <span class="menu-text">Sair</span>
            </a>
        </div>
    </aside>

    <!-- Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>
</div>

<!-- Script para inicialização do sidebar - essa parte é fundamental -->
<script>
    (function() {
        // Esta função auto-executável garante que o script não polua o escopo global
        
        // Função de inicialização chamada quando o DOM estiver carregado
        function initSidebar() {
            console.log("Inicializando sidebar OlharMais");
            
            // Encontrar o contêiner alvo
            const sidebarContainer = document.getElementById('sidebar-container');
            if (!sidebarContainer) {
                console.error("Contêiner do sidebar não encontrado!");
                return;
            }
            
            // Clonar o conteúdo do sidebar
            const sidebarContent = document.getElementById('olharmais-sidebar-content');
            if (!sidebarContent) {
                console.error("Conteúdo do sidebar não encontrado!");
                return;
            }
            
            // Inserir o conteúdo no contêiner
            sidebarContainer.innerHTML = sidebarContent.innerHTML;
            
            // Configurar os eventos depois de inserir o HTML
            setupSidebarEvents();
        }
        
        // Configurar eventos do sidebar
        function setupSidebarEvents() {
            console.log("Configurando eventos do sidebar");
            
            // Botão de toggle
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && overlay) {
                // Função para alternar o sidebar
                function toggleMenu() {
                    console.log("Alternando estado do sidebar");
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                }
                
                // Adicionar eventos
                overlay.addEventListener('click', toggleMenu);
                
                // Fechar o sidebar quando clicar em um link do menu (em mobile)
                const menuLinks = document.querySelectorAll('.menu-item');
                menuLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth < 768 && sidebar.classList.contains('active')) {
                            toggleMenu();
                        }
                    });
                });
                
                // Destacar item de menu ativo
                highlightActiveMenuItem();
                
                // Configurar links de logout para usar a função central
                const logoutLinks = document.querySelectorAll('a[onclick*="limparSessaoEsair"]');
                logoutLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        limparSessaoEsair();
                    });
                });
            } else {
                console.error("Alguns elementos do sidebar não foram encontrados após a inserção!");
            }
        }
        
        // Destacar item de menu ativo
        function highlightActiveMenuItem() {
            const currentPage = window.location.pathname.split('/').pop();
            const menuItems = document.querySelectorAll('.menu-item');
            
            menuItems.forEach(item => {
                const href = item.getAttribute('data-href');
                
                // Se estamos em uma página como dispositivos_add.html, dispositivos_edit.html, etc.
                // ainda queremos destacar o item do menu principal dispositivos.html
                if (currentPage.includes('dispositivos') && href === 'dispositivos.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('alunos') && href === 'alunos.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('cidades') && href === 'cidades.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('escolas') && href === 'escolas.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('serie') && href === 'serie.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('turmas') && href === 'turmas.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('logs') && href === 'logs.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('usuarios') && href === 'usuarios.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage.includes('cameras') && href === 'cameras.html') {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
                else if (currentPage === href) {
                    item.classList.add('active');
                    item.classList.add('bg-white/10');
                }
            });
        }
        
        // Inicializar quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSidebar);
        } else {
            // Se o DOM já estiver carregado
            initSidebar();
        }
    })();
</script>

<!-- Script para garantir limpeza da sessão ao acessar a página de login -->
<script>
    // Esta função verifica se estamos na página de login e limpa a sessão
    (function() {
        if (window.location.pathname.includes('auth.html')) {
            console.log('Página de login detectada, limpando sessão...');
            
            // Limpar tokens do Supabase
            localStorage.removeItem('sb-access-token');
            localStorage.removeItem('sb-refresh-token');
            localStorage.removeItem('supabase.auth.token');
            localStorage.removeItem('sb-provider-token');
            
            // Limpar dados de usuário
            localStorage.removeItem('user_session');
            localStorage.removeItem('user');
            
            // Limpar sessionStorage
            sessionStorage.clear();
            
            console.log('Sessão limpa ao carregar página de login.');
        }
    })();
</script> 