<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OlharMais - Cadastro de Aluno</title>
    
    <!-- Favicons -->
    <link rel="icon" href="/favicon/favicon.svg" type="image/svg+xml">
    
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Toast -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- Supabase Config -->
    <script src="/config/supabase.js"></script>

    <!-- IMask para máscaras -->
    <script src="https://unpkg.com/imask"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .form-input:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .avatar-upload {
            width: 150px;
            height: 150px;
            border: 2px dashed #e2e8f0;
            border-radius: 1rem;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        .avatar-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-upload .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* Estilos do Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 16rem;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateX(-100%);
            transition: transform 300ms ease-in-out;
            z-index: 999;
        }

        /* Quando o sidebar está ativo em mobile */
        .sidebar.active {
            transform: translateX(0) !important;
        }

        /* Em desktop */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }

            .sidebar.collapsed {
                width: 5rem;
            }
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: white;
            cursor: pointer;
            transition: all 200ms;
            border-radius: 0.5rem;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .menu-item.active i {
            transform: scale(1.1);
        }

        .menu-text {
            font-weight: 500;
            white-space: nowrap;
        }

        /* Em desktop, esconder texto quando colapsado */
        @media (min-width: 768px) {
            .sidebar.collapsed .menu-text {
                display: none;
            }

            .sidebar.collapsed .logo-text {
                display: none;
            }

            .sidebar.collapsed .logo-icon {
                display: block;
            }
        }

        .logo-icon {
            display: none;
            font-size: 1.75rem;
            color: white;
        }

        .logo-text {
            display: block;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 300ms ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Preloader -->
    <div class="preloader fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="loading-spinner"></div>
    </div>

    <!-- Overlay -->
    <div class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar bg-gradient-to-b from-blue-600 to-blue-700">
        <!-- Logo -->
        <div class="p-6 border-b border-white/10">
            <div class="flex items-center justify-center md:justify-start gap-3">
                <span class="logo-text text-2xl font-bold text-white">OlharMais</span>
                <i class="logo-icon ph ph-eye"></i>
            </div>
        </div>

        <!-- Menu -->
        <nav class="py-3 px-2">
            <div class="space-y-1">
                <a href="dashboard.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="dashboard.html">
                    <i class="ph ph-house text-xl transition-transform"></i>
                    <span class="menu-text">Início</span>
                </a>  

                <a href="alunos.html" class="menu-item active" data-href="alunos.html">
                    <i class="ph ph-student text-xl"></i>
                    <span class="menu-text">Alunos</span>
                </a>
                
                <a href="cidades.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="cidades.html">
                    <i class="ph ph-buildings text-xl transition-transform"></i>
                    <span class="menu-text">Cidades</span>
                </a>
                
                <a href="logs.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="logs.html">
                    <i class="ph ph-chart-line text-xl transition-transform"></i>
                    <span class="menu-text">Logs</span>
                </a>
                
                <a href="escolas.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="escolas.html">
                    <i class="ph ph-graduation-cap text-xl transition-transform"></i>
                    <span class="menu-text">Escolas</span>
                </a>
                
                <a href="serie.html" class="menu-item" data-href="serie.html">
                    <i class="ph ph-graduation-cap text-xl"></i>
                    <span class="menu-text">Séries</span>
                </a>
                
                <a href="turmas.html" class="menu-item" data-href="turmas.html">
                    <i class="ph ph-users-three text-xl"></i>
                    <span class="menu-text">Turmas</span>
                </a>
                
                <a href="cameras.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="cameras.html">
                    <i class="ph ph-camera text-xl transition-transform"></i>
                    <span class="menu-text">Câmeras</span>
                </a>
                
                <a href="dispositivos.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="dispositivos.html">
                    <i class="ph ph-webcam text-xl transition-transform"></i>
                    <span class="menu-text">Dispositivos</span>
                </a>
                
                <a href="usuarios.html" class="menu-item hover:bg-white/10 rounded-lg" data-href="usuarios.html">
                    <i class="ph ph-user-circle text-xl transition-transform"></i>
                    <span class="menu-text">Usuários</span>
                </a>
            </div>
        </nav>

        <!-- Footer -->
        <div class="absolute bottom-0 w-full p-4 border-t border-white/10">
            <div class="menu-item hover:bg-white/10 rounded-lg" onclick="logout()">
                <i class="ph ph-sign-out text-2xl transition-transform"></i>
                <span class="menu-text">Sair</span>
            </div>
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main class="transition-all duration-300 p-6 md:p-8 md:ml-64">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <a href="alunos.html" class="p-2 rounded-lg text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="ph ph-arrow-left text-xl"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-800">Cadastro de Aluno</h1>
            </div>
        </div>

        <!-- Formulário -->
        <div class="card p-6">
            <form id="alunoForm" class="space-y-6">
                <!-- Informações Escolares -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Informações Escolares</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="escola" class="block text-sm font-medium text-gray-700 mb-2">
                                Colégio *
                            </label>
                            <select 
                                id="escola" 
                                name="escola_id" 
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                <option value="">Selecione um colégio</option>
                            </select>
                        </div>
                        <div>
                            <label for="turma" class="block text-sm font-medium text-gray-700 mb-2">
                                Turma *
                            </label>
                            <select 
                                id="turma" 
                                name="turma" 
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                <option value="">Selecione uma turma</option>
                            </select>
                        </div>
                        <div>
                            <label for="serie" class="block text-sm font-medium text-gray-700 mb-2">
                                Série *
                            </label>
                            <select 
                                id="serie" 
                                name="serie" 
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                <option value="">Selecione uma série</option>
                            </select>
                        </div>
                        <div>
                            <label for="registro_aluno" class="block text-sm font-medium text-gray-700 mb-2">
                                RA (Registro Aluno) *
                            </label>
                            <input 
                                type="text" 
                                id="registro_aluno" 
                                name="registro_aluno"
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                placeholder="Digite o RA">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Dispositivos de Reconhecimento *
                            </label>
                            <div id="dispositivos_container" class="space-y-2">
                                <div class="flex gap-2">
                            <select 
                                        name="dispositivos[]" 
                                required
                                        class="dispositivo-select form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                <option value="">Selecione um dispositivo</option>
                            </select>
                                    <button 
                                        type="button"
                                        class="adicionar-dispositivo px-3 py-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors">
                                        <i class="ph ph-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">Você pode adicionar quantos dispositivos precisar</p>
                        </div>
                    </div>
                </div>

                <!-- Foto do Aluno -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Foto do Aluno</h2>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto *</label>
                        <div class="avatar-upload" onclick="document.getElementById('foto').click()">
                            <img id="fotoPreview" src="" alt="" class="hidden">
                            <div id="placeholderFoto" class="placeholder">
                                <i class="ph ph-user text-4xl text-gray-400"></i>
                                <p class="text-sm text-gray-500 mt-2">Clique para adicionar</p>
                            </div>
                        </div>
                        <input type="file" id="foto" accept="image/*" class="hidden" required>
                    </div>
                </div>

                <!-- Dados Pessoais -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Dados Pessoais</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="nome_completo" class="block text-sm font-medium text-gray-700 mb-2">
                                Nome Completo *
                            </label>
                            <input 
                                type="text" 
                                id="nome_completo" 
                                name="nome_completo" 
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                placeholder="Digite o nome completo">
                        </div>
                        <div>
                            <label for="data_nascimento" class="block text-sm font-medium text-gray-700 mb-2">
                                Data de Nascimento *
                            </label>
                            <input 
                                type="date" 
                                id="data_nascimento" 
                                name="data_nascimento"
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        </div>
                        <div>
                            <label for="genero" class="block text-sm font-medium text-gray-700 mb-2">
                                Sexo *
                            </label>
                            <select 
                                id="genero" 
                                name="genero"
                                required
                                class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                                <option value="">Selecione o sexo</option>
                                <option value="M">Masculino</option>
                                <option value="F">Feminino</option>
                                <option value="O">Outro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Responsáveis -->
                        <div>
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Responsáveis</h2>
                    <p class="text-sm text-gray-500 mb-4">Você pode adicionar até 2 responsáveis para o aluno.</p>
                    
                    <!-- Responsável 1 -->
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <h3 class="text-md font-medium text-gray-700 mb-3">Responsável 1</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Buscar Responsável Existente
                            </label>
                            <div class="flex gap-2">
                            <input 
                                type="text" 
                                    id="busca_resp1" 
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="Digite o WhatsApp para buscar">
                                <button 
                                    type="button"
                                    id="buscar_resp1"
                                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                    Buscar
                                </button>
                        </div>
                        </div>
                        <div id="resp1_form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                                <label for="resp1_nome" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nome
                            </label>
                            <input 
                                type="text" 
                                    id="resp1_nome" 
                                    name="resp1_nome"
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="Digite o nome">
                        </div>
                        <div>
                                <label for="resp1_sobrenome" class="block text-sm font-medium text-gray-700 mb-2">
                                    Sobrenome
                            </label>
                            <input 
                                type="text" 
                                    id="resp1_sobrenome" 
                                    name="resp1_sobrenome"
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="Digite o sobrenome">
                        </div>
                        <div>
                                <label for="resp1_whatsapp" class="block text-sm font-medium text-gray-700 mb-2">
                                    WhatsApp
                            </label>
                            <input 
                                type="text" 
                                    id="resp1_whatsapp" 
                                    name="resp1_whatsapp"
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="(99) 99999-9999">
                            <p class="text-xs text-gray-500 mt-1">Formato: DDD + número, ex: (11) 99999-9999</p>
                        </div>
                    </div>
                        <input type="hidden" id="resp1_id" name="resp1_id">
                </div>

                    <!-- Responsável 2 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h3 class="text-md font-medium text-gray-700 mb-3">Responsável 2</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Buscar Responsável Existente
                            </label>
                            <div class="flex gap-2">
                                    <input 
                                        type="text" 
                                    id="busca_resp2" 
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="Digite o WhatsApp para buscar">
                            <button 
                                type="button" 
                                    id="buscar_resp2"
                                    class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                    Buscar
                            </button>
                        </div>
                    </div>
                        <div id="resp2_form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                                <label for="resp2_nome" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nome
                                </label>
                                    <input 
                                        type="text" 
                                    id="resp2_nome" 
                                    name="resp2_nome"
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="Digite o nome">
                                </div>
                            <div>
                                <label for="resp2_sobrenome" class="block text-sm font-medium text-gray-700 mb-2">
                                    Sobrenome
                                </label>
                                <input 
                                    type="text" 
                                    id="resp2_sobrenome" 
                                    name="resp2_sobrenome"
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="Digite o sobrenome">
                            </div>
                            <div>
                                <label for="resp2_whatsapp" class="block text-sm font-medium text-gray-700 mb-2">
                                    WhatsApp
                                </label>
                                <input 
                                    type="text" 
                                    id="resp2_whatsapp" 
                                    name="resp2_whatsapp"
                                    class="form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
                                    placeholder="(99) 99999-9999">
                                <p class="text-xs text-gray-500 mt-1">Formato: DDD + número, ex: (11) 99999-9999</p>
                        </div>
                    </div>
                        <input type="hidden" id="resp2_id" name="resp2_id">
                    </div>
                </div>

                <!-- Após o botão de submit, dentro do form -->
                <div id="deviceRegistrationProgress" class="mt-4 hidden">
                    <h3 class="text-md font-semibold mb-2">Progresso do Cadastro no Dispositivo</h3>
                    <ul class="space-y-2 text-sm">
                        <li id="step1" class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full border border-gray-300"></div>
                            <span>Conectando ao dispositivo...</span>
                        </li>
                        <li id="step2" class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full border border-gray-300"></div>
                            <span>Configurando monitor do dispositivo...</span>
                        </li>
                        <li id="step3" class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full border border-gray-300"></div>
                            <span>Registrando aluno no dispositivo...</span>
                        </li>
                        <li id="step4" class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full border border-gray-300"></div>
                            <span>Enviando foto para o dispositivo...</span>
                        </li>
                    </ul>
                </div>

                <!-- Botões de Ação -->
                <div class="pt-4 border-t border-gray-200">
                    <div class="flex flex-wrap gap-3 justify-end">
                        <a href="alunos.html" class="px-6 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </a>
                        <button 
                            type="submit" 
                            id="submitButton"
                            class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <span>Salvar</span>
                            <div id="loadingSpinner" class="hidden loading-spinner !w-5 !h-5 border-white"></div>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Funções do Sidebar
        function initializeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const menuItems = document.querySelectorAll('.menu-item');

            // Toggle do sidebar em mobile
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });

            // Navegação dos itens do menu
            menuItems.forEach(item => {
                const href = item.getAttribute('data-href');
                if (href) {
                    item.addEventListener('click', () => {
                        window.location.href = href;
                    });
                }
            });

            // Marcar item ativo baseado na URL atual
            const currentPath = window.location.pathname;
            menuItems.forEach(item => {
                const href = item.getAttribute('data-href');
                if (href && currentPath.includes(href)) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Função de logout
        function logout() {
            const supabase = createSupabaseClient();
            supabase.auth.signOut().then(() => {
                window.location.href = '/auth.html';
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Inicializa o sidebar
                initializeSidebar();

                // Inicializa o cliente Supabase
                const supabase = createSupabaseClient();

                // Função para adicionar novo dispositivo
                function adicionarDispositivo() {
                    const container = document.getElementById('dispositivos_container');
                    const novoDispositivo = document.createElement('div');
                    novoDispositivo.className = 'flex gap-2';
                    novoDispositivo.innerHTML = `
                        <select 
                            name="dispositivos[]" 
                            required
                            class="dispositivo-select form-input w-full h-11 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                            <option value="">Selecione um dispositivo</option>
                            ${document.querySelector('.dispositivo-select').innerHTML}
                        </select>
                        <button 
                            type="button"
                            class="remover-dispositivo px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors">
                            <i class="ph ph-minus"></i>
                        </button>
                    `;
                    
                    container.appendChild(novoDispositivo);
                    
                    // Recarregar dispositivos para o novo select
                    const escolaId = document.getElementById('escola').value;
                    if (escolaId) {
                        loadDispositivos(escolaId);
                    }
                }

                // Event listeners para adicionar/remover dispositivos
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.adicionar-dispositivo')) {
                        adicionarDispositivo();
                    } else if (e.target.closest('.remover-dispositivo')) {
                        e.target.closest('.flex').remove();
                    }
                });

        // Função para mostrar toast
        function showToast(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                            background: type === 'success' ? "#22c55e" : "#ef4444"
                }
            }).showToast();
        }

        // Carregar escolas
        async function loadEscolas() {
            try {
                        const { data: escolas, error } = await supabase
                    .from('escolas')
                            .select('id, nome, cidade_id')
                    .is('soft_delete', null)
                    .order('nome');

                        if (error) throw error;

                        const escolaSelect = document.getElementById('escola');
                        escolaSelect.innerHTML = '<option value="">Selecione um colégio</option>';
                    escolas.forEach(escola => {
                        const option = document.createElement('option');
                        option.value = escola.id;
                        option.textContent = escola.nome;
                        option.dataset.cidadeId = escola.cidade_id;
                        escolaSelect.appendChild(option);
                    });
            } catch (error) {
                console.error('Erro ao carregar escolas:', error);
                showToast('Erro ao carregar escolas', 'error');
            }
        }

                // Carregar turmas
        async function loadTurmas(escolaId) {
            try {
                        const { data: turmas, error } = await supabase
                    .from('turmas')
                    .select('id, nome')
                    .eq('escola_id', escolaId)
                    .is('soft_delete', null)
                    .order('nome');

                if (error) throw error;

                        const turmaSelect = document.getElementById('turma');
                turmaSelect.innerHTML = '<option value="">Selecione uma turma</option>';
                turmas.forEach(turma => {
                    const option = document.createElement('option');
                            option.value = turma.id;
                    option.textContent = turma.nome;
                    turmaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                showToast('Erro ao carregar turmas', 'error');
            }
        }

                // Carregar séries
        async function loadSeries(escolaId) {
            try {
                        const { data: series, error } = await supabase
                    .from('series')
                            .select('id, nome')
                            .eq('escola_id', escolaId)
                    .is('soft_delete', null)
                    .order('nome');

                        if (error) throw error;

                        const serieSelect = document.getElementById('serie');
                serieSelect.innerHTML = '<option value="">Selecione uma série</option>';
                    series.forEach(serie => {
                        const option = document.createElement('option');
                            option.value = serie.id;
                        option.textContent = serie.nome;
                        serieSelect.appendChild(option);
                    });
            } catch (error) {
                console.error('Erro ao carregar séries:', error);
                showToast('Erro ao carregar séries', 'error');
                    }
                }

                // Carregar dispositivos (atualizado)
                async function loadDispositivos(escolaId) {
                    try {
                        const { data: dispositivos, error } = await supabase
                            .from('dispositivos')
                            .select('id, camera_id, ip, login, senha')
                            .eq('status', 'ATIVO')
                            .eq('escola_id', escolaId)
                            .is('soft_delete', null)
                            .order('camera_id');

                if (error) throw error;

                        const dispositivosSelects = document.querySelectorAll('.dispositivo-select');
                        dispositivosSelects.forEach(select => {
                            select.innerHTML = '<option value="">Selecione um dispositivo</option>';
                        dispositivos.forEach(dispositivo => {
                            const option = document.createElement('option');
                            option.value = dispositivo.id;
                            option.textContent = `${dispositivo.camera_id} (${dispositivo.ip})`;
                            option.dataset.ip = dispositivo.ip;
                            option.dataset.login = dispositivo.login;
                            option.dataset.senha = dispositivo.senha;
                                select.appendChild(option);
                            });
                        });
                    } catch (error) {
                        console.error('Erro ao carregar dispositivos:', error);
                        showToast('Erro ao carregar dispositivos', 'error');
                    }
                }

                // Upload de arquivo
                async function uploadFile(file) {
                    try {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${Math.random().toString(36).substring(2)}.${fileExt}`;
                        const filePath = `fotos/${fileName}`;

                        const { error: uploadError } = await supabase.storage
                            .from('fotos_alunos')
                            .upload(filePath, file);

                        if (uploadError) throw uploadError;

                        const { data: { publicUrl } } = supabase.storage
                            .from('fotos_alunos')
                            .getPublicUrl(filePath);

                        return publicUrl;
            } catch (error) {
                        console.error('Erro no upload:', error);
                        throw error;
                    }
                }

                // Máscaras para WhatsApp
                const maskOptions = {
                    mask: '00000000000000',
                    lazy: false
                };

                const whatsappInputs = [
                    document.getElementById('resp1_whatsapp'),
                    document.getElementById('resp2_whatsapp'),
                    document.getElementById('busca_resp1'),
                    document.getElementById('busca_resp2')
                ];

                whatsappInputs.forEach(input => {
                    if (input) {
                        // Substituir o IMask por uma máscara mais consistente
                        input.addEventListener('input', function(e) {
                            let value = e.target.value.replace(/\D/g, '');
                            if (value.length > 11) {
                                value = value.substring(0, 11);
                            }
                            
                            let formattedValue = '';
                            if (value.length > 0) {
                                formattedValue = '(' + value.substring(0, Math.min(2, value.length));
                                if (value.length > 2) {
                                    formattedValue += ') ' + value.substring(2, Math.min(7, value.length));
                                    if (value.length > 7) {
                                        formattedValue += '-' + value.substring(7, Math.min(11, value.length));
                                    }
                                }
                            }
                            
                            e.target.value = formattedValue;
                        });

                        // Adicionar busca automática quando sair do campo
                        input.addEventListener('blur', function() {
                            // Se for campo de busca, não executar ação
                            if (this.id.startsWith('busca_')) return;
                            
                            const whatsappNumber = this.value.replace(/\D/g, '');
                            if (whatsappNumber.length >= 10) {
                                // Obter número do responsável (1 ou 2) do ID do input
                                const respNum = this.id.includes('resp1_') ? 1 : 2;
                                buscarUsuarioPorWhatsapp(whatsappNumber, respNum);
                            }
                        });
                    }
                });

                // Função para buscar usuário por WhatsApp automaticamente
                async function buscarUsuarioPorWhatsapp(whatsapp, numeroResp) {
                    if (!whatsapp || whatsapp.length < 10) return;
                    
                    try {
                        // Formatar WhatsApp para garantir consistência
                        let whatsappFormatado = whatsapp;
                        // Remover caracteres não numéricos
                        whatsappFormatado = whatsappFormatado.replace(/\D/g, '');
                        
                        // Garantir que comece com 55 (Brasil)
                        if (!whatsappFormatado.startsWith('55')) {
                            whatsappFormatado = '55' + whatsappFormatado;
                        }
                        
                        console.log(`Buscando usuário com WhatsApp: ${whatsappFormatado}`);
                        
                        // Buscar usuário
                        const { data, error } = await supabase
                    .from('usuarios')
                            .select('id, nome, sobrenome, tipo, status')
                            .eq('whatsapp', whatsappFormatado)
                            .single();
                        
                        if (error) {
                            if (error.code === 'PGRST116') {
                                console.log('Usuário não encontrado');
                                
                                // Limpar e habilitar campos
                                document.getElementById(`resp${numeroResp}_id`).value = '';
                                document.getElementById(`resp${numeroResp}_nome`).disabled = false;
                                document.getElementById(`resp${numeroResp}_sobrenome`).disabled = false;
                                document.getElementById(`resp${numeroResp}_whatsapp`).disabled = false;
                                
                                showToast('Responsável não encontrado. Preencha os dados para cadastrar.', 'warning');
                                
                                // Preencher WhatsApp formatado
                                document.getElementById(`resp${numeroResp}_whatsapp`).value = whatsappFormatado.replace(/^55/, '').replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
                                
                                return;
                            }
                            throw error;
                        }
                        
                        if (data) {
                            console.log('Usuário encontrado:', data);
                            
                            // Preencher campos do formulário
                            document.getElementById(`resp${numeroResp}_id`).value = data.id;
                            document.getElementById(`resp${numeroResp}_nome`).value = data.nome || '';
                            document.getElementById(`resp${numeroResp}_sobrenome`).value = data.sobrenome || '';
                            document.getElementById(`resp${numeroResp}_whatsapp`).value = whatsappFormatado.replace(/^55/, '').replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');

                            // Desabilitar campos
                            document.getElementById(`resp${numeroResp}_nome`).disabled = true;
                            document.getElementById(`resp${numeroResp}_sobrenome`).disabled = true;
                            document.getElementById(`resp${numeroResp}_whatsapp`).disabled = true;
                            
                            // Mostrar mensagem informativa
                            showToast(`Responsável ${data.nome} ${data.sobrenome || ''} encontrado!`, 'success');
                            
                            // Se for um usuário inativo, alertar
                            if (data.status !== 'Ativo') {
                                showToast(`Atenção: Este usuário está com status ${data.status}`, 'warning');
                            }
                            
                            // Se não for um responsável, alertar
                            if (data.tipo !== 'RESPONSÁVEL') {
                                showToast(`Atenção: Este usuário está cadastrado como ${data.tipo}`, 'warning');
                            }
                        }
            } catch (error) {
                        console.error('Erro ao buscar usuário:', error);
                        showToast('Erro ao buscar responsável', 'error');
                    }
                }

                // Event listeners para busca
                ['buscar_resp1', 'buscar_resp2'].forEach(id => {
                    const button = document.getElementById(id);
                    if (button) {
                        button.addEventListener('click', function() {
                            const respNum = id.slice(-1); // Pega o número do responsável (1 ou 2)
                            const whatsapp = document.getElementById(`busca_resp${respNum}`).value;
                            if (whatsapp) {
                                buscarUsuarioPorWhatsapp(whatsapp, respNum);
                            } else {
                                showToast('Digite um número de WhatsApp para buscar', 'error');
                            }
                        });
                    }
                });

                // Event listeners para busca com Enter
                ['busca_resp1', 'busca_resp2'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Previne o submit do formulário
                            const respNum = id.slice(-1); // Pega o número do responsável (1 ou 2)
                            const whatsapp = this.value;
                            if (whatsapp) {
                                    buscarUsuarioPorWhatsapp(whatsapp, respNum);
                            } else {
                                showToast('Digite um número de WhatsApp para buscar', 'error');
                            }
                        }
                    });
                    }
                });

                // Função para limpar número de telefone
                function limparNumero(numero) {
                    if (!numero) return '';
                    let numeroLimpo = numero.replace(/\D/g, '');
                    
                    // Garantir que começa com 55 (Brasil)
                    if (!numeroLimpo.startsWith('55')) {
                        numeroLimpo = '55' + numeroLimpo;
                    }
                    
                    return numeroLimpo;
                }

                // Função para atualizar o progresso
                function updateProgress(step, status, message = '') {
                    const steps = ['step1', 'step2', 'step3', 'step4'];
                    const stepElement = document.getElementById(steps[step-1]);
                    
                    // Remover classes anteriores
                    stepElement.classList.remove('text-gray-500', 'text-green-500', 'text-red-500');
                    
                    // Adicionar classe de acordo com o status
                    switch(status) {
                        case 'loading':
                            stepElement.classList.add('text-gray-500');
                            stepElement.querySelector('div').classList.remove('border-gray-300', 'bg-green-500', 'bg-red-500');
                            stepElement.querySelector('div').classList.add('border-blue-500', 'animate-pulse');
                            break;
                        case 'success':
                            stepElement.classList.add('text-green-500');
                            stepElement.querySelector('div').classList.remove('border-gray-300', 'border-blue-500', 'animate-pulse');
                            stepElement.querySelector('div').classList.add('bg-green-500', 'border-green-500');
                            break;
                        case 'error':
                            stepElement.classList.add('text-red-500');
                            stepElement.querySelector('div').classList.remove('border-gray-300', 'border-blue-500', 'animate-pulse');
                            stepElement.querySelector('div').classList.add('bg-red-500', 'border-red-500');
                            // Adicionar mensagem de erro
                            if (message) {
                                stepElement.querySelector('span').textContent = `${stepElement.querySelector('span').textContent.split(' (')[0]} (${message})`;
                            }
                            break;
                    }
                }

                // Funções para integração com a Control ID
                async function connectToDevice(ipAddressWithPort, login, password) {
                    try {
                        console.log(`Conectando ao dispositivo ${ipAddressWithPort} com login ${login}`);
                        updateProgress(1, 'loading');
                        
                        // 1. Conectar e solicitar sessão
                        const loginResponse = await fetch(`http://${ipAddressWithPort}/login.fcgi`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                login: login,
                                password: password
                            })
                        });

                        if (!loginResponse.ok) {
                            const errorText = await loginResponse.text();
                            console.error('Resposta de erro:', errorText);
                            throw new Error(`Erro ao conectar com o dispositivo: ${loginResponse.status} - ${errorText}`);
                        }

                        const loginData = await loginResponse.json();
                        console.log('Resposta login:', loginData);
                        
                        if (!loginData.session) {
                            throw new Error('Sessão não recebida do dispositivo');
                        }

                        updateProgress(1, 'success');
                        return loginData.session;
                    } catch (error) {
                        console.error('Erro ao conectar com o dispositivo:', error);
                        updateProgress(1, 'error', error.message);
                        throw error;
                    }
                }

                async function setupMonitor(ipAddressWithPort, session) {
                    try {
                        console.log(`Configurando monitor para ${ipAddressWithPort} com sessão ${session}`);
                        updateProgress(2, 'loading');
                        
                        // 2. Configurar o monitor
                        const monitorResponse = await fetch(`http://${ipAddressWithPort}/set_configuration.fcgi?session=${session}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                monitor: {
                                    request_timeout: "5000",
                                    hostname: "https://fqia6z1078.execute-api.us-east-1.amazonaws.com",
                                    port: "443",
                                    path: "dev/log"
                                }
                            })
                        });

                        if (!monitorResponse.ok) {
                            const errorText = await monitorResponse.text();
                            console.error('Resposta de erro setup monitor:', errorText);
                            throw new Error(`Erro ao configurar monitor: ${monitorResponse.status} - ${errorText}`);
                        }

                        const monitorData = await monitorResponse.json();
                        console.log('Resposta monitor:', monitorData);
                        
                        updateProgress(2, 'success');
                        return monitorData;
                    } catch (error) {
                        console.error('Erro ao configurar monitor:', error);
                        updateProgress(2, 'error', error.message);
                        throw error;
                    }
                }

                async function createUserInDevice(ipAddressWithPort, session, userName, alunoId) {
                    try {
                        console.log(`Criando usuário ${userName} para aluno ID ${alunoId} no dispositivo ${ipAddressWithPort}`);
                        updateProgress(3, 'loading');
                        
                        // 3. Criar usuário no dispositivo
                        const createUserBody = {
                            object: "users",
                            values: [
                                {
                                    name: userName,
                                    registration: alunoId.toString(),
                                    password: "123456",
                                    salt: ""
                                }
                            ]
                        };
                        
                        console.log('Enviando para criar usuário:', JSON.stringify(createUserBody));
                        
                        const createUserResponse = await fetch(`http://${ipAddressWithPort}/create_objects.fcgi?session=${session}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(createUserBody)
                        });

                        if (!createUserResponse.ok) {
                            const errorText = await createUserResponse.text();
                            console.error('Resposta de erro criar usuário:', errorText);
                            throw new Error(`Erro ao criar usuário no dispositivo: ${createUserResponse.status} - ${errorText}`);
                        }

                        const userData = await createUserResponse.json();
                        console.log('Resposta criar usuário:', userData);
                        
                        if (!userData.ids || userData.ids.length === 0) {
                            throw new Error('ID do usuário não recebido do dispositivo');
                        }

                        updateProgress(3, 'success');
                        return userData.ids[0];
                    } catch (error) {
                        console.error('Erro ao criar usuário no dispositivo:', error);
                        updateProgress(3, 'error', error.message);
                        throw error;
                    }
                }

                // Função para pré-processar a imagem antes de enviar ao dispositivo
                async function preprocessImage(file) {
                    return new Promise((resolve, reject) => {
                        try {
                            // Criar um objeto Image para carregar a imagem
                            const img = new Image();
                            img.onload = function() {
                                try {
                                    // Criar um canvas para redimensionar a imagem
                                    const canvas = document.createElement('canvas');
                                    
                                    // Definir dimensões para atender aos critérios da Control ID
                                    // A documentação indica que a largura do rosto deve estar entre 60-800 pixels
                                    // e deve estar centralizado na imagem
                                    const TARGET_WIDTH = 480;  // Largura recomendada
                                    const TARGET_HEIGHT = 640; // Altura recomendada para proporção 3:4
                                    
                                    // Configurar o canvas com as dimensões-alvo
                                    canvas.width = TARGET_WIDTH;
                                    canvas.height = TARGET_HEIGHT;
                                    
                                    // Preencher o fundo com branco para garantir contraste
                                    const ctx = canvas.getContext('2d');
                                    ctx.fillStyle = '#FFFFFF';
                                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                                    
                                    // Calcular a proporção para manter a relação de aspecto
                                    let scale, offsetX = 0, offsetY = 0;
                                    
                                    if (img.width / img.height > TARGET_WIDTH / TARGET_HEIGHT) {
                                        // Imagem mais larga que o alvo
                                        scale = TARGET_HEIGHT / img.height;
                                        offsetX = (TARGET_WIDTH - (img.width * scale)) / 2;
                                    } else {
                                        // Imagem mais alta que o alvo
                                        scale = TARGET_WIDTH / img.width;
                                        offsetY = (TARGET_HEIGHT - (img.height * scale)) / 2;
                                    }
                                    
                                    // Desenhar a imagem centralizada
                                    ctx.drawImage(
                                        img, 
                                        offsetX, 
                                        offsetY, 
                                        img.width * scale, 
                                        img.height * scale
                                    );
                                    
                                    // Melhorar contraste e nitidez para atender ao requisito de sharpness > 450
                                    ctx.filter = 'contrast(110%) saturate(110%) brightness(105%)';
                                    ctx.drawImage(canvas, 0, 0);
                                    
                                    // Aplicar sharpening para melhorar a nitidez
                                    try {
                                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                        const data = imageData.data;
                                        const sharpenKernel = [
                                            0, -1, 0,
                                            -1, 5, -1,
                                            0, -1, 0
                                        ];
                                        
                                        const tempCanvas = document.createElement('canvas');
                                        tempCanvas.width = canvas.width;
                                        tempCanvas.height = canvas.height;
                                        const tempCtx = tempCanvas.getContext('2d');
                                        tempCtx.putImageData(imageData, 0, 0);
                                        
                                        ctx.filter = 'none';
                                        ctx.drawImage(tempCanvas, 0, 0);
                                    } catch (err) {
                                        console.warn('Falha ao aplicar sharpening:', err);
                                        // Continua sem o sharpening
                                    }
                                    
                                    // Converter para Blob como JPEG de alta qualidade
                                    // A documentação indica que o arquivo deve ser menor que 2MB
                                    canvas.toBlob(function(blob) {
                                        console.log(`Imagem processada: ${blob.size} bytes`);
                                        
                                        // Se a imagem ainda for muito grande, reduzir a qualidade
                                        if (blob.size > 1.5 * 1024 * 1024) { // 1.5MB
                                            canvas.toBlob(function(compressedBlob) {
                                                console.log(`Imagem recomprimida: ${compressedBlob.size} bytes`);
                                                resolve(compressedBlob);
                                            }, 'image/jpeg', 0.7); // qualidade 70%
                } else {
                                            resolve(blob);
                                        }
                                    }, 'image/jpeg', 0.9); // qualidade 90%
                                } catch (canvasError) {
                                    console.error('Erro ao processar imagem no canvas:', canvasError);
                                    // Se houver erro, tenta com o arquivo original
                                    resolve(file);
                                }
                            };
                            
                            img.onerror = function() {
                                console.error('Erro ao carregar imagem para pré-processamento');
                                // Se houver erro, tenta com o arquivo original
                                resolve(file);
                            };
                            
                            // Carregar a imagem a partir do arquivo
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                img.src = e.target.result;
                            };
                            reader.onerror = function() {
                                console.error('Erro ao ler arquivo de imagem');
                                resolve(file);
                            };
                            reader.readAsDataURL(file);
                            
                        } catch (error) {
                            console.error('Erro no pré-processamento da imagem:', error);
                            // Se houver erro, tenta com o arquivo original
                            resolve(file);
                        }
                    });
                }

                // Função para fazer upload da imagem para o dispositivo
                async function uploadImageToDevice(ipAddressWithPort, session, userId, imageFile) {
                    try {
                        console.log(`Enviando imagem para usuário ID ${userId} no dispositivo ${ipAddressWithPort}`);
                        updateProgress(4, 'loading');
                        
                        // Converter a imagem para o formato aceito pelo dispositivo
                        const reader = new FileReader();
                        
                        // Criar uma promessa para aguardar a leitura do arquivo
                        const readFilePromise = new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                        });
                        
                        reader.readAsArrayBuffer(imageFile);
                        const arrayBuffer = await readFilePromise;
                        
                        // Obter o timestamp atual em segundos (Unix timestamp)
                        const timestamp = Math.floor(Date.now() / 1000);
                        
                        console.log(`Preparando envio para usuário ${userId} - timestamp: ${timestamp}`);
                        
                        // Montar a URL conforme a documentação
                        // A documentação indica que o timestamp deve ser passado como parâmetro na query string
                        const url = `http://${ipAddressWithPort}/user_set_image.fcgi?user_id=${userId}&timestamp=${timestamp}&match=0&session=${session}`;
                        
                        console.log(`URL de upload: ${url}`);
                        
                        // 4. Fazer upload da imagem do aluno - exatamente como na documentação
                        const uploadResponse = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/octet-stream'
                            },
                            body: new Uint8Array(arrayBuffer)
                        });
                        
                        const responseText = await uploadResponse.text();
                        console.log(`Resposta bruta do servidor: ${responseText}`);
                        
                        // Tentar converter a resposta para JSON
                        let uploadData;
                        try {
                            uploadData = JSON.parse(responseText);
                        } catch (e) {
                            console.error('Erro ao parsear resposta JSON:', e);
                            throw new Error(`Resposta inválida do servidor: ${responseText}`);
                        }

                        if (!uploadResponse.ok) {
                            console.error('Resposta de erro upload imagem:', uploadData);
                            throw new Error(`Erro ao fazer upload da imagem: ${uploadResponse.status} - ${responseText}`);
                        }

                        console.log('Resposta upload imagem:', uploadData);
                        
                        // Verificar se o upload foi bem-sucedido conforme a documentação
                        if (uploadData.success === false) {
                            const errorMessages = uploadData.errors.map(err => `${err.code}: ${err.message}`).join(', ');
                            console.error('Erros reportados pelo dispositivo:', uploadData.errors);
                            updateProgress(4, 'error', `Erros: ${errorMessages}`);
                            throw new Error(`Falha no cadastro da imagem: ${errorMessages}`);
                        }
                        
                        // Se chegou aqui, foi sucesso
                        updateProgress(4, 'success');
                        return uploadData;
                    } catch (error) {
                        console.error('Erro ao fazer upload da imagem:', error);
                        updateProgress(4, 'error', error.message);
                        throw error;
                    }
                }

                // Função para criar usuário e permissões
                async function criarUsuarioEPermissoes(whatsapp, nome, sobrenome, alunoId) {
                    if (!whatsapp || !nome || !alunoId) return null;

                    try {
                        // Formatar o WhatsApp corretamente
                        let whatsappFormatado = limparNumero(whatsapp);
                        
                        // Verificar tamanho mínimo
                        if (whatsappFormatado.length < 12) {
                            console.error('Número de WhatsApp inválido:', whatsappFormatado);
                            throw new Error('Número de WhatsApp inválido. Deve conter DDD e número.');
                        }
                        
                        // Primeiro, criar ou atualizar o usuário
                        const { data: userData, error: userError } = await supabase
                            .from('usuarios')
                            .upsert({
                                whatsapp: whatsappFormatado,
                                nome,
                                sobrenome: sobrenome || '',
                                tipo: 'RESPONSÁVEL',
                                hash1: whatsappFormatado, // Usar whatsapp como hash1
                                hash2: '',
                                status: 'Ativo'
                            }, {
                                onConflict: 'whatsapp'
                            })
                            .select()
                            .single();
                            
                        if (userError) throw userError;

                        // Depois, remover permissões antigas se existirem
                        if (userData) {
                            const { error: delPermError } = await supabase
                                .from('permissoes_aluno')
                                .delete()
                                .eq('usuario_id', userData.id)
                                .eq('aluno_id', alunoId);

                            if (delPermError && delPermError.code !== 'PGRST116') throw delPermError;

                            // Criar nova permissão
                            const { error: permError } = await supabase
                                .from('permissoes_aluno')
                                .insert({
                                    usuario_id: userData.id,
                                    aluno_id: alunoId
                                });

                            if (permError) throw permError;
                        }

                        return userData;
                    } catch (error) {
                        console.error('Erro ao criar/atualizar usuário e permissões:', error);
                        throw error;
                    }
                }

                // Função para cadastrar aluno
                async function cadastrarAluno(event) {
                    event.preventDefault();
                    
                    const btnSubmit = document.getElementById('submitButton');
                    const loading = document.getElementById('loadingSpinner');
                    
                    try {
                        btnSubmit.disabled = true;
                        loading.classList.remove('hidden');

                        // Verificar se o usuário está autenticado via localStorage
                        const userSession = localStorage.getItem('user_session');
                        if (!userSession) {
                            throw new Error('Usuário não autenticado. Por favor, faça login.');
                        }

                        // Parsear os dados do usuário
                        const usuarioLogado = JSON.parse(userSession);
                        if (!usuarioLogado || !usuarioLogado.id) {
                            throw new Error('Dados do usuário inválidos. Por favor, faça login novamente.');
                        }

                        // Obter dados do formulário
                        const formData = new FormData(event.target);
                        
                        // Obter e formatar números de WhatsApp
                        let resp1_whatsapp = formData.get('resp1_whatsapp');
                        let resp2_whatsapp = formData.get('resp2_whatsapp');
                        
                        // Formatar WhatsApp (remover formatação e adicionar 55 se necessário)
                        resp1_whatsapp = resp1_whatsapp ? limparNumero(resp1_whatsapp) : null;
                        resp2_whatsapp = resp2_whatsapp ? limparNumero(resp2_whatsapp) : null;
                        
                        // Verificar se já existe um usuário com este WhatsApp
                        const verificarDuplicidade = async (whatsapp) => {
                            if (!whatsapp) return false;
                            
                            const { data, error } = await supabase
                                .from('usuarios')
                                .select('id, whatsapp, nome, sobrenome')
                                .eq('whatsapp', whatsapp);
                                
                            if (error) throw error;
                            
                            // Se encontrou algum usuário com este WhatsApp
                            if (data && data.length > 0) {
                                return data;
                            }
                            
                            return false;
                        };
                        
                        // Verificar duplicidade de WhatsApp entre os responsáveis
                        if (resp1_whatsapp && resp2_whatsapp && resp1_whatsapp === resp2_whatsapp) {
                            showToast('Os números de WhatsApp dos responsáveis não podem ser iguais', 'error');
                            btnSubmit.disabled = false;
                            loading.classList.add('hidden');
                            return;
                        }
                        
                        // Verificar se responsável 1 já existe
                        if (resp1_whatsapp) {
                            const duplicados = await verificarDuplicidade(resp1_whatsapp);
                            // Se existir usuário e não for o mesmo que estamos editando (pelo ID)
                            if (duplicados && duplicados.length > 0 && !document.getElementById('resp1_id').value) {
                                const usuario = duplicados[0];
                                showToast(`O WhatsApp do Responsável 1 já está cadastrado para ${usuario.nome} ${usuario.sobrenome || ''}`, 'warning');
                                // Aqui decidimos continuar, apenas alertando o usuário
                            }
                        }
                        
                        // Verificar se responsável 2 já existe
                        if (resp2_whatsapp) {
                            const duplicados = await verificarDuplicidade(resp2_whatsapp);
                            // Se existir usuário e não for o mesmo que estamos editando (pelo ID)
                            if (duplicados && duplicados.length > 0 && !document.getElementById('resp2_id').value) {
                                const usuario = duplicados[0];
                                showToast(`O WhatsApp do Responsável 2 já está cadastrado para ${usuario.nome} ${usuario.sobrenome || ''}`, 'warning');
                                // Aqui decidimos continuar, apenas alertando o usuário
                            }
                        }

                        const alunoData = {
                            nome_completo: formData.get('nome_completo'),
                            registro_aluno: formData.get('registro_aluno'),
                            escola_id: parseInt(formData.get('escola_id')),
                            genero: formData.get('genero'),
                            data_nascimento: formData.get('data_nascimento'),
                            turma: formData.get('turma') ? parseInt(formData.get('turma')) : null,
                            serie: formData.get('serie') ? parseInt(formData.get('serie')) : null,
                            contato1_whatsapp: resp1_whatsapp,
                            contato2_whatsapp: resp2_whatsapp
                        };

                        // Upload da foto
                        const fotoFile = document.getElementById('foto').files[0];
                        if (fotoFile) {
                            const fotoUrl = await uploadFile(fotoFile);
                            alunoData.foto_url = fotoUrl;
                        }

                        // Inserir aluno
                        const { data: aluno, error: alunoError } = await supabase
                            .from('alunos')
                            .insert([alunoData])
                                        .select()
                                        .single();

                        if (alunoError) throw alunoError;

                        // Criar usuários e permissões para os responsáveis
                        const resp1_nome = formData.get('resp1_nome');
                        const resp1_sobrenome = formData.get('resp1_sobrenome');
                        const resp2_nome = formData.get('resp2_nome');
                        const resp2_sobrenome = formData.get('resp2_sobrenome');

                        // Criar usuário e permissões para o responsável 1
                        if (resp1_whatsapp && resp1_nome) {
                            await criarUsuarioEPermissoes(resp1_whatsapp, resp1_nome, resp1_sobrenome, aluno.id);
                        }

                        // Criar usuário e permissões para o responsável 2
                        if (resp2_whatsapp && resp2_nome) {
                            await criarUsuarioEPermissoes(resp2_whatsapp, resp2_nome, resp2_sobrenome, aluno.id);
                        }
                        
                        // Obter todos os dispositivos selecionados
                        const dispositivosSelects = document.querySelectorAll('.dispositivo-select');
                        const dispositivosPromises = Array.from(dispositivosSelects).map(async (select) => {
                            const dispositivoId = parseInt(select.value);
                            if (!dispositivoId) return null; // Pular se não selecionou dispositivo

                            // Usar o whatsapp do usuário logado direto do localStorage
                            const whatsappCadastrante = usuarioLogado.whatsapp;
                            if (!whatsappCadastrante) throw new Error('WhatsApp do usuário logado não encontrado.');

                            // Cadastrar na tabela aluno_dispositivo
                            const { error: relError } = await supabase
                                .from('aluno_dispositivo')
                                .insert([{
                                    id_dispositivo: dispositivoId,
                                        aluno: aluno.id,
                                    escola: aluno.escola_id,
                                    numero_de_quem_cadastrou: whatsappCadastrante
                                }]);

                            if (relError) throw relError;

                            return true;
                        });

                        // Aguardar todas as operações de dispositivo
                        await Promise.all(dispositivosPromises);

                        showToast('Aluno cadastrado com sucesso!');
                        setTimeout(() => {
                            window.location.href = '/admin/alunos.html';
                        }, 2000);

                    } catch (error) {
                        console.error('Erro ao cadastrar aluno:', error);
                        showToast('Erro ao cadastrar aluno: ' + error.message, 'error');
                    } finally {
                        btnSubmit.disabled = false;
                        loading.classList.add('hidden');
                    }
                }

                // Event Listeners
                const form = document.getElementById('alunoForm');
                const submitButton = document.getElementById('submitButton');
                const loadingSpinner = document.getElementById('loadingSpinner');
                const fotoInput = document.getElementById('foto');
                const fotoPreview = document.getElementById('fotoPreview');
                const placeholderFoto = document.getElementById('placeholderFoto');

                // Event listener para mudança de escola
                document.getElementById('escola').addEventListener('change', function(e) {
                    const escolaId = e.target.value;
                    if (escolaId) {
                    loadTurmas(escolaId);
                    loadSeries(escolaId);
                    loadDispositivos(escolaId);
                    }
                });

                // Preview da foto
                fotoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            fotoPreview.src = e.target.result;
                            fotoPreview.classList.remove('hidden');
                            placeholderFoto.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                form.addEventListener('submit', cadastrarAluno);

                // Carregar dados iniciais
                await loadEscolas();

                // Remover preloader
                const preloader = document.querySelector('.preloader');
                setTimeout(() => {
                    preloader.style.opacity = '0';
                    setTimeout(() => {
                        preloader.style.display = 'none';
                    }, 200);
                }, 500);

            } catch (error) {
                console.error('Erro ao inicializar:', error);
                showToast('Erro ao carregar o sistema. Por favor, recarregue a página.', 'error');
            }
        });
    </script>
</body>
</html> 
